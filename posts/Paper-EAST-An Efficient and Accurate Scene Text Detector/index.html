<!DOCTYPE html>
<html lang=zh-CN data-theme="light">
	
<script src="/js/plugins/toggleTheme.js"></script>

	<script>
		setTheme();
	</script>
	<head>
		
<title>Paper-EAST-An Efficient and Accurate Scene Text Detector | Zi-Zi's Journey</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/images/icon/favicon.ico">
<link href="/css/plugins/print.css" media="print" rel="stylesheet" />

<link rel="stylesheet" href="/css/index.css">



<meta name="keywords" content="Python,论文,实验相关,Pytorch,MindSpore,文本检测,代码复现,">
<meta name="description" content="论文阅读。">



<script src="/js/plugins/jquery.min.js"></script>


<script src="/js/plugins/hljs.min.js"></script>


<script src="/js/plugins/init.js"></script>


<script src="/js/plugins/hide.js"></script>


<script src="/js/plugins/tabs.js"></script>



    



    
<script src="/js/plugins/alert-title.js"></script>

    
<link rel="stylesheet" href="/css/plugins/github-alerts/github-base.css">

    
<link rel="stylesheet" href="/css/plugins/github-alerts/github-colors-dark-class.css">

    
<link rel="stylesheet" href="/css/plugins/github-alerts/github-colors-light.css">






    

	<meta name="generator" content="Hexo 6.1.0"></head>

	<body>
		<header class="sticky-header">
	<nav>
		<div class="nav-left">
			<a href="/" class="logo">
				<img no-lazy src="/images/headers_icon/logo.webp" alt="Quieter">
			</a>
			<ul class="breadcrumb" id="breadcrumb"></ul>
		</div>
		<div class="nav-right">
			<ul>
				
					<li>
						<a href="/">
						  主页
						</a>
					</li>
				
					<li>
						<a href="/categories">
						  类别
						</a>
					</li>
				
					<li>
						<a href="/tags">
						  标签
						</a>
					</li>
				
					<li>
						<a href="/archives">
						  归档
						</a>
					</li>
				
					<li>
						<a href="/galleries">
						  相册
						</a>
					</li>
				
					<li>
						<a href="/links">
						  链接
						</a>
					</li>
				
					<li>
						<a href="/about">
						  关于
						</a>
					</li>
								  
			</ul>
		</div>
		<div class="nav-right-close">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
				<path fill="none" d="M0 0h24v24H0z" />
				<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
			</svg>
		</div>

		<div class="sidebar">
    <div class="topo">
        <p>Zi-Zi's Journey</p>
    </div>
    <ul>
        
        <li>
            <a href="/">
                主页
            </a>
        </li>
        
        <li>
            <a href="/categories">
                类别
            </a>
        </li>
        
        <li>
            <a href="/tags">
                标签
            </a>
        </li>
        
        <li>
            <a href="/archives">
                归档
            </a>
        </li>
        
        <li>
            <a href="/galleries">
                相册
            </a>
        </li>
        
        <li>
            <a href="/links">
                链接
            </a>
        </li>
        
        <li>
            <a href="/about">
                关于
            </a>
        </li>
        
    </ul>
    <div class="sidebar-footer">
        
        <a target="_blank" rel="noopener" href="https://weibo.com/u/5020307235">
            <img no-lazy src="/images/bottom_icon/Weibo.webp" alt="Quieter">
        </a>
        
        <a target="_blank" rel="noopener" href="https://tieba.baidu.com/home/main?id=tb.1.ff6d2775.vFH7wrdW2ZjPCmyBHJcjnA">
            <img no-lazy src="/images/bottom_icon/Tieba.webp" alt="Quieter">
        </a>
        
        <a target="_blank" rel="noopener" href="https://space.bilibili.com/11547880">
            <img no-lazy src="/images/bottom_icon/Bilibili.webp" alt="Quieter">
        </a>
        
        <a target="_blank" rel="noopener" href="https://github.com/GZ-Metal-Cell">
            <img no-lazy src="/images/bottom_icon/github.webp" alt="Quieter">
        </a>
        
    </div>
</div>
<div class='shelter'>
    <script>
        $(function() {
            $('.nav-right-close > svg').click(function() {
                $('.sidebar').animate({
                    right: "0"
                }, 500);
                $('.shelter').fadeIn("slow");
            
                var element = $('.topo');
                element.addClass('custom-style');
            
                var links = null;
                if ("") {
                    links = "".split(',');
                } else {
                    links = "/images/random_top_img/01.webp,/images/random_top_img/02.webp,/images/random_top_img/03.webp,/images/random_top_img/04.webp,/images/random_top_img/05.webp,/images/random_top_img/06.webp,/images/random_top_img/07.webp,/images/random_top_img/08.webp,/images/random_top_img/09.webp,/images/random_top_img/10.webp,/images/random_top_img/11.webp,/images/random_top_img/12.webp,/images/random_top_img/13.webp,/images/random_top_img/14.webp,/images/random_top_img/15.webp,/images/random_top_img/16.webp,/images/random_top_img/17.webp,/images/random_top_img/18.webp,/images/random_top_img/19.webp,/images/random_top_img/20.webp,/images/random_top_img/21.webp,/images/random_top_img/22.webp,/images/random_top_img/23.webp,/images/random_top_img/24.webp,/images/random_top_img/25.webp,/images/random_top_img/26.webp,/images/random_top_img/27.webp,/images/random_top_img/28.webp,/images/random_top_img/29.webp,/images/random_top_img/30.webp,/images/random_top_img/31.webp,/images/random_top_img/32.webp,/images/random_top_img/33.webp,/images/random_top_img/34.webp,/images/random_top_img/35.webp,/images/random_top_img/36.webp,/images/random_top_img/37.webp,/images/random_top_img/38.webp,/images/random_top_img/39.webp,/images/random_top_img/40.webp,/images/random_top_img/41.webp,/images/random_top_img/42.webp,/images/random_top_img/43.webp,/images/random_top_img/44.webp,/images/random_top_img/45.webp,/images/random_top_img/46.webp,/images/random_top_img/47.webp,/images/random_top_img/48.webp,/images/random_top_img/49.webp,/images/random_top_img/50.webp,/images/random_top_img/51.webp,/images/random_top_img/52.webp,/images/random_top_img/53.webp,/images/random_top_img/54.webp,/images/random_top_img/55.webp,/images/random_top_img/56.webp,/images/random_top_img/57.webp".split(',');
                }
            
                var randomLink = links[Math.floor(Math.random() * links.length)];
                element.css('background-image', "url('" + randomLink + "')");
            });
          
            $('.shelter').click(function(e) {
                $('.sidebar').animate({
                    right: "-100%"
                }, 500);
                $('.shelter').fadeOut("slow");
            });
        });      
    </script>
</div>
	</nav>

	
		<div class="header-background"></div>
	

	<script>
		const name = 'post';
		const ul = document.querySelectorAll('.nav-right ul')[0];
		const lis = ul.querySelectorAll('li');

		if (name == 'home') {
			lis[0].classList.add('select');
		} else {
			for (let i = 0; i < lis.length; i++) {
				const li = lis[i];
				const a = li.querySelector('a');
				if (name === a.href.split('/')[3]) {
					li.classList.add('select');
				}
			}
		}
	</script>
	
	<script>
		var element = document.querySelector('.header-background');
		if(element) {
			element.classList.add('custom-style');
			var links = null;
			if("")
			{
				links = "".split(',');
			} else
			{
				links = "/images/random_top_img/01.webp,/images/random_top_img/02.webp,/images/random_top_img/03.webp,/images/random_top_img/04.webp,/images/random_top_img/05.webp,/images/random_top_img/06.webp,/images/random_top_img/07.webp,/images/random_top_img/08.webp,/images/random_top_img/09.webp,/images/random_top_img/10.webp,/images/random_top_img/11.webp,/images/random_top_img/12.webp,/images/random_top_img/13.webp,/images/random_top_img/14.webp,/images/random_top_img/15.webp,/images/random_top_img/16.webp,/images/random_top_img/17.webp,/images/random_top_img/18.webp,/images/random_top_img/19.webp,/images/random_top_img/20.webp,/images/random_top_img/21.webp,/images/random_top_img/22.webp,/images/random_top_img/23.webp,/images/random_top_img/24.webp,/images/random_top_img/25.webp,/images/random_top_img/26.webp,/images/random_top_img/27.webp,/images/random_top_img/28.webp,/images/random_top_img/29.webp,/images/random_top_img/30.webp,/images/random_top_img/31.webp,/images/random_top_img/32.webp,/images/random_top_img/33.webp,/images/random_top_img/34.webp,/images/random_top_img/35.webp,/images/random_top_img/36.webp,/images/random_top_img/37.webp,/images/random_top_img/38.webp,/images/random_top_img/39.webp,/images/random_top_img/40.webp,/images/random_top_img/41.webp,/images/random_top_img/42.webp,/images/random_top_img/43.webp,/images/random_top_img/44.webp,/images/random_top_img/45.webp,/images/random_top_img/46.webp,/images/random_top_img/47.webp,/images/random_top_img/48.webp,/images/random_top_img/49.webp,/images/random_top_img/50.webp,/images/random_top_img/51.webp,/images/random_top_img/52.webp,/images/random_top_img/53.webp,/images/random_top_img/54.webp,/images/random_top_img/55.webp,/images/random_top_img/56.webp,/images/random_top_img/57.webp".split(',');
			}
			var randomLink = links[Math.floor(Math.random() * links.length)];
			element.style.backgroundImage = "url('" + randomLink + "')";
		}
	</script>

	
<script src="/js/plugins/breadcrumb.js"></script>

	<script>
		var menus_title = [];
		
			menus_title.push({home: '主页'});
		
			menus_title.push({categories: '类别'});
		
			menus_title.push({tags: '标签'});
		
			menus_title.push({archives: '归档'});
		
			menus_title.push({galleries: '相册'});
		
			menus_title.push({links: '链接'});
		
			menus_title.push({about: '关于'});
		
		
			
				postsBreadcrumb(
					document.getElementById('breadcrumb'),
					"类别",
					"/categories",
					"学习",
					"/categories/学习",
					1
				);
			
		
	</script>
</header>

<div class="main-wrapper">
    <main class="post">
        <header class="main-header">
	
		
			
				
<link rel="stylesheet" href="/css/plugins/fancybox.css">

				
<script src="/js/plugins/fancybox.umd.js"></script>

				
<script src="/js/plugins/fancybox.js"></script>

			
			<div class="post-header-background-content">
				<ul class="post-header-tag">
					
						
							<li><a href="/tags/Python"><span>Python</span></a></li>
						
							<li><a href="/tags/论文"><span>论文</span></a></li>
						
							<li><a href="/tags/实验相关"><span>实验相关</span></a></li>
						
							<li><a href="/tags/Pytorch"><span>Pytorch</span></a></li>
						
							<li><a href="/tags/MindSpore"><span>MindSpore</span></a></li>
						
							<li><a href="/tags/文本检测"><span>文本检测</span></a></li>
						
							<li><a href="/tags/代码复现"><span>代码复现</span></a></li>
						
					
				</ul>
				
				<h1>Paper-EAST-An Efficient and Accurate Scene Text Detector</h1>
		
				
					<div class="post-header-desc">
						<svg t="1714702231661" class="icon" viewBox="0 0 1024 1024" version="1.1"
						xmlns="http://www.w3.org/2000/svg" p-id="1154" xmlns:xlink="http://www.w3.org/1999/xlink"
						width="20" height="20">
						<path
							d="M778.24 117.76A46.08 46.08 0 0 1 824.32 163.84v430.08c0 8.4992-4.13696 16.01536-10.50624 20.6848l-0.24576 0.2048L587.5712 846.09024a35.84 35.84 0 0 1-61.48096-25.06752v-220.9792a46.08 46.08 0 0 1 46.08-46.08l200.94976-0.02048V168.96h-522.24v686.08H389.12c13.25056 0 24.1664 10.07616 25.47712 22.97856l0.12288 2.62144c0 14.1312-11.4688 25.6-25.6 25.6h-143.36A46.08 46.08 0 0 1 199.68 860.16V163.84A46.08 46.08 0 0 1 245.76 117.76h532.48z m-26.78784 487.38304h-174.16192v178.176l174.16192-178.176z m-45.19936-169.94304a25.6 25.6 0 0 1 0 51.2H307.2a25.6 25.6 0 0 1 0-51.2h399.0528z m0-122.88a25.6 25.6 0 0 1 0 51.2H307.2a25.6 25.6 0 0 1 0-51.2h399.0528z"
							fill="#ffffff" p-id="1155"></path>
						</svg>
						<p>论文阅读。</p>
					</div>
				
		
				<div class="post-header-info">
					<svg t="1604839279282" class="icon" viewBox="0 0 1024 1024" version="1.1"
					xmlns="http://www.w3.org/2000/svg" p-id="2901" width="20" height="20">
						<path
							d="M513 956.3c-247.7 0-448-200.3-448-448S265.3 66.2 513 66.2s448 200.3 448 448-200.3 442.1-448 442.1z m0-830.9c-212.2 0-388.8 170.7-388.8 388.8C124.2 726.3 294.9 903 513 903c212.2 0 388.8-170.7 388.8-388.8S725.2 125.4 513 125.4z m0 430.2c-94.2 0-170.7-76.5-170.7-170.7S418.8 207.8 513 207.8s170.7 76.5 170.7 170.7S607.2 555.6 513 555.6z m0-289.1c-64.6 0-112 52.8-112 112s47.4 117.9 112 117.9 112-52.8 112-112-47.4-117.9-112-117.9z m0 689.8c-135.7 0-259-58.7-341.9-158.9l-11.8-17.8 11.8-17.8c76.5-117.9 206.2-188.5 347.8-188.5 135.7 0 265 64.6 341.9 182.6l11.8 17.8-11.8 17.8C778 897.1 648.7 956.3 513 956.3zM230.3 773.2C300.9 849.7 406.9 897 513 897c112 0 218.1-47.4 288.6-129.8-70.5-88.2-170.7-135.6-282.7-135.6s-218.1 53.3-288.6 141.6z"
							p-id="2902" fill="#ffffff"></path>
					</svg>
					<div class="post-header-info-author">
						<a href="/about">Zi-Zi</a>
					</div>
					
						<div class="post-header-info-categories">
							
								<a href="/categories/学习">学习</a>
							
						</div>
					
					<time>2023/05/13 08:01:00</time>
				</div>
		
				
					<div class="post-header-stat">
						<svg version="1.0" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
						viewBox="0 0 200 200" enable-background="new 0 0 200 200" xml:space="preserve" width="20" height="20">
							<path fill="#FFFFFF" d="M187.2,165.6c0,2.6-2.1,4.7-4.7,4.7H17.5c-2.6,0-4.7-2.1-4.7-4.7s2.1-4.7,4.7-4.7h165.1
								C185.2,160.9,187.2,163,187.2,165.6z"/>
							<path fill="#FFFFFF" d="M17.5,29.7c2.6,0,4.7,2.1,4.7,4.7v131.2c0,2.6-2.1,4.7-4.7,4.7s-4.7-2.1-4.7-4.7V34.4
								C12.8,31.8,14.9,29.7,17.5,29.7z M77.9,91.5c1.8,1.8,1.8,4.8,0,6.6l-39.8,39.8c-1.9,1.8-4.9,1.7-6.6-0.2c-1.7-1.8-1.7-4.6,0-6.4
								l39.8-39.8C73.1,89.6,76,89.6,77.9,91.5z M169.9,70.2c1.6,2.1,1.1,5-0.9,6.5c0,0,0,0,0,0l-64.2,48.2c-2.1,1.5-5,1.1-6.6-0.9
								c-1.6-2.1-1.1-5,0.9-6.5c0,0,0,0,0,0l64.2-48.2C165.4,67.7,168.3,68.1,169.9,70.2L169.9,70.2z"/>
							<path fill="#FFFFFF" d="M104.6,124.5c-1.8,1.8-4.8,1.8-6.6,0L71.6,98.1c-1.8-1.8-1.8-4.8,0-6.6c1.8-1.8,4.8-1.8,6.6,0l26.3,26.3
								C106.4,119.6,106.4,122.6,104.6,124.5C104.6,124.4,104.6,124.4,104.6,124.5z"/>
						</svg>
		
						
							
<script src="/js/plugins/wordCount.js"></script>

							<p class="post-count">文字数：---</p>
						
		
						
							<p id="busuanzi_container_page_pv" style='display:none;'>阅读数：<span id="busuanzi_value_page_pv"></span></p>
						
					</div>
				
			</div>
		
	
</header>
        <div class="post-content article-container">
            <article class="post-content-info">
                <h1 id="%E8%B5%84%E6%BA%90" tabindex="-1">资源</h1>
<ul>
<li>
<p>PaperWithCode：<a target="_blank" rel="noopener" href="https://paperswithcode.com/paper/east-an-efficient-and-accurate-scene-text">EAST: An Efficient and Accurate Scene Text Detector | Papers With Code</a></p>
<ul>
<li>arxiv：<a target="_blank" rel="noopener" href="https://arxiv.org/abs/1704.03155v2">[1704.03155v2] EAST: An Efficient and Accurate Scene Text Detector (arxiv.org)</a></li>
<li>github：<a target="_blank" rel="noopener" href="https://github.com/SakuraRiven/EAST">SakuraRiven/EAST: PyTorch Re-Implementation of EAST: An Efficient and Accurate Scene Text Detector (github.com)</a></li>
</ul>
</li>
<li>
<p>MindSpore：<a target="_blank" rel="noopener" href="https://gitee.com/mindspore/models">models: Models of MindSpore (gitee.com)</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://gitee.com/mindspore/models/tree/master/research/cv/east">EAST for Ascend - Gitee.com</a></li>
</ul>
</li>
<li>
<p>Blog：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/34b73ca276fc">EAST 算法超详细源码解析（一）、数据预处理与标签生成 - 简书 (jianshu.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f499c7b4e751">EAST 算法超详细源码解析（二）、模型推断与测试结果生成 - 简书 (jianshu.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e83a55bc4cbc">EAST 算法超详细源码解析（三）、模型构建 - 简书 (jianshu.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0efd281b1481">EAST 算法超详细源码解析（四）、损失函数 - 简书 (jianshu.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/beb10e3756ae">EAST 算法超详细源码解析（五）、评估验证 - 简书 (jianshu.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b36f81bc61ef">EAST 算法超详细源码解析（六）、模型训练 - 简书 (jianshu.com)</a></li>
</ul>
</li>
</ul>
<h1 id="%E6%AD%A3%E6%96%87" tabindex="-1">正文</h1>
<p>​    我们这个模型使用单个神经网络<strong>直接预测</strong>完整图像中的任意方向和四边形的单词或文本行，消除了不必要的中间步骤（如候选聚合和单词划分）。我们的模型在 <code>ICDAR 2015</code>、<code>COCO Text</code> 和 <code>MSRA-TD500</code> 中都非常好使！</p>
<hr>
<p>​    文本检测作为后续过程的<strong>先决</strong>条件，核心是设计特征来区分文本和背景。</p>
<p>​    提出了一个快速准确的场景文本检测流水线，使用一个**完全卷积神经网络（FCN）<strong>模型，产生单词或文本行级别的预测，排除了冗余和缓慢的中间步骤。生成的文本预测可以是旋转的矩形或四边形，将被发送到</strong>非最大抑制（Non-Maximum Suppression，NMS）**以产生最终结果。</p>
<hr>
<p>​    <strong>EAST</strong>, since it is an <strong>E</strong>fficient and <strong>A</strong>ccuracy <strong>S</strong>cene <strong>T</strong>ext detection pipeline.</p>
<p><img src="T1.png" alt="png"></p>
<ul>
<li>
<p><font color="orange">Feature extractor
stem，特征提取炳（PVANet）</font></p>
<ul>
<li>主干可以是在 ImageNet 数据集上预先训练的卷积网络，具有交错的卷积和池化层。从干提取四个级别的特征图，表示为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.10764em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>，其大小分别为输入图像的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>1</mn></mrow><mrow><mn>3</mn><mn>2</mn></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mn>1</mn><mn>6</mn></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mn>8</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{32},\frac{1}{16},\frac{1}{8}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.845108em;"></span><span class="strut bottom" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="base textstyle uncramped"><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mpunct">,</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">1</span><span class="mord mathrm">6</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mpunct">,</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">8</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>1</mn></mrow><mrow><mn>4</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.845108em;"></span><span class="strut bottom" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="base textstyle uncramped"><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span>。</li>
</ul>
</li>
<li>
<p><font color="green">Feature-merging
branch，特征合并分支</font></p>
<ul>
<li>
<p>逐渐将它们合并（concat）：</p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>g</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mrow><mi mathvariant="normal">u</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">l</mi></mrow><mo>(</mo><msub><mi>h</mi><mi>i</mi></msub><mo>)</mo></mrow></mtd><mtd><mrow><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mrow></mrow></mtd><mtd><mrow><mi>i</mi><mo>≤</mo><mn>3</mn></mrow></mtd></mtr><mtr><mtd><mrow><msub><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">v</mi></mrow><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow></msub><mo>(</mo><msub><mi>h</mi><mi>i</mi></msub><mo>)</mo></mrow></mtd><mtd><mrow><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mrow></mrow></mtd><mtd><mrow><mi>i</mi><mo>=</mo><mn>4</mn></mrow></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">g_i=\left\{\begin{matrix}\mathrm{unpool}(h_i) &amp; \mathrm{if} &amp; i\le3 \\ \mathrm{conv}_{3\times3}(h_i) &amp; \mathrm{if} &amp; i=4\end{matrix}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.45em;"></span><span class="strut bottom" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist"><span style="top:-0.6099999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">u</span><span class="mord mathrm">n</span><span class="mord mathrm">p</span><span class="mord mathrm">o</span><span class="mord mathrm">o</span><span class="mord mathrm">l</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathit">h</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span><span style="top:0.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class=""><span class="mord textstyle uncramped"><span class="mord mathrm">c</span><span class="mord mathrm">o</span><span class="mord mathrm">n</span><span class="mord mathrm" style="margin-right:0.01389em;">v</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">3</span><span class="mbin">×</span><span class="mord mathrm">3</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathit">h</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist"><span style="top:-0.6099999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span></span></span><span style="top:0.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist"><span style="top:-0.6099999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit">i</span><span class="mrel">≤</span><span class="mord mathrm">3</span></span></span><span style="top:0.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit">i</span><span class="mrel">=</span><span class="mord mathrm">4</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>h</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow></mtd><mtd><mrow><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mrow><mtext> </mtext><mi>i</mi><mo>=</mo><mn>1</mn></mrow></mtd></mtr><mtr><mtd><mrow><msub><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">v</mi></mrow><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow></msub><mo>(</mo><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><msub><mi mathvariant="normal">v</mi><mrow><mn mathvariant="normal">1</mn><mo>×</mo><mn mathvariant="normal">1</mn></mrow></msub></mrow><mo>(</mo><mo>[</mo><msub><mi>g</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">;</mo><msub><mi>f</mi><mi>i</mi></msub><mo>]</mo><mo>)</mo><mo>)</mo></mrow></mtd><mtd><mrow><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">w</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">e</mi></mrow></mrow></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">h_i=\left\{\begin{matrix}f_i &amp; \mathrm{if}\ i=1\\\mathrm{conv}_{3\times3}(\mathrm{conv_{1\times1}}([g_{i-1};f_i])) &amp; \mathrm{otherwise}\end{matrix}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.45em;"></span><span class="strut bottom" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">h</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist"><span style="top:-0.6099999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.10764em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span style="top:0.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class=""><span class="mord textstyle uncramped"><span class="mord mathrm">c</span><span class="mord mathrm">o</span><span class="mord mathrm">n</span><span class="mord mathrm" style="margin-right:0.01389em;">v</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">3</span><span class="mbin">×</span><span class="mord mathrm">3</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord textstyle uncramped"><span class="mord mathrm">c</span><span class="mord mathrm">o</span><span class="mord mathrm">n</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">v</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01389em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">1</span><span class="mbin">×</span><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span><span class="mopen">(</span><span class="mopen">[</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mbin">−</span><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">;</span><span class="mord"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.10764em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">]</span><span class="mclose">)</span><span class="mclose">)</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist"><span style="top:-0.6099999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace"> </span><span class="mord mathit">i</span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span><span style="top:0.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">o</span><span class="mord mathrm">t</span><span class="mord mathrm">h</span><span class="mord mathrm">e</span><span class="mord mathrm">r</span><span class="mord mathrm" style="margin-right:0.01389em;">w</span><span class="mord mathrm">i</span><span class="mord mathrm">s</span><span class="mord mathrm">e</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></p>
<ul>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>g</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">g_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 是合并基数</p>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>h</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">h_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">h</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 是合并后的特征图</p>
</li>
<li>
<p>运算符 [·;·] 表示沿通道轴的串联</p>
</li>
</ul>
</li>
<li>
<p>在每个合并阶段，来自最后一个阶段的特征图首先被馈送到 unpool 层以使其大小加倍，然后与当前特征图连接。</p>
</li>
<li>
<p>\mathrm{conv}_{1×1} 减少了通道数量并减少了计算</p>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">v</mi></mrow><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{conv}_{3\times3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.638891em;vertical-align:-0.208331em;"></span><span class="base textstyle uncramped"><span class=""><span class="mord textstyle uncramped"><span class="mord mathrm">c</span><span class="mord mathrm">o</span><span class="mord mathrm">n</span><span class="mord mathrm" style="margin-right:0.01389em;">v</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">3</span><span class="mbin">×</span><span class="mord mathrm">3</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 融合了信息，最终产生了这个合并阶段的输出</p>
</li>
<li>
<p>在最后一个合并阶段之后，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">v</mi></mrow><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\mathrm{conv}_{3\times3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.638891em;vertical-align:-0.208331em;"></span><span class="base textstyle uncramped"><span class=""><span class="mord textstyle uncramped"><span class="mord mathrm">c</span><span class="mord mathrm">o</span><span class="mord mathrm">n</span><span class="mord mathrm" style="margin-right:0.01389em;">v</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">3</span><span class="mbin">×</span><span class="mord mathrm">3</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 层生成合并分支的最终特征图，并将其提供给输出层。</p>
</li>
</ul>
</li>
<li>
<p><font color="navy">Output layer，输出层</font></p>
<ul>
<li>
<p>对文本区域的两种几何形状进行实验：</p>
<ul>
<li>旋转框（RBOX）
<ul>
<li>4 个轴对齐边界框（AABB）<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68611em;"></span><span class="strut bottom" style="height:0.68611em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathbf">R</span></span></span></span></li>
<li>1 个通道旋转角度 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span></li>
</ul>
</li>
<li>四边形（QUAD）
<ul>
<li>使用 8 个数字来表示从四边形的四个角顶点 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>{</mo><msub><mi>p</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mi>i</mi><mo>∈</mo><mo>{</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>4</mn><mo>}</mo><mo>}</mo></mrow><annotation encoding="application/x-tex">\{p_i|i\in\{1,2,3,4\}\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">{</span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">∣</span><span class="mord mathit">i</span><span class="mrel">∈</span><span class="mopen">{</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathrm">2</span><span class="mpunct">,</span><span class="mord mathrm">3</span><span class="mpunct">,</span><span class="mord mathrm">4</span><span class="mclose">}</span><span class="mclose">}</span></span></span></span> 到像素位置的坐标偏移，由于每个距离偏移包含两个数字 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi mathvariant="normal">Δ</mi><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><mi mathvariant="normal">Δ</mi><msub><mi>y</mi><mi>i</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">(\Delta x_i,\Delta y_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">(</span><span class="mord mathrm">Δ</span><span class="mord"><span class="mord mathit">x</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="mord mathrm">Δ</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span>，几何输出包含 8 个通道。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>为每种几何形状设计了不同的损失函数:</p>
<ul>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mo>=</mo><msub><mi>L</mi><mi>s</mi></msub><mo>+</mo><msub><mi>λ</mi><mi>g</mi></msub><msub><mi>L</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">L=L_s+\lambda_gL_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span><span class="mrel">=</span><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">s</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mord"><span class="mord mathit">λ</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">g</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">g</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></p>
<ul>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">L_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">s</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 表示<strong>分数图</strong>的损失，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mrow><mi>s</mi></mrow></msub><mo>=</mo><mrow><mi mathvariant="normal">b</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mo>−</mo><mi mathvariant="normal">x</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi></mrow><mo>(</mo><mover accent="true"><mrow><mrow><mi mathvariant="bold">Y</mi></mrow></mrow><mo>^</mo></mover><mo separator="true">,</mo><msup><mrow><mi mathvariant="bold">Y</mi></mrow><mrow><mo>∗</mo></mrow></msup><mo>)</mo><mo>=</mo><mo>−</mo><mi>β</mi><msup><mrow><mi mathvariant="bold">Y</mi></mrow><mrow><mo>∗</mo></mrow></msup><mi>log</mi><mover accent="true"><mrow><mrow><mi mathvariant="bold">Y</mi></mrow></mrow><mo>^</mo></mover><mo>−</mo><mo>(</mo><mn>1</mn><mo>−</mo><mi>β</mi><mo>)</mo><mo>(</mo><mn>1</mn><mo>−</mo><msup><mrow><mi mathvariant="bold">Y</mi></mrow><mrow><mo>∗</mo></mrow></msup><mo>)</mo><mi>log</mi><mo>(</mo><mn>1</mn><mo>−</mo><mover accent="true"><mrow><mrow><mi mathvariant="bold">Y</mi></mrow></mrow><mo>^</mo></mover><mo>)</mo></mrow><annotation encoding="application/x-tex">L_{s}=\mathrm{balanced-xent}(\hat{\mathbf{Y}},\mathbf{Y}^{*})=-\beta\mathbf{Y}^{*}\log\hat{\mathbf{Y}}-(1-\beta)(1-\mathbf{Y}^{*})\log(1-\hat{\mathbf{Y}})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9495499999999999em;"></span><span class="strut bottom" style="height:1.19955em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">s</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord textstyle uncramped"><span class="mord mathrm">b</span><span class="mord mathrm">a</span><span class="mord mathrm">l</span><span class="mord mathrm">a</span><span class="mord mathrm">n</span><span class="mord mathrm">c</span><span class="mord mathrm">e</span><span class="mord mathrm">d</span><span class="mbin">−</span><span class="mord mathrm">x</span><span class="mord mathrm">e</span><span class="mord mathrm">n</span><span class="mord mathrm">t</span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span></span></span><span style="top:-0.25511em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class=""><span class="mord textstyle uncramped"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">∗</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mrel">=</span><span class="mord">−</span><span class="mord mathit" style="margin-right:0.05278em;">β</span><span class=""><span class="mord textstyle uncramped"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">∗</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span></span></span><span style="top:-0.25511em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mopen">(</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mord mathit" style="margin-right:0.05278em;">β</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class=""><span class="mord textstyle uncramped"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">∗</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span></span></span><span style="top:-0.25511em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span></p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mrow><mrow><mi mathvariant="bold">Y</mi></mrow></mrow><mo>^</mo></mover><mo>=</mo><msub><mi>F</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">\hat{\mathbf{Y}}=F_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9495499999999999em;"></span><span class="strut bottom" style="height:1.0995499999999998em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span></span></span><span style="top:-0.25511em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">s</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 是分数图的预测
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi mathvariant="bold">Y</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">\mathbf Y^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.688696em;"></span><span class="strut bottom" style="height:0.688696em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class=""><span class="mord mathbf" style="margin-right:0.02875em;">Y</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 是 ground truth</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.05278em;">β</span></span></span></span> 是正样本和负样本之间的平衡因子，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>β</mi><mo>=</mo><mn>1</mn><mo>−</mo><mfrac><mrow><msub><mo>∑</mo><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>∈</mo><msup><mi mathvariant="bold">Y</mi><mo>∗</mo></msup></mrow></msub><msup><mi>y</mi><mo>∗</mo></msup></mrow><mrow><mi mathvariant="normal">∣</mi><msup><mi mathvariant="bold">Y</mi><mo>∗</mo></msup><mi mathvariant="normal">∣</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\beta=1-\frac{\sum_{y^*\in\mathbf Y^*}y^*}{|\mathbf Y^*|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.1422269999999999em;"></span><span class="strut bottom" style="height:1.662227em;vertical-align:-0.52em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.05278em;">β</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.34500000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">∣</span><span class=""><span class="mord mathbf" style="margin-right:0.02875em;">Y</span><span class="vlist"><span style="top:-0.30011em;margin-right:0.07142857142857144em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">∣</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.617227em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mop"><span class="op-symbol small-op mop" style="top:0.074995em;">∑</span><span class="vlist"><span style="top:0.30001em;margin-right:0.07142857142857144em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:-0.289em;margin-right:0.1em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptscriptstyle scriptscriptstyle cramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">∈</span><span class=""><span class="mord mathbf" style="margin-right:0.02875em;">Y</span><span class="vlist"><span style="top:-0.30011em;margin-right:0.1em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptscriptstyle scriptscriptstyle cramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:-0.363em;margin-right:0.07142857142857144em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle uncramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></li>
</ul>
</li>
</ul>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">L_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">g</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 表示<strong>几何图形</strong>的损失，直接用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">L_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 或 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">L_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 将引导损失偏向于更大和更长的文本区域。</p>
<ul>
<li>
<p>在 RBOX 回归：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>g</mi></msub><mo>=</mo><msub><mi>L</mi><mrow><mi>A</mi><mi>A</mi><mi>B</mi><mi>B</mi></mrow></msub><mo>+</mo><msub><mi>λ</mi><mi>θ</mi></msub><msub><mi>L</mi><mrow><mi>θ</mi></mrow></msub></mrow><annotation encoding="application/x-tex">L_g=L_{AABB}+\lambda_\theta L_{\theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">g</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">A</span><span class="mord mathit">A</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit" style="margin-right:0.05017em;">B</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mord"><span class="mord mathit">λ</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>λ</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\lambda_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">λ</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 取 10</p>
<ul>
<li>
<p>AABB 部分采用 IoU 损失：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mrow><mi>A</mi><mi>A</mi><mi>B</mi><mi>B</mi></mrow></msub><mo>=</mo><mo>−</mo><mi>log</mi><mrow><mi mathvariant="normal">I</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">U</mi></mrow><mo>(</mo><mover accent="true"><mrow><mrow><mi mathvariant="bold">R</mi></mrow></mrow><mo>^</mo></mover><mo separator="true">,</mo><msup><mi mathvariant="bold">R</mi><mo>∗</mo></msup><mo>)</mo><mo>=</mo><mo>−</mo><mi>log</mi><mfrac><mrow><mi mathvariant="normal">∣</mi><mrow><mi mathvariant="bold">R</mi></mrow><mo>∩</mo><msup><mi mathvariant="bold">R</mi><mo>∗</mo></msup><mi mathvariant="normal">∣</mi></mrow><mrow><mi mathvariant="normal">∣</mi><mrow><mi mathvariant="bold">R</mi></mrow><mo>∪</mo><msup><mi mathvariant="bold">R</mi><mo>∗</mo></msup><mi mathvariant="normal">∣</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">L_{AABB}=-\log\mathrm{IoU}(\hat{\mathbf{R}},\mathbf R^*)=-\log\frac{|\mathbf{R}\cap \mathbf R^*|}{|\mathbf{R}\cup \mathbf R^*|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.01em;"></span><span class="strut bottom" style="height:1.53em;vertical-align:-0.52em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">A</span><span class="mord mathit">A</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit" style="margin-right:0.05017em;">B</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord">−</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord textstyle uncramped"><span class="mord mathrm">I</span><span class="mord mathrm">o</span><span class="mord mathrm">U</span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathbf">R</span></span></span></span><span style="top:-0.25511em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class=""><span class="mord mathbf">R</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mrel">=</span><span class="mord">−</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.34500000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">∣</span><span class="mord scriptstyle cramped"><span class="mord mathbf">R</span></span><span class="mbin">∪</span><span class=""><span class="mord mathbf">R</span><span class="vlist"><span style="top:-0.30011em;margin-right:0.07142857142857144em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">∣</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.485em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">∣</span><span class="mord scriptstyle uncramped"><span class="mord mathbf">R</span></span><span class="mbin">∩</span><span class=""><span class="mord mathbf">R</span><span class="vlist"><span style="top:-0.363em;margin-right:0.07142857142857144em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle uncramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">∣</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></p>
</li>
<li>
<p>旋转角度损失：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>θ</mi></msub><mo>(</mo><mover accent="true"><mi>θ</mi><mo>^</mo></mover><mo separator="true">,</mo><msup><mi>θ</mi><mo>∗</mo></msup><mo>)</mo><mo>=</mo><mn>1</mn><mo>−</mo><mi>cos</mi><mo>(</mo><mover accent="true"><mi>θ</mi><mo>^</mo></mover><mo>−</mo><msup><mi>θ</mi><mo>∗</mo></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">L_\theta(\hat\theta,\theta^*)=1-\cos(\hat\theta-\theta^*)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9578799999999998em;"></span><span class="strut bottom" style="height:1.2078799999999998em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span><span style="top:-0.26343999999999995em;margin-left:0.16668em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="mord"><span class="mord mathit" style="margin-right:0.02778em;">θ</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mop">cos</span><span class="mopen">(</span><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span><span style="top:-0.26343999999999995em;margin-left:0.16668em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord"><span class="mord mathit" style="margin-right:0.02778em;">θ</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span></p>
</li>
</ul>
</li>
<li>
<p>在 QUAD 回归中采用尺度归一化平滑 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">L_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 损失：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>g</mi></msub><mo>=</mo><msub><mi>L</mi><mrow><mi>Q</mi><mi>U</mi><mi>A</mi><mi>D</mi></mrow></msub><mo>(</mo><mover accent="true"><mrow><mrow><mi mathvariant="bold">Q</mi></mrow></mrow><mo>^</mo></mover><mo separator="true">,</mo><msup><mi mathvariant="bold">Q</mi><mo>∗</mo></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">L_g=L_{QUAD}(\hat{\mathbf{Q}},\mathbf Q^*)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9495499999999999em;"></span><span class="strut bottom" style="height:1.235658em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">g</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">Q</span><span class="mord mathit" style="margin-right:0.10903em;">U</span><span class="mord mathit">A</span><span class="mord mathit" style="margin-right:0.02778em;">D</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathbf">Q</span></span></span></span><span style="top:-0.25511em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class=""><span class="mord mathbf">Q</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span></p>
</li>
</ul>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>λ</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">\lambda_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">λ</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">g</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 表示两个损失之间的重要性，设为 1。</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>包含几个 \mathrm{conv}_{1×1} 操作，将 32 个通道的特征图投影到 1 个通道的分数图 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>F</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">F_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">s</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 和一个多通道的几何图 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>F</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">F_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">g</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 中。几何输出可以是 RBOX 或 QUAD 中的一个</p>
</li>
</ul>
<p>​    将阈值应用于每个预测区域，其中得分超过预定义阈值的几何体被认为是有效的，并保存以供以后进行非最大值抑制。NMS 之后的结果被认为是管道的最终输出。ADAM 优化器，batch=24。</p>
<hr>
<p>​    NMS：在假设附近像素的几何图形往往高度相关的情况下，我们建议逐行合并几何图形，在合并同一行中的几何图形时，我们将迭代合并当前遇到的几何图形和最后合并的几何图形。这种改进的技术在最佳场景中在 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span> 中运行。尽管它的最坏情况与原始情况相同，但只要局部性假设成立，该算法在实践中运行得足够快。</p>
<hr>
<p>未来研究的可能方向包括：</p>
<ul>
<li>调整几何公式，以允许直接检测弯曲文本；</li>
<li>将所述检测器与文本识别器集成；</li>
<li>将该思想扩展到通用对象检测。</li>
</ul>
<h1 id="%E4%BB%A3%E7%A0%81" tabindex="-1">代码</h1>
<h2 id="pytorch" tabindex="-1" id="Pytorch">Pytorch</h2>
<h3 id="windows" tabindex="-1" id="Windows">Windows</h3>
<ol>
<li>从 <a target="_blank" rel="noopener" href="https://github.com/SakuraRiven/EAST">SakuraRiven/EAST: PyTorch Re-Implementation of EAST: An Efficient and Accurate Scene Text Detector (github.com)</a> 加载仓库：</li>
</ol>
<p><img src="P1.png" alt="png"></p>
<center>加载工程文件</center>
<ol start="2">
<li>
<p>conda 中新建一个 EAST 环境（<code>conda create -n east python=3.7</code>）并安装好：</p>
<ul>
<li>pytorch</li>
<li>shapely</li>
<li>opencv-python 4.0.0.21</li>
<li>lanms，巨难装，用 <code>pip install lanms-neo==1.0.2 -i https://pypi.tuna.tsinghua.edu.cn/simple</code>
<ul>
<li>如果是 wsl2 的 ubuntu，<code> pip install lanms-proper</code></li>
</ul>
</li>
</ul>
<p>设置好解释器</p>
</li>
</ol>
<p><img src="P2.png" alt="png"></p>
<center>设置解释器</center>
<ol start="3">
<li>下载模型：<a target="_blank" rel="noopener" href="https://drive.google.com/open?id=1HgDuFGd2q77Z6DcUlDEfBZgxeJv4tald">VGG16</a> 和 <a target="_blank" rel="noopener" href="https://drive.google.com/open?id=1AFABkJgr5VtxWnmBU3XcfLJvpZkC2TAg">EAST</a>，将它们放在 <code>pths/</code> 文件夹中</li>
</ol>
<p><img src="P3.png" alt="png"></p>
<center>下载并放置预训练好的模型</center>
<ol start="4">
<li>从 <a target="_blank" rel="noopener" href="https://rrc.cvc.uab.es/?ch=4&amp;com=downloads">Downloads - Incidental Scene Text - Robust Reading Competition (uab.es)</a> 下载好 ICDAR 2015 Challenge 4 数据集，解压并按规则放在对应的文件夹中（原项目想放到工程外面，我改到了工程里面）</li>
</ol>
<p><img src="P4_1.png" alt="png"></p>
<center>数据集官网</center>
<p><img src="P4_2.png" alt="png"></p>
<center>下载出这么四个压缩包</center>
<p><img src="P4_3.png" alt="png"></p>
<center>设置数据集地址</center>
<p><img src="P4_4.png" alt="png"></p>
<center>修改路径</center>
<ol start="5">
<li>开跑 <code>detect.py</code>！</li>
</ol>
<p><img src="P5.png" alt="png"></p>
<center>预测结果</center>
<ol start="6">
<li>
<p>开跑 <code>train.py</code>！喜提错误：<font color="red">UnicodeDecodeError: ‘gbk’ codec can’t decode byte 0xbf in position 2: illegal multibyte sequence</font>！在 <code>dataset.py</code> 中的第 382 行 <code>with open(self.gt_files[index], 'r') as f:</code> 改成 <code>with open(self.gt_files[index], 'r', encoding='utf-8') as f:</code> 填之。</p>
</li>
<li>
<p>开跑 <code>train.py</code>！喜提错误：<font color="red">torch.cuda.OutOfMemoryError: CUDA out of memory. Tried to allocate 1.50 GiB (GPU 0; 8.00 GiB total capacity; 3.14 GiB already allocated; 2.79 GiB free; 3.15 GiB reserved in total by PyTorch) If reserved memory is &gt;&gt; allocated memory try setting max_split_size_mb to avoid fragmentation.  See documentation for Memory Management and PYTORCH_CUDA_ALLOC_CONF</font>！在<code>train.py</code> 里把 <code>batch_size = 24</code> 改成 <code>batch_size = 4</code> 填之。</p>
</li>
<li>
<p>开跑 <code>train.py</code>！能跑了！</p>
</li>
</ol>
<h3 id="wsl2" tabindex="-1" id="WSL2">WSL2</h3>
<p>装好环境</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda create -n EAST python=3.7<br>conda activate EAST<br>pip install shapely<br>pip install opencv-python==4.0.0.21<br>pip install lanms-proper<br></code></pre></td></tr></table></figure>
<p>开跑！</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">python3 train.py<br></code></pre></td></tr></table></figure>
<p>喜提错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">  File &quot;/home/gz/anaconda3/envs/EAST/lib/python3.7/site-packages/cv2/__init__.py&quot;, line 3, in &lt;module&gt;<br>    from .cv2 import *<br>ImportError: libSM.so.6: cannot open shared object file: No such file or directory<br></code></pre></td></tr></table></figure>
<p>填：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">sudo</span> apt update<br><span class="hljs-built_in">sudo</span> apt install libsm6<br></code></pre></td></tr></table></figure>
<p>喜提错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Could not load library libcudnn_cnn_infer.so.8. Error: libcuda.so: cannot open shared object file: No such file or directory<br>Please make sure libcudnn_cnn_infer.so.8 is in your library path!<br></code></pre></td></tr></table></figure>
<p>安装 CUDNN：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">sudo apt install nvidia-cuda-toolkit<br></code></pre></td></tr></table></figure>
<p>开跑！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/home/gz/anaconda3/envs/EAST/lib/python3.7/site-packages/torch/optim/lr_scheduler.py:143: UserWarning: Detected call of `lr_scheduler.step()` before `optimizer.step()`. In PyTorch 1.1.0 and later, you should call them in the opposite order: `optimizer.step()` before `lr_scheduler.step()`.  Failure to do this will result in PyTorch skipping the first value of the learning rate schedule. See more details at https://pytorch.org/docs/stable/optim.html#how-to-adjust-learning-rate<br>  &quot;https://pytorch.org/docs/stable/optim.html#how-to-adjust-learning-rate&quot;, UserWarning)<br>/home/gz/anaconda3/envs/EAST/lib/python3.7/site-packages/shapely/set_operations.py:133: RuntimeWarning: invalid value encountered in intersection<br>  return lib.intersection(a, b, **kwargs)<br>/home/gz/anaconda3/envs/EAST/lib/python3.7/site-packages/shapely/set_operations.py:133: RuntimeWarning: invalid value encountered in intersection<br>  return lib.intersection(a, b, **kwargs)<br>/home/gz/anaconda3/envs/EAST/lib/python3.7/site-packages/shapely/set_operations.py:133: RuntimeWarning: invalid value encountered in intersection<br>  return lib.intersection(a, b, **kwargs)<br>/home/gz/anaconda3/envs/EAST/lib/python3.7/site-packages/shapely/set_operations.py:133: RuntimeWarning: invalid value encountered in intersection<br>  return lib.intersection(a, b, **kwargs)<br>classify loss is 0.98071122, angle loss is 0.68633509, iou loss is 5.08373260<br>Epoch is [1/600], mini-batch is [1/250], time consumption is 8.06183171, batch_loss is 12.92779446<br>classify loss is 0.99145019, angle loss is 0.75015461, iou loss is 4.81786251<br>Epoch is [1/600], mini-batch is [2/250], time consumption is 0.21901011, batch_loss is 13.31085873<br>classify loss is 0.99974638, angle loss is 0.74429435, iou loss is 5.48675823<br>Epoch is [1/600], mini-batch is [3/250], time consumption is 0.21214652, batch_loss is 13.92944813<br>classify loss is 0.99397326, angle loss is 0.60727608, iou loss is 3.27876091<br>Epoch is [1/600], mini-batch is [4/250], time consumption is 0.22212124, batch_loss is 10.34549522<br>classify loss is 0.99331516, angle loss is 0.67070889, iou loss is 3.67775035<br>Epoch is [1/600], mini-batch is [5/250], time consumption is 0.23853326, batch_loss is 11.37815380<br>classify loss is 0.98511696, angle loss is 0.73328424, iou loss is 3.17167139<br>Epoch is [1/600], mini-batch is [6/250], time consumption is 0.20371103, batch_loss is 11.48963070<br>classify loss is 0.99793059, angle loss is 0.60213274, iou loss is 4.67736626<br>...<br></code></pre></td></tr></table></figure>
<h2 id="mindspore" tabindex="-1" id="MindSpore">MindSpore</h2>
<h3 id="%E8%AF%BB%E4%BB%A3%E7%A0%81" tabindex="-1" id="读代码">读代码</h3>
<h4 id="train.py" tabindex="-1" id="train-py"><a target="_blank" rel="noopener" href="http://train.py">train.py</a></h4>
<p>好像跟其他的<code>train.py</code>差不多，设置完各种参数然后加载模型和优化器，开跑！</p>
<p>各种细节都在<code>src/</code>里。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> src.util <span class="hljs-keyword">import</span> AverageMeter, get_param_groups<br><span class="hljs-keyword">from</span> src.east <span class="hljs-keyword">import</span> EAST, EastWithLossCell<br><span class="hljs-keyword">from</span> src.logger <span class="hljs-keyword">import</span> get_logger<br><span class="hljs-keyword">from</span> src.initializer <span class="hljs-keyword">import</span> default_recurisive_init<br><span class="hljs-keyword">from</span> src.dataset <span class="hljs-keyword">import</span> create_east_dataset<br><span class="hljs-keyword">from</span> src.lr_scheduler <span class="hljs-keyword">import</span> get_lr<br></code></pre></td></tr></table></figure>
<blockquote>
<p>这段代码主要是对所需的模块进行引用，包括平均数计算、网络参数获取、EAST 模型、损失函数、日志记录、参数初始化、EAST 数据集和学习率调度器。</p>
<p>首先，从<code>src.util</code>模块中引入<code>AverageMeter()</code>和<code>get_param_groups()</code>方法，分别用于计算平均数和获取网络中需要训练的参数。</p>
<p>接着，从<code>src.east</code>模块中引入<code>EAST</code>类和<code>EastWithLossCell</code>类，分别表示 EAST 模型和组合了损失函数的 EAST 模型。</p>
<p>然后，从<code>src.logger</code>模块中引入<code>get_logger()</code>方法，用于获取日志记录器。</p>
<p>接下来，从<code>src.initializer</code>模块中引入<code>default_recursive_init()</code>方法，用于对 EAST 模型进行默认的递归初始化。</p>
<p>再者，从<code>src.dataset</code>模块中引入<code>create_east_dataset()</code>方法，用于创建 EAST 数据集。</p>
<p>最后，从<code>src.lr_scheduler</code>模块中引入<code>get_lr()</code>方法，用于获取当前 epoch 的学习率。</p>
</blockquote>
<ol>
<li>
<p>设置 Parser 变量</p>
</li>
<li>
<p>设置分布式计算参数</p>
</li>
<li>
<p>设置 ModelArts 相关参数</p>
</li>
<li>
<p>设置相关路径（数据集、日志输出地址）</p>
</li>
<li>
<p>代码加速优化相关</p>
</li>
<li>
<p>加载模型</p>
</li>
<li>
<p>设置优化器</p>
</li>
<li>
<p>开始训练</p>
</li>
</ol>
<hr>
<p>​    先使用 Argparse 模块创建一个 ArgumentParser 对象，用于解析命令行参数。</p>
<p>​    <code>ArgumentParser('mindspore icdar training')</code>：创建一个 <code>ArgumentParser</code> 对象，并把 <code>'mindspore icdar training'</code> 作为参数传入，即设置程序的描述信息为 <code>mindspore icdar training</code>。</p>
<h5 id="parser-%E5%8F%98%E9%87%8F" tabindex="-1" id="Parser-变量">Parser 变量</h5>
<p><strong>设备</strong>相关：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>default</th>
<th>help</th>
</tr>
</thead>
<tbody>
<tr>
<td>–device_target</td>
<td>str</td>
<td>Ascend</td>
<td>device where the code will be implemented.</td>
</tr>
<tr>
<td>–device_id</td>
<td>int</td>
<td>0</td>
<td>device id where the model will be implemented.</td>
</tr>
</tbody>
</table>
<p><strong>数据集</strong>相关：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>default</th>
<th>help</th>
</tr>
</thead>
<tbody>
<tr>
<td>–data_dir</td>
<td>str</td>
<td>‘./data/icdar2015/Training/’</td>
<td>Train dataset directory.</td>
</tr>
<tr>
<td>–per_batch_size</td>
<td>int</td>
<td>8</td>
<td>Batch size for Training.</td>
</tr>
<tr>
<td>–outputs_dir</td>
<td>str</td>
<td>‘outputs/’</td>
<td>output dir.</td>
</tr>
</tbody>
</table>
<p><strong>神经网络</strong>相关：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>default</th>
<th>help</th>
</tr>
</thead>
<tbody>
<tr>
<td>–pretrained_backbone</td>
<td>str</td>
<td>‘./data/vgg/XXX.ckpt’</td>
<td>The ckpt file of ResNet.</td>
</tr>
<tr>
<td>–resume_east</td>
<td>str</td>
<td></td>
<td>The ckpt file of EAST, which used to fine tune. （模型微调）</td>
</tr>
</tbody>
</table>
<p><strong>优化器</strong>和<strong>学习率</strong>相关：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>default</th>
<th>help</th>
</tr>
</thead>
<tbody>
<tr>
<td>–lr_scheduler</td>
<td>str</td>
<td>‘my_lr’</td>
<td>Learning rate scheduler（学习率调整策略）, options: <strong>exponential</strong>（指数衰减）, <strong>cosine_annealing</strong>（余弦退火）. Default: cosine_annealing</td>
</tr>
<tr>
<td>–lr</td>
<td>float</td>
<td>0.001</td>
<td>Learning rate.</td>
</tr>
<tr>
<td>–per_step</td>
<td>float</td>
<td>2</td>
<td>Learning rate change times.</td>
</tr>
<tr>
<td>–lr_gamma</td>
<td>float</td>
<td>0.1</td>
<td>Decrease lr by a factor of <strong>exponential</strong> lr_scheduler.（将 lr 减少指数 lr_scheduler系数）</td>
</tr>
<tr>
<td>–eta_min</td>
<td>float</td>
<td>0.</td>
<td>Eta_min in <strong>cosine_annealing</strong> scheduler.</td>
</tr>
<tr>
<td>–t_max</td>
<td>int</td>
<td>100</td>
<td>T-max in <strong>cosine_annealing</strong> scheduler.</td>
</tr>
<tr>
<td>–max_epoch</td>
<td>int</td>
<td>600</td>
<td>Max epoch num to train the model.</td>
</tr>
<tr>
<td>–warmup_epochs</td>
<td>float(?)</td>
<td>6</td>
<td>Warmup epochs.</td>
</tr>
<tr>
<td>–weight_decay</td>
<td>float</td>
<td>0.0005</td>
<td>Weight decay factor.</td>
</tr>
</tbody>
</table>
<p><strong>损失函数</strong>相关：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>default</th>
<th>help</th>
</tr>
</thead>
<tbody>
<tr>
<td>–loss_scale</td>
<td>int</td>
<td>1</td>
<td>Static loss scale.（静态损失标度）</td>
</tr>
<tr>
<td>–resume_east</td>
<td>str</td>
<td>7,7</td>
<td>Epoch of changing of lr changing, split with “,”（改变 lr 的 epoch 变化，用 “，” 拆分）</td>
</tr>
</tbody>
</table>
<p><strong>日志</strong>相关：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>default</th>
<th>help</th>
</tr>
</thead>
<tbody>
<tr>
<td>–log_interval</td>
<td>int</td>
<td>10</td>
<td>Logging interval steps.（记录间隔步骤）</td>
</tr>
<tr>
<td>–ckpt_path</td>
<td>str</td>
<td>‘outputs/’</td>
<td>Checkpoint save location.</td>
</tr>
<tr>
<td>–ckpt_interval</td>
<td>int</td>
<td>1000（太大了吧，牛逼）</td>
<td>Save checkpoint interval.（保存检查点间隔）</td>
</tr>
<tr>
<td>–is_save_on_master</td>
<td>int</td>
<td>1</td>
<td>Save ckpt on master or all rank, 1 for master, 0 for all ranks.（这个 master 和 rank 应该跟分布式计算有关）</td>
</tr>
</tbody>
</table>
<p><strong>分布式计算</strong>相关：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>default</th>
<th>help</th>
</tr>
</thead>
<tbody>
<tr>
<td>–is_distributed</td>
<td>int</td>
<td>0</td>
<td>Distribute train or not, 1 for yes, 0 for no.</td>
</tr>
<tr>
<td>–rank</td>
<td>int</td>
<td>0</td>
<td>Local rank of distributed.</td>
</tr>
<tr>
<td>–group_size</td>
<td>int</td>
<td>1</td>
<td>World size of device.</td>
</tr>
</tbody>
</table>
<p>**profiler（性能分析器）**相关：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>default</th>
<th>help</th>
</tr>
</thead>
<tbody>
<tr>
<td>–need_profiler</td>
<td>int</td>
<td>0</td>
<td>Whether use profiler. 0 for no, 1 for yes.</td>
</tr>
</tbody>
</table>
<p><strong>modelArts</strong>相关：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>default</th>
<th>help</th>
</tr>
</thead>
<tbody>
<tr>
<td>–is_modelArts</td>
<td>int</td>
<td>0</td>
<td>Trainning in modelArts or not, 1 for yes, 0 for no.</td>
</tr>
</tbody>
</table>
<hr>
<h5 id="%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97" tabindex="-1" id="分布式计算">分布式计算</h5>
<p>这段代码主要是设置 Mindspore 的<strong>分布式计算</strong>的参数，我并不想动它。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">args, _ = parser.parse_known_args()<br>args.device_id = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">&quot;DEVICE_ID&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>))<br>args.rank = args.device_id<br><br>ms.set_context(mode=ms.GRAPH_MODE, device_target=args.device_target, device_id=args.device_id)<br><span class="hljs-keyword">if</span> args.is_distributed:<br>    comm.init()<br>    args.rank = comm.get_rank()<br>    args.group_size = comm.get_group_size()<br>    ms.set_auto_parallel_context(parallel_mode=ms.ParallelMode.DATA_PARALLEL, gradients_mean=<span class="hljs-literal">True</span>,<br>                                 device_num=args.group_size)<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="modelarts" tabindex="-1" id="ModelArts">ModelArts</h5>
<p><strong>ModelArts</strong> 相关的参数，但是我把它设为 0 依然能跑？</p>
<blockquote>
<p>这段代码主要是用于处理在华为云ModelArts平台上运行时的数据和模型路径。</p>
<p>首先判断<code>args.is_modelArts</code>是否为<code>True</code>，如果是，则意味着程序运行在华为云ModelArts平台上，需要对存储路径进行修改。</p>
<p>接着，导入<code>moxing</code>库，这个库是华为云针对ModelArts平台的Python SDK，提供了丰富的API用于读写数据、上传下载文件等操作。</p>
<p>然后，根据当前进程的编号（即<code>args.rank</code>变量）生成本地数据路径和本地模型路径，并将模型文件从远程路径（即<code>args.pretrained_backbone</code>）重命名为本地模型路径。</p>
<p>接下来，使用<code>mox.file.copy_parallel()</code>方法将数据从远程路径（即<code>args.data_dir</code>）拷贝到本地数据路径。</p>
<p>最后，将输出路径（即<code>args.outputs_dir</code>）设置为<code>/cache</code>目录下的子目录。在ModelArts平台上运行程序时，程序的输出也需要放在<code>/cache</code>目录下，以保证数据的持久化存储。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> args.is_modelArts:<br>    <span class="hljs-keyword">import</span> moxing <span class="hljs-keyword">as</span> mox<br><br>    local_data_url = os.path.join(<span class="hljs-string">&#x27;/cache/data&#x27;</span>, <span class="hljs-built_in">str</span>(args.rank))<br>    local_ckpt_url = os.path.join(<span class="hljs-string">&#x27;/cache/ckpt&#x27;</span>, <span class="hljs-built_in">str</span>(args.rank))<br>    local_ckpt_url = os.path.join(local_ckpt_url, <span class="hljs-string">&#x27;backbone.ckpt&#x27;</span>)<br><br>    mox.file.rename(args.pretrained_backbone, local_ckpt_url)<br>    args.pretrained_backbone = local_ckpt_url<br><br>    mox.file.copy_parallel(args.data_dir, local_data_url)<br>    args.data_dir = local_data_url<br><br>    args.outputs_dir = os.path.join(<span class="hljs-string">&#x27;/cache&#x27;</span>, args.outputs_dir)<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="%E7%9B%B8%E5%85%B3%E8%B7%AF%E5%BE%84" tabindex="-1" id="相关路径">相关路径</h5>
<p>设置<strong>相关路径</strong>（数据集、日志）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">args.data_root = os.path.abspath(os.path.join(args.data_dir, <span class="hljs-string">&#x27;image&#x27;</span>))<br>args.txt_root = os.path.abspath(os.path.join(args.data_dir, <span class="hljs-string">&#x27;groundTruth&#x27;</span>))<br><br><span class="hljs-comment"># 使用当前进程的编号（即 args.rank 变量）作为子目录名称，拼接成完整的输出文件夹路径</span><br>outputs_dir = os.path.join(args.outputs_dir, <span class="hljs-built_in">str</span>(args.rank))<br><span class="hljs-comment"># 获取当前时间作为子目录名称，再次拼接成完整的输出文件夹路径</span><br>args.outputs_dir = os.path.join(<br>    args.outputs_dir,<br>    datetime.datetime.now().strftime(<span class="hljs-string">&#x27;%Y-%m-%d_time_%H_%M_%S&#x27;</span>))<br>args.logger = get_logger(args.outputs_dir, args.rank)  <span class="hljs-comment"># 调用 get_logger()函数创建一个日志记录器，并将日志保存在 args.outputs_dir 目录下</span><br>args.logger.save_args(args)  <span class="hljs-comment"># 将所有参数保存在日志文件中</span><br></code></pre></td></tr></table></figure>
<hr>
<p><code>if __name__ == &quot;__main__&quot;:</code></p>
<h5 id="%E4%BC%98%E5%8C%96" tabindex="-1" id="优化">优化</h5>
<p>进行代码加速<strong>优化</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> args.need_profiler:<br>    <span class="hljs-comment"># 创建一个性能分析器，并将结果保存在args.outputs_dir路径下</span><br>    profiler = Profiler(<br>        output_path=args.outputs_dir,<br>        is_detail=<span class="hljs-literal">True</span>,<br>        is_show_op_path=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 创建一个AverageMeter对象用于记录损失值的平均值，以便后续输出和打印</span><br>loss_meter = AverageMeter(<span class="hljs-string">&#x27;loss&#x27;</span>)<br><br><span class="hljs-comment"># 重置自动并行上下文</span><br>context.reset_auto_parallel_context()<br>parallel_mode = ParallelMode.STAND_ALONE<br>degree = <span class="hljs-number">1</span><br><span class="hljs-comment"># 又是分布式计算相关……</span><br><span class="hljs-keyword">if</span> args.is_distributed:<br>    parallel_mode = ParallelMode.DATA_PARALLEL<br>    degree = args.group_size<br>context.set_auto_parallel_context(<br>    parallel_mode=parallel_mode,<br>    gradients_mean=<span class="hljs-literal">True</span>,<br>    device_num=degree)<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9E%8B" tabindex="-1" id="加载模型">加载模型</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python">network = EAST()  <span class="hljs-comment"># 设置 network，加载 EAST 模型</span><br><span class="hljs-comment"># default is kaiming-normal</span><br>default_recurisive_init(network)  <span class="hljs-comment"># 对 EAST 模型进行默认的递归初始化。这里使用的是 kaiming-normal（He 正态分布）初始化方法</span><br><br><span class="hljs-comment"># load pretrained_backbone</span><br><span class="hljs-keyword">if</span> args.pretrained_backbone:  <span class="hljs-comment"># 如果不为 None，载入预训练的 backbone 模型</span><br>    parm_dict = load_checkpoint(args.pretrained_backbone)  <span class="hljs-comment"># 加载模型参数</span><br>    load_param_into_net(network, parm_dict)  <span class="hljs-comment"># 将模型参数加载到 network 上</span><br>    args.logger.info(<span class="hljs-string">&#x27;finish load pretrained_backbone&#x27;</span>)  <span class="hljs-comment"># 在日志中记录加载完成的信息</span><br><br>network = EastWithLossCell(network)  <span class="hljs-comment"># 将 EAST 模型和损失函数进行结合，即将模型传入 EastWithLossCell()函数，得到组合后的模型对象</span><br><span class="hljs-keyword">if</span> args.resume_east:  <span class="hljs-comment"># 如果 args.resume_east 不为 None，继续训练之前保存的 EAST 模型，resume：恢复，继续</span><br>    param_dict = load_checkpoint(args.resume_east)<br>    load_param_into_net(network, param_dict)<br>    args.logger.info(<span class="hljs-string">&#x27;finish get resume east&#x27;</span>)<br><br>args.logger.info(<span class="hljs-string">&#x27;finish get network&#x27;</span>)<br><br><span class="hljs-comment"># 载入数据集，调用 create_east_dataset()函数，传入图片文件夹路径、文本文件夹路径、批量大小、设备数量、进程编号等参数，获取数据集以及数据总数，并在日志中记录加载完成的信息。</span><br>ds, data_size = create_east_dataset(img_root=args.data_root, txt_root=args.txt_root, batch_size=args.per_batch_size,<br>                                    device_num=args.group_size, rank=args.rank, is_training=<span class="hljs-literal">True</span>)<br>args.logger.info(<span class="hljs-string">&#x27;Finish loading dataset&#x27;</span>)<br><br><span class="hljs-comment"># 计算每个 epoch 中的步数，即将数据总数、批量大小和设备数量进行计算得到</span><br>args.steps_per_epoch = <span class="hljs-built_in">int</span>(<br>    data_size /<br>    args.per_batch_size /<br>    args.group_size)<br><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args.ckpt_interval:<br>    <span class="hljs-comment"># 如果 args.ckpt_interval 为空，则将其设置为每个 epoch 的步数</span><br>    args.ckpt_interval = args.steps_per_epoch<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="%E8%AE%BE%E7%BD%AE%E4%BC%98%E5%8C%96%E5%99%A8" tabindex="-1" id="设置优化器">设置优化器</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># get learnning rate</span><br>lr = get_lr(args)  <span class="hljs-comment"># 函数获取当前epoch的学习率，并将其赋值给变量lr</span><br>opt = Adam(  <span class="hljs-comment"># 使用Adam优化器进行优化，并指定优化器的参数为EAST模型中需要更新的参数</span><br>    params=get_param_groups(network),<br>    learning_rate=Tensor(<br>        lr,<br>        ms.float32))<br>loss_scale = FixedLossScaleManager(<span class="hljs-number">1.0</span>, drop_overflow_update=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 固定的损失缩放管理器</span><br>model = Model(network, optimizer=opt, loss_scale_manager=loss_scale)  <span class="hljs-comment"># 使用Model函数从EAST模型对象和优化器拼接出一个完整的训练模型，并将损失缩放管理器传入</span><br><span class="hljs-comment"># 这样就生成了完整的训练模型对象，并且可以对其进行训练</span><br></code></pre></td></tr></table></figure>
<hr>
<h5 id="%E8%AE%AD%E7%BB%83" tabindex="-1" id="训练">训练</h5>
<p>开始<strong>训练</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python">network.set_train()  <span class="hljs-comment"># 将网络设置为训练状态</span><br><span class="hljs-comment"># save the network model and parameters for subsequence fine-tuning</span><br><span class="hljs-comment"># 设置保存检查点的配置信息，包括保存检查点的步数和最大保存数量，并将其赋值给变量 config_ck</span><br>config_ck = CheckpointConfig(<br>    save_checkpoint_steps=<span class="hljs-number">100</span>,<br>    keep_checkpoint_max=<span class="hljs-number">1</span>)<br><span class="hljs-comment"># group layers into an object with training and evaluation features</span><br><span class="hljs-comment"># 指定模型参数保存路径</span><br>save_ckpt_path = os.path.join(<br>    args.outputs_dir, <span class="hljs-string">&#x27;ckpt_&#x27;</span> + <span class="hljs-built_in">str</span>(args.rank) + <span class="hljs-string">&#x27;/&#x27;</span>)<br><span class="hljs-comment"># 使用 ModelCheckpoint()函数创建一个回调函数，用于保存训练模型参数</span><br>ckpoint_cb = ModelCheckpoint(<br>    prefix=<span class="hljs-string">&quot;checkpoint_east&quot;</span>,<br>    directory=save_ckpt_path,<br>    config=config_ck)<br><span class="hljs-comment"># 创建一个回调函数，用于保存训练模型参数。其中，prefix 参数指定保存文件名的前缀，directory 参数指定保存路径，config 参数指定保存配置信息。</span><br>callback = [<br>    TimeMonitor(data_size=data_size),<br>    LossMonitor(),<br>    ckpoint_cb<br>]<br><span class="hljs-comment"># 调用 model.train()方法对训练模型进行训练，传入总 epoch 数、数据集以及之前定义的回调函数列表。在训练过程中，启用了数据集下沉模式，即 dataset_sink_mode=True，以提高训练效率</span><br>model.train(<br>    args.max_epoch,<br>    ds,<br>    callbacks=callback,<br>    dataset_sink_mode=<span class="hljs-literal">True</span>)<br>args.logger.info(<span class="hljs-string">&#x27;==========end training===============&#x27;</span>)<br></code></pre></td></tr></table></figure>
<h4 id="src%2Futil.py" tabindex="-1" id="src-util-py">src/util.py</h4>
<p>定义了一些工具人类和函数，看不懂 orz：</p>
<ul>
<li><code>class AverageMeter</code>：记录各个指标的训练过程中的平均值和当前值</li>
<li><code>default_wd_filter()</code>：定义了一个默认的权重衰减过滤器函数，过滤掉不需要进行权重衰减的参数，例如偏置项和批归一化层中的偏置项和权重</li>
<li><code>get_param_groups()</code>：接受一个神经网络模型<code>network</code>作为参数，并将其可训练参数分成有权重衰减和无权重衰减两个组，并返回一个包含参数组信息的列表，每个参数组都包含<code>params</code>和<code>weight_decay</code>两个键值对</li>
<li><code>class ShapeRecord</code>：记录图像大小的类</li>
</ul>
<h4 id="src%2Feast.py" tabindex="-1" id="src-east-py">src/east.py</h4>
<h5 id="class-east" tabindex="-1" id="class-EAST">class EAST</h5>
<p>定义了一个 EAST 网络的类 <code>EAST</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EAST</span>(nn.Cell):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(EAST, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-comment"># 提取图像特征的模块，返回 5 组特征图用于后续处理</span><br>        <span class="hljs-variable language_">self</span>.extractor = VGG16FeatureExtraction()<br>        <span class="hljs-comment"># 将特征图组合的模块，将 5 组特征图拼接在一起，形成更为丰富多样的特征信息用于后续处理</span><br>        <span class="hljs-variable language_">self</span>.merge = Merge()<br>        <span class="hljs-comment"># 输出模块，对拼接后的特征图进行卷积处理来得到文本区域预测分数 score 和几何信息预测值 geo</span><br>        <span class="hljs-variable language_">self</span>.output = Output()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, x_1</span>):<br>        <span class="hljs-comment"># 通过 x_1 输入数据调用 self.extractor()获取 5 组特征图</span><br>        f_0, f_1, f_2, f_3, f_4 = <span class="hljs-variable language_">self</span>.extractor(x_1)<br>        <span class="hljs-comment"># 将这些特征图传入 self.merge()模块进行拼接，得到拼接后的特征图</span><br>        x_1 = <span class="hljs-variable language_">self</span>.merge(f_0, f_1, f_2, f_3, f_4)<br>        <span class="hljs-comment"># 将该特征图输入到 self.output()模块获得文本区域预测分数 score 和几何信息预测值 geo</span><br>        score, geo = <span class="hljs-variable language_">self</span>.output(x_1)<br><br>        <span class="hljs-keyword">return</span> score, geo<br></code></pre></td></tr></table></figure>
<p><img src="T1.png" alt="png"></p>
<p>代码对应的就是论文里的三个部分了：</p>
<ul>
<li><code>Feature extractor stem (PVANet)</code> - <code>class VGG16FeatureExtraction</code>
<ul>
<li>提取图像特征的模块，返回 5 组特征图用于后续处理</li>
</ul>
</li>
<li><code>Feature-merging branch</code> - <code>class Merge</code>
<ul>
<li>将特征图组合的模块，将 5 组特征图拼接在一起，形成更为丰富多样的特征信息用于后续处理</li>
</ul>
</li>
<li><code>Output layer</code> - <code>class Output</code>
<ul>
<li>输出模块，对拼接后的特征图进行卷积处理来得到文本区域预测分数<code>score</code>和几何信息预测值<code>geo</code></li>
</ul>
</li>
</ul>
<hr>
<h5 id="class-vgg16featureextraction" tabindex="-1" id="class-VGG16FeatureExtraction">class VGG16FeatureExtraction</h5>
<p>大致就是定义了一堆卷积核，然后按照论文里的方式一阵卷，返回 5 组特征图，但是特征图的标号好像跟论文里是反着来的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VGG16FeatureExtraction</span>(nn.Cell):<br>    <span class="hljs-string">&quot;&quot;&quot;VGG16FeatureExtraction for deeptext&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(VGG16FeatureExtraction, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.relu = nn.ReLU()<br>        <span class="hljs-variable language_">self</span>.max_pool = nn.MaxPool2d(kernel_size=<span class="hljs-number">2</span>, stride=<span class="hljs-number">2</span>)<br>        <span class="hljs-variable language_">self</span>.avg_pool = nn.AvgPool2d(kernel_size=<span class="hljs-number">2</span>, stride=<span class="hljs-number">2</span>)<br><br>        <span class="hljs-variable language_">self</span>.conv1_1 = _conv(<br>            in_channels=<span class="hljs-number">3</span>,<br>            out_channels=<span class="hljs-number">64</span>,<br>            kernel_size=<span class="hljs-number">3</span>,<br>            padding=<span class="hljs-number">1</span>)<br><br>        ……<br>        <br>        <span class="hljs-variable language_">self</span>.conv5_3 = _conv(<br>            in_channels=<span class="hljs-number">512</span>,<br>            out_channels=<span class="hljs-number">512</span>,<br>            kernel_size=<span class="hljs-number">3</span>,<br>            padding=<span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.cast = P.Cast()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, out</span>):<br>        <span class="hljs-string">&quot;&quot;&quot; Construction of VGG &quot;&quot;&quot;</span><br>        f_0 = out<br>        out = <span class="hljs-variable language_">self</span>.cast(out, mstype.float32)<br>        out = <span class="hljs-variable language_">self</span>.conv1_1(out)<br>        out = <span class="hljs-variable language_">self</span>.relu(out)<br>        out = <span class="hljs-variable language_">self</span>.conv1_2(out)<br>        out = <span class="hljs-variable language_">self</span>.relu(out)<br>        out = <span class="hljs-variable language_">self</span>.max_pool(out)<br><br>		……<br><br>        out = <span class="hljs-variable language_">self</span>.max_pool(out)<br>        f_4 = out<br>        out = <span class="hljs-variable language_">self</span>.conv5_1(out)<br>        out = <span class="hljs-variable language_">self</span>.relu(out)<br>        out = <span class="hljs-variable language_">self</span>.conv5_2(out)<br>        out = <span class="hljs-variable language_">self</span>.relu(out)<br>        out = <span class="hljs-variable language_">self</span>.conv5_3(out)<br>        out = <span class="hljs-variable language_">self</span>.relu(out)<br>        out = <span class="hljs-variable language_">self</span>.max_pool(out)<br>        f_5 = out<br><br>        <span class="hljs-keyword">return</span> f_0, f_2, f_3, f_4, f_5<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="class-merge" tabindex="-1" id="class-Merge">class Merge</h5>
<blockquote>
<p><code>P</code>是 MindSpore 中的一个模块，代表了运算符(operators)。我们可以通过<code>import mindspore.ops as P</code>来引入这个模块，从而使用其中定义的各种运算符函数，例如上述代码中使用的<code>Concat()</code>和<code>ResizeBilinear()</code>函数。</p>
</blockquote>
<p>也是定义一堆函数：</p>
<ul>
<li><code>ResizeBilinear()</code>：是 MindSpore 中的一个图像处理函数，在图像上进行双线性插值，将输入图像缩放到指定大小。由于该模型中需要特征融合操作，因此使用该函数将不同尺度的特征图调整到相同尺寸，便于进行特征拼接。</li>
<li><code>concat()</code>：特征图拼接</li>
<li><code>nn.BatchNorm2d(128)</code>：是 MindSpore 中的一个二维批归一化函数，用于对网络模型中的卷积层或全连接层的输出进行归一化处理，以便更好地协调不同神经元之间的协同工作。</li>
<li><code>relu()</code>：激活函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Merge</span>(nn.Cell):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(Merge, <span class="hljs-variable language_">self</span>).__init__()<br><br>        <span class="hljs-variable language_">self</span>.conv1 = nn.Conv2d(<span class="hljs-number">1024</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>, has_bias=<span class="hljs-literal">True</span>)<br>        <span class="hljs-variable language_">self</span>.bn1 = nn.BatchNorm2d(<span class="hljs-number">128</span>)<br>        <span class="hljs-variable language_">self</span>.relu1 = nn.ReLU()<br>        <span class="hljs-variable language_">self</span>.conv2 = nn.Conv2d(<br>            <span class="hljs-number">128</span>,<br>            <span class="hljs-number">128</span>,<br>            <span class="hljs-number">3</span>,<br>            padding=<span class="hljs-number">1</span>,<br>            pad_mode=<span class="hljs-string">&#x27;pad&#x27;</span>,<br>            has_bias=<span class="hljs-literal">True</span>)<br>        <span class="hljs-variable language_">self</span>.bn2 = nn.BatchNorm2d(<span class="hljs-number">128</span>)<br>        <span class="hljs-variable language_">self</span>.relu2 = nn.ReLU()<br><br>		……<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, x, f1, f2, f3, f4</span>):<br>        img_hight = P.Shape()(x)[<span class="hljs-number">2</span>]<br>        img_width = P.Shape()(x)[<span class="hljs-number">3</span>]<br><br>        out = P.ResizeBilinear((img_hight / <span class="hljs-number">16</span>, img_width / <span class="hljs-number">16</span>), <span class="hljs-literal">True</span>)(f4)<br>        out = <span class="hljs-variable language_">self</span>.concat((out, f3))<br>        out = <span class="hljs-variable language_">self</span>.relu1(<span class="hljs-variable language_">self</span>.bn1(<span class="hljs-variable language_">self</span>.conv1(out)))<br>        out = <span class="hljs-variable language_">self</span>.relu2(<span class="hljs-variable language_">self</span>.bn2(<span class="hljs-variable language_">self</span>.conv2(out)))<br><br>        out = P.ResizeBilinear((img_hight / <span class="hljs-number">8</span>, img_width / <span class="hljs-number">8</span>), <span class="hljs-literal">True</span>)(out)<br>        out = <span class="hljs-variable language_">self</span>.concat((out, f2))<br>        out = <span class="hljs-variable language_">self</span>.relu3(<span class="hljs-variable language_">self</span>.bn3(<span class="hljs-variable language_">self</span>.conv3(out)))<br>        out = <span class="hljs-variable language_">self</span>.relu4(<span class="hljs-variable language_">self</span>.bn4(<span class="hljs-variable language_">self</span>.conv4(out)))<br><br>        out = P.ResizeBilinear((img_hight / <span class="hljs-number">4</span>, img_width / <span class="hljs-number">4</span>), <span class="hljs-literal">True</span>)(out)<br>        out = <span class="hljs-variable language_">self</span>.concat((out, f1))<br>        out = <span class="hljs-variable language_">self</span>.relu5(<span class="hljs-variable language_">self</span>.bn5(<span class="hljs-variable language_">self</span>.conv5(out)))<br>        out = <span class="hljs-variable language_">self</span>.relu6(<span class="hljs-variable language_">self</span>.bn6(<span class="hljs-variable language_">self</span>.conv6(out)))<br><br>        out = <span class="hljs-variable language_">self</span>.relu7(<span class="hljs-variable language_">self</span>.bn7(<span class="hljs-variable language_">self</span>.conv7(out)))<br>        <span class="hljs-keyword">return</span> out<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="class-output" tabindex="-1" id="class-Output">class Output</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Output</span>(nn.Cell):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, scope=<span class="hljs-number">512</span></span>):<br>        <span class="hljs-built_in">super</span>(Output, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.conv1 = nn.Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.sigmoid1 = nn.Sigmoid()<br>        <span class="hljs-variable language_">self</span>.conv2 = nn.Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.sigmoid2 = nn.Sigmoid()<br>        <span class="hljs-variable language_">self</span>.conv3 = nn.Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.sigmoid3 = nn.Sigmoid()<br>        <span class="hljs-variable language_">self</span>.scope = scope<br>        <span class="hljs-variable language_">self</span>.concat = P.Concat(axis=<span class="hljs-number">1</span>)<br>        <span class="hljs-variable language_">self</span>.PI = <span class="hljs-number">3.1415926535898</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, x</span>):<br>        score = <span class="hljs-variable language_">self</span>.sigmoid1(<span class="hljs-variable language_">self</span>.conv1(x))  <span class="hljs-comment"># 文本区域得分</span><br>        loc = <span class="hljs-variable language_">self</span>.sigmoid2(<span class="hljs-variable language_">self</span>.conv2(x)) * <span class="hljs-variable language_">self</span>.scope  <span class="hljs-comment"># 位置</span><br>        angle = (<span class="hljs-variable language_">self</span>.sigmoid3(<span class="hljs-variable language_">self</span>.conv3(x)) - <span class="hljs-number">0.5</span>) * <span class="hljs-variable language_">self</span>.PI  <span class="hljs-comment"># 倾斜角度</span><br>        geo = <span class="hljs-variable language_">self</span>.concat((loc, angle))  <span class="hljs-comment"># 边界框信息包含位置和倾斜角度</span><br>        <span class="hljs-keyword">return</span> score, geo  <span class="hljs-comment"># 最终返回文本区域得分和拼接后的边界框信息</span><br></code></pre></td></tr></table></figure>
<hr>
<h5 id="class-eastlossblock" tabindex="-1" id="class-EastLossBlock">class EastLossBlock</h5>
<blockquote>
<p>在该模块计算损失时，首先计算分类损失，即将预测得到的文本区域得分与真实标注的文本区域得分进行比较，采用 Dice 系数计算分类损失。</p>
<p>接着，将预测得到的位置信息和真实标注的位置信息分别拆分出来，通过计算交并比（IoU）和角度误差得到位置损失，最终通过加权平均作为总体的位置损失。其中，角度误差使用余弦相似度计算。</p>
<p>在计算位置损失时，还需考虑训练集中的样本是否为真实文本区域，需将训练集中非文本区域处的位置信息、分类标注和对应的模型预测结果剔除掉，以避免这些数据对损失计算的干扰。</p>
<p>最后将分类损失和位置损失加权求和，作为总体损失并返回。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EastLossBlock</span>(nn.Cell):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(EastLossBlock, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.split = P.Split(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)<br>        <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">min</span> = MyMin()<br>        <span class="hljs-variable language_">self</span>.log = P.Log()<br>        <span class="hljs-variable language_">self</span>.cos = P.Cos()<br>        <span class="hljs-variable language_">self</span>.mean = P.ReduceMean(keep_dims=<span class="hljs-literal">False</span>)<br>        <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">sum</span> = P.ReduceSum()<br>        <span class="hljs-variable language_">self</span>.eps = <span class="hljs-number">1e-5</span><br>        <span class="hljs-variable language_">self</span>.dice = DiceCoefficient()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params"></span><br><span class="hljs-params">            self,</span><br><span class="hljs-params">            y_true_cls,</span><br><span class="hljs-params">            y_pred_cls,</span><br><span class="hljs-params">            y_true_geo,</span><br><span class="hljs-params">            y_pred_geo,</span><br><span class="hljs-params">            training_mask</span>):<br>        ans = <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">sum</span>(y_true_cls)<br>        <span class="hljs-comment"># 将预测得到的文本区域得分与真实标注的文本区域得分进行比较，采用 Dice 系数计算分类损失</span><br>        classification_loss = <span class="hljs-variable language_">self</span>.dice(<br>            y_true_cls, y_pred_cls * (<span class="hljs-number">1</span> - training_mask))<br><br>        <span class="hljs-comment"># n * 5 * h * w</span><br>        <span class="hljs-comment"># 将预测得到的位置信息和真实标注的位置信息分别拆分出来</span><br>        d1_gt, d2_gt, d3_gt, d4_gt, theta_gt = <span class="hljs-variable language_">self</span>.split(y_true_geo)<br>        d1_pred, d2_pred, d3_pred, d4_pred, theta_pred = <span class="hljs-variable language_">self</span>.split(y_pred_geo)<br>        area_gt = (d1_gt + d3_gt) * (d2_gt + d4_gt)<br>        area_pred = (d1_pred + d3_pred) * (d2_pred + d4_pred)<br>        w_union = <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">min</span>(d2_gt, d2_pred) + <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">min</span>(d4_gt, d4_pred)<br>        h_union = <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">min</span>(d1_gt, d1_pred) + <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">min</span>(d3_gt, d3_pred)<br><br>        area_intersect = w_union * h_union<br>        area_union = area_gt + area_pred - area_intersect<br>        <span class="hljs-comment"># 通过计算交并比（IoU）和角度误差得到位置损失</span><br>        iou_loss_map = -<span class="hljs-variable language_">self</span>.log((area_intersect + <span class="hljs-number">1.0</span>) /<br>                                 (area_union + <span class="hljs-number">1.0</span>))  <span class="hljs-comment"># iou_loss_map</span><br>        angle_loss_map = <span class="hljs-number">1</span> - <span class="hljs-variable language_">self</span>.cos(theta_pred - theta_gt)  <span class="hljs-comment"># angle_loss_map</span><br>		<br>        <span class="hljs-comment"># 角度误差使用余弦相似度计算</span><br>        angle_loss = <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">sum</span>(angle_loss_map * y_true_cls) / ans<br>        iou_loss = <span class="hljs-variable language_">self</span>.<span class="hljs-built_in">sum</span>(iou_loss_map * y_true_cls) / ans<br>        geo_loss = <span class="hljs-number">10</span> * angle_loss + iou_loss<br><br>        <span class="hljs-keyword">return</span> geo_loss + classification_loss<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="class-eastwithlosscell" tabindex="-1" id="class-EastWithLossCell">class EastWithLossCell</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EastWithLossCell</span>(nn.Cell):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, network</span>):<br>        <span class="hljs-built_in">super</span>(EastWithLossCell, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-comment"># 传入一个EAST模型，作为计算图中的网络模块</span><br>        <span class="hljs-variable language_">self</span>.east_network = network<br>        <span class="hljs-comment"># 实例化了EastLossBlock类，作为计算图中的损失函数模块</span><br>        <span class="hljs-variable language_">self</span>.loss = EastLossBlock()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, img, true_cls, true_geo, training_mask</span>):<br>        <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        img: 输入图片</span><br><span class="hljs-string">        true_cls: 分类标注</span><br><span class="hljs-string">        true_geo: 位置标注</span><br><span class="hljs-string">        training_mask: 训练集中的掩码（用于过滤掉非真实文本区域的数据）</span><br><span class="hljs-string">        &#x27;&#x27;&#x27;</span><br>        <span class="hljs-comment"># 调用计算图进行前向计算</span><br>        socre, geometry = <span class="hljs-variable language_">self</span>.east_network(img)<br>        <span class="hljs-comment"># 将计算得到的分类得分和位置信息分别传给损失函数模块进行后向计算，得到整体的损失值并返回</span><br>        loss = <span class="hljs-variable language_">self</span>.loss(<br>            true_cls,<br>            socre,<br>            true_geo,<br>            geometry,<br>            training_mask)<br>        <span class="hljs-keyword">return</span> loss<br></code></pre></td></tr></table></figure>
<hr>
<h4 id="src%2Fdataset.py" tabindex="-1" id="src-dataset-py">src/dataset.py</h4>
<h5 id="create_east_dataset()" tabindex="-1" id="create-east-dataset">create_east_dataset()</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_east_dataset</span>(<span class="hljs-params"></span><br><span class="hljs-params">        img_root,</span><br><span class="hljs-params">        txt_root,</span><br><span class="hljs-params">        batch_size,</span><br><span class="hljs-params">        device_num,</span><br><span class="hljs-params">        rank,</span><br><span class="hljs-params">        is_training=<span class="hljs-literal">True</span></span>):<br>    <span class="hljs-comment"># 实例化 ICDAREASTDataset 类，传入图片和文本标注的路径，用于读取并解析图像和标注</span><br>    east_data = ICDAREASTDataset(img_path=img_root, gt_path=txt_root)<br>    <span class="hljs-comment"># 生成分布式采样器，用于在多个设备之间对数据进行划分和分发。</span><br>    distributed_sampler = DistributedSampler(<br>        <span class="hljs-built_in">len</span>(east_data), device_num, <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> device_num == <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> rank, shuffle=<span class="hljs-literal">True</span>)<br><br>    trans_list = [CV.RandomColorAdjust(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.25</span>),  <span class="hljs-comment"># 随机改变图像的颜色饱和度、对比度和亮度</span><br>                  CV.Rescale(<span class="hljs-number">1</span> / <span class="hljs-number">255.0</span>, <span class="hljs-number">0</span>),  <span class="hljs-comment"># 对图像进行缩放</span><br>                  CV.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)),  <span class="hljs-comment"># 图像正则化处理</span><br>                  CV.HWC2CHW()]  <span class="hljs-comment"># 将图像的通道维度从 HWC（高×宽×通道数）顺序转换为 CHW（通道数×高×宽）顺序</span><br>    <span class="hljs-keyword">if</span> is_training:  <span class="hljs-comment"># 如果是训练模式</span><br>        dataset_column_names = [<br>            <span class="hljs-string">&quot;image&quot;</span>,  <span class="hljs-comment"># 图像</span><br>            <span class="hljs-string">&quot;score_map&quot;</span>,  <span class="hljs-comment"># 分类标注分数图</span><br>            <span class="hljs-string">&quot;geo_map&quot;</span>,  <span class="hljs-comment"># 位置标注几何图</span><br>            <span class="hljs-string">&quot;training_mask&quot;</span>]  <span class="hljs-comment"># 训练集掩码</span><br>        <span class="hljs-comment"># 调用 MindSpore 中的 GeneratorDataset 类生成数据集</span><br>        ds = de.GeneratorDataset(<br>            east_data,<br>            column_names=dataset_column_names,<br>            num_parallel_workers=<span class="hljs-number">32</span>,  <span class="hljs-comment"># 数据处理和增强过程中使用的并行线程数</span><br>            <span class="hljs-comment"># sampler 参数则指定了数据采样器，即从数据集中选择数据样本的方式，</span><br>            <span class="hljs-comment"># 本例中使用的是前面提到的分布式采样器 distributed_sampler</span><br>            sampler=distributed_sampler)<br>        <span class="hljs-comment"># 调用 map()方法将数据集中的图像列传入变换列表中的操作进行增广</span><br>        ds = ds.<span class="hljs-built_in">map</span>(<br>            operations=trans_list,<br>            input_columns=[<span class="hljs-string">&quot;image&quot;</span>],<br>            num_parallel_workers=<span class="hljs-number">8</span>,<br>            python_multiprocessing=<span class="hljs-literal">True</span>)<br>        <span class="hljs-comment"># 使用 batch()方法将批量大小对数据集进行划分</span><br>        ds = ds.batch(batch_size, num_parallel_workers=<span class="hljs-number">8</span>, drop_remainder=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">return</span> ds, <span class="hljs-built_in">len</span>(east_data)<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="class-icdareastdataset" tabindex="-1" id="class-ICDAREASTDataset">class ICDAREASTDataset</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ICDAREASTDataset</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, img_path, gt_path, scale=<span class="hljs-number">0.25</span>, length=<span class="hljs-number">512</span></span>):<br>        <span class="hljs-built_in">super</span>(ICDAREASTDataset, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.img_files = [os.path.join(<br>            img_path,<br>            img_file) <span class="hljs-keyword">for</span> img_file <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(os.listdir(img_path))]<br>        <span class="hljs-variable language_">self</span>.gt_files = [<br>            os.path.join(<br>                gt_path,<br>                gt_file) <span class="hljs-keyword">for</span> gt_file <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(<br>                    os.listdir(gt_path))]<br>        <span class="hljs-variable language_">self</span>.scale = scale  <span class="hljs-comment"># 缩放比例</span><br>        <span class="hljs-variable language_">self</span>.length = length  <span class="hljs-comment"># 裁剪后的图像长度</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, index</span>):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-variable language_">self</span>.gt_files[index], <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            lines = f.readlines()<br>        vertices, labels = extract_vertices(lines)  <span class="hljs-comment"># 从文本标注中提取文本区域的顶点坐标和标注</span><br><br>        img = Image.<span class="hljs-built_in">open</span>(<span class="hljs-variable language_">self</span>.img_files[index])  <span class="hljs-comment"># 读取图像</span><br>        img, vertices = adjust_height(img, vertices)  <span class="hljs-comment"># 调整高度</span><br>        img, vertices = rotate_img(img, vertices)  <span class="hljs-comment"># 随机旋转图像</span><br>        img, vertices = crop_img(img, vertices, labels, <span class="hljs-variable language_">self</span>.length)  <span class="hljs-comment"># 将图像切割成指定长度的大小</span><br>        score_map, geo_map, ignored_map = get_score_geo(<br>            img, vertices, labels, <span class="hljs-variable language_">self</span>.scale, <span class="hljs-variable language_">self</span>.length)  <span class="hljs-comment"># 分类标注分数图、位置标注几何图和忽略标注</span><br>        score_map = score_map.transpose(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br>        ignored_map = ignored_map.transpose(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br>        geo_map = geo_map.transpose(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> np.<span class="hljs-built_in">sum</span>(score_map) &lt; <span class="hljs-number">1</span>:<br>            score_map[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> img, score_map, geo_map, ignored_map<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.img_files)<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="extract_vertices()" tabindex="-1" id="extract-vertices">extract_vertices()</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_vertices</span>(<span class="hljs-params">lines</span>):<br>    <span class="hljs-string">&#x27;&#x27;&#x27;extract vertices info from txt lines</span><br><span class="hljs-string">    Input:</span><br><span class="hljs-string">      lines   : list of string info 输入是一个字符串列表 lines，其中每个字符串包含了一个文本区域的信息，包括顶点坐标和标签等</span><br><span class="hljs-string">    Output:</span><br><span class="hljs-string">      vertices: vertices of text regions &lt;numpy.ndarray, (n,8)&gt;  所有文本区域的顶点坐标</span><br><span class="hljs-string">      labels  : 1-&gt;valid, 0-&gt;ignore, &lt;numpy.ndarray, (n,)&gt;  标签</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    labels = []  <span class="hljs-comment"># 存储最终的标签</span><br>    vertices = []  <span class="hljs-comment"># 存储顶点信息</span><br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:<br>        <span class="hljs-comment"># 通过 rstrip()和 lstrip()函数去除其前后空格和 BOM（Byte Order Mark）等特殊字符，并使用 split()函数将其切分为一个包含八个整数的列表</span><br>        vertices.append(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">int</span>, line.rstrip(<span class="hljs-string">&#x27;\n&#x27;</span>).lstrip(<span class="hljs-string">&#x27;\ufeff&#x27;</span>).split(<span class="hljs-string">&#x27;,&#x27;</span>)[:<span class="hljs-number">8</span>])))<br>        label = <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;###&#x27;</span> <span class="hljs-keyword">in</span> line <span class="hljs-keyword">else</span> <span class="hljs-number">1</span><br>        labels.append(label)<br>    <span class="hljs-comment"># 返回顶点和标签的 numpy 数组</span><br>    <span class="hljs-keyword">return</span> np.array(vertices), np.array(labels)<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="adjust_height()" tabindex="-1" id="adjust-height">adjust_height()</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_height</span>(<span class="hljs-params">img, vertices, ratio=<span class="hljs-number">0.2</span></span>):<br>    <span class="hljs-string">&#x27;&#x27;&#x27;adjust height of image to aug data</span><br><span class="hljs-string">    Input:</span><br><span class="hljs-string">      img         : PIL Image</span><br><span class="hljs-string">      vertices    : vertices of text regions &lt;numpy.ndarray, (n,8)&gt;</span><br><span class="hljs-string">      ratio       : height changes in [0.8, 1.2]</span><br><span class="hljs-string">    Output:</span><br><span class="hljs-string">      img         : adjusted PIL Image</span><br><span class="hljs-string">      new_vertices: adjusted vertices</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    ratio_h = <span class="hljs-number">1</span> + ratio * (np.random.rand() * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>)  <span class="hljs-comment"># 随机调整输入图像的高度</span><br>    old_h = img.height<br>    <span class="hljs-comment"># 根据输入的高度缩放比例ratio_h，计算调整后的图像新高度new_h。</span><br>    <span class="hljs-comment"># 原始图像的高度由变量old_h指定，通过乘以缩放比例并四舍五入取整来得到调整后的高度。</span><br>    <span class="hljs-comment"># np.around()函数是NumPy库中的一个函数，用于对数组进行四舍五入，其默认精度为0</span><br>    new_h = <span class="hljs-built_in">int</span>(np.around(old_h * ratio_h))<br>    img = img.resize((img.width, new_h), Image.BILINEAR)<br><br>    new_vertices = vertices.copy()<br>    <span class="hljs-keyword">if</span> vertices.size &gt; <span class="hljs-number">0</span>:<br>        new_vertices[:, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>]] = vertices[:, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>]] * (new_h / old_h)<br>    <span class="hljs-comment"># 返回调整后的图像和更新后的顶点坐标</span><br>    <span class="hljs-keyword">return</span> img, new_vertices<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="rotate_img()" tabindex="-1" id="rotate-img">rotate_img()</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">rotate_img</span>(<span class="hljs-params">img, vertices, angle_range=<span class="hljs-number">10</span></span>):<br>    <span class="hljs-string">&#x27;&#x27;&#x27;rotate image [-10, 10] degree to aug data</span><br><span class="hljs-string">    Input:</span><br><span class="hljs-string">      img         : PIL Image</span><br><span class="hljs-string">      vertices    : vertices of text regions &lt;numpy.ndarray, (n,8)&gt;</span><br><span class="hljs-string">      angle_range : rotate range</span><br><span class="hljs-string">    Output:</span><br><span class="hljs-string">      img         : rotated PIL Image</span><br><span class="hljs-string">      new_vertices: rotated vertices</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-comment"># 获得中心旋转点</span><br>    center_x = (img.width - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span><br>    center_y = (img.height - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span><br>    angle = angle_range * (np.random.rand() * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># 使用了 BILINEAR 滤波器来进行图像插值，以获得更好的旋转效果</span><br>    img = img.rotate(angle, Image.BILINEAR)<br>    <span class="hljs-comment"># 定义一个大小为 vertices.shape 的全零 NumPy 数组 new_vertices，用于存储旋转后的顶点坐标</span><br>    new_vertices = np.zeros(vertices.shape)<br>    <span class="hljs-keyword">for</span> i, vertice <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(vertices):<br>        <span class="hljs-comment"># 遍历每个文本区域的顶点坐标，调用 rotate_vertices()函数来计算旋转后的新坐标，然后将其保存到 new_vertices 中</span><br>        new_vertices[i, :] = rotate_vertices(<br>            vertice, -angle / <span class="hljs-number">180</span> * math.pi, np.array([[center_x], [center_y]]))<br>    <span class="hljs-keyword">return</span> img, new_vertices<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="crop_img()" tabindex="-1" id="crop-img">crop_img()</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">crop_img</span>(<span class="hljs-params">img, vertices, labels, length</span>):<br>    <span class="hljs-string">&#x27;&#x27;&#x27;crop img patches to obtain batch and augment</span><br><span class="hljs-string">    Input:</span><br><span class="hljs-string">      img         : PIL Image</span><br><span class="hljs-string">      vertices    : vertices of text regions &lt;numpy.ndarray, (n,8)&gt;</span><br><span class="hljs-string">      labels      : 1-&gt;valid, 0-&gt;ignore, &lt;numpy.ndarray, (n,)&gt;</span><br><span class="hljs-string">      length      : length of cropped image region</span><br><span class="hljs-string">    Output:</span><br><span class="hljs-string">      region      : cropped image region</span><br><span class="hljs-string">      new_vertices: new vertices in cropped region</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-comment"># 获取原始图像的高度h和宽度w</span><br>    h, w = img.height, img.width<br>    <span class="hljs-comment"># confirm the shortest side of image &gt;= length</span><br>    <span class="hljs-comment"># 如果其中较小的一边小于指定的裁剪长度，则使用PIL库提供的resize()方法将图像缩放到相应的大小</span><br>    <span class="hljs-keyword">if</span> h &gt;= w <span class="hljs-keyword">and</span> w &lt; length:<br>        img = img.resize((length, <span class="hljs-built_in">int</span>(h * length / w)), Image.BILINEAR)<br>    <span class="hljs-keyword">elif</span> h &lt; w <span class="hljs-keyword">and</span> h &lt; length:<br>        img = img.resize((<span class="hljs-built_in">int</span>(w * length / h), length), Image.BILINEAR)<br>    ratio_w = img.width / w<br>    ratio_h = img.height / h<br>    <span class="hljs-keyword">assert</span> (ratio_w &gt;= <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> ratio_h &gt;= <span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 如果其中较小的一边小于指定的裁剪长度，则使用PIL库提供的resize()方法将图像缩放到相应的大小</span><br>    new_vertices = np.zeros(vertices.shape)<br>    <span class="hljs-keyword">if</span> vertices.size &gt; <span class="hljs-number">0</span>:<br>        new_vertices[:, [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>]] = vertices[:, [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>]] * ratio_w<br>        new_vertices[:, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>]] = vertices[:, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>]] * ratio_h<br><br>    <span class="hljs-comment"># find random position</span><br>    <span class="hljs-comment"># 生成随机的裁剪位置，检查裁剪区域是否与文本区域相交，避免将裁剪区域中的文本区域遮盖或截断</span><br>    remain_h = img.height - length<br>    remain_w = img.width - length<br>    flag = <span class="hljs-literal">True</span><br>    cnt = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> flag <span class="hljs-keyword">and</span> cnt &lt; <span class="hljs-number">1000</span>:<br>        <span class="hljs-comment"># 若随机裁剪的位置与文本区域有交集，则继续生成新的随机位置，</span><br>        <span class="hljs-comment"># 直到找到一个合适的位置或者超过最大尝试次数1000次为止</span><br>        cnt += <span class="hljs-number">1</span><br>        start_w = <span class="hljs-built_in">int</span>(np.random.rand() * remain_w)<br>        start_h = <span class="hljs-built_in">int</span>(np.random.rand() * remain_h)<br>        flag = is_cross_text([start_w, start_h], length,<br>                             new_vertices[labels == <span class="hljs-number">1</span>, :])<br>    box = (start_w, start_h, start_w + length, start_h + length)<br>    <span class="hljs-comment"># 使用PIL库提供的crop()方法从原始图像中截取指定大小的区域，并将其作为本函数的输出返回。</span><br>    region = img.crop(box)<br>    <span class="hljs-keyword">if</span> new_vertices.size == <span class="hljs-number">0</span>:<br>        <span class="hljs-comment"># 如果不存在任何文本区域，则直接返回裁剪后的图像区域和空的新顶点坐标</span><br>        <span class="hljs-keyword">return</span> region, new_vertices<br>    <span class="hljs-comment"># 更新文本区域的顶点坐标。将新的裁剪图像左上角的坐标(start_w, start_h)作为原点，计算相对于这个原点的顶点坐标，并将这个相对坐标赋值给new_vertices</span><br>    new_vertices[:, [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>]] -= start_w<br>    new_vertices[:, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>]] -= start_h<br>    <span class="hljs-keyword">return</span> region, new_vertices<br></code></pre></td></tr></table></figure>
<hr>
<h4 id="eval.py" tabindex="-1" id="eval-py"><a target="_blank" rel="noopener" href="http://eval.py">eval.py</a></h4>
<p>先使用 argparse 设置一堆参数：</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>default</th>
<th>help</th>
</tr>
</thead>
<tbody>
<tr>
<td>–device_target</td>
<td>str</td>
<td>‘Ascend’</td>
<td>evice where the code will be implemented. (Default: Ascend)</td>
</tr>
<tr>
<td>–device_num</td>
<td>int</td>
<td>5</td>
<td>设备数，如果只有 1 个设备的话，设成 5 不能跑，设成 0 能跑</td>
</tr>
<tr>
<td>–test_img_path</td>
<td>str</td>
<td>‘./data/icdar2015/Test/images/’</td>
<td>测试集地址</td>
</tr>
<tr>
<td>–checkpoint_path</td>
<td>str</td>
<td></td>
<td>模型地址</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">context.set_context(<br>    mode=context.GRAPH_MODE,  <span class="hljs-comment"># 图模式</span><br>    device_target=args.device_target,  <span class="hljs-comment"># 设备类型</span><br>    save_graphs=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 是否保存计算图</span><br>    device_id=args.device_num)  <span class="hljs-comment"># 设备编号</span><br></code></pre></td></tr></table></figure>
<hr>
<h5 id="main" tabindex="-1" id="main">main</h5>
<p>设置一下模型、数据集、保存路径、开跑！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    model_name = args.checkpoint_path<br>    test_img_path = args.test_img_path<br>    submit_path = <span class="hljs-string">&#x27;./submit&#x27;</span><br>    eval_model(model_name, test_img_path, submit_path)<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="eval_model()" tabindex="-1" id="eval-model">eval_model()</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">eval_model</span>(<span class="hljs-params">name, img_path, submit, save_flag=<span class="hljs-literal">True</span></span>):<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    name: 模型的 checkpoint 文件路径</span><br><span class="hljs-string">    img_path: 测试集图片所在的文件夹路径</span><br><span class="hljs-string">    submit: 输出结果保存的文件夹路径</span><br><span class="hljs-string">    save_flag: 是否保存中间结果</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-comment"># 判断输出结果保存的目录是否存在，如果存在则删除该目录及其子目录，然后重新创建一个同名目录</span><br>    <span class="hljs-keyword">if</span> os.path.exists(submit):<br>        shutil.rmtree(submit)<br>    os.mkdir(submit)<br>    <span class="hljs-comment"># 构建 EAST 模型</span><br>    network = EAST()<br>    <span class="hljs-comment"># 加载预训练权重参数</span><br>    param_dict = load_checkpoint(name)<br>    load_param_into_net(network, param_dict)<br>    <span class="hljs-comment"># 设置模型为训练模式</span><br>    network.set_train(<span class="hljs-literal">True</span>)<br><br>    start_time = time.time()<br>    <span class="hljs-comment"># 调用 detect_dataset()函数对测试集图片进行检测，并将检测结果保存到指定的输出目录 submit 中</span><br>    detect_dataset(network, img_path, submit)<br>    os.chdir(submit)<br>    res = subprocess.getoutput(<span class="hljs-string">&#x27;zip -q submit.zip *.txt&#x27;</span>)<br>    res = subprocess.getoutput(<span class="hljs-string">&#x27;mv submit.zip ../&#x27;</span>)<br>    os.chdir(<span class="hljs-string">&#x27;../&#x27;</span>)<br>    <span class="hljs-comment"># 调用评估脚本./evaluate/script.py 来计算模型的性能指标，评估结果保存在字符串变量 res 中</span><br>    res = subprocess.getoutput(<br>        <span class="hljs-string">&#x27;python ./evaluate/script.py -g=./evaluate/gt.zip -s=./submit.zip&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(res)<br>    os.remove(<span class="hljs-string">&#x27;./submit.zip&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;eval time is &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(time.time() - start_time))<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> save_flag:<br>        <span class="hljs-comment"># 如果 save_flag 为 False，则删除输出目录及其子目录（闻到了屎山的味道）</span><br>        shutil.rmtree(submit)<br></code></pre></td></tr></table></figure>
<hr>
<h4 id="detect.py" tabindex="-1" id="detect-py"><a target="_blank" rel="noopener" href="http://detect.py">detect.py</a></h4>
<h5 id="detect_dataset()" tabindex="-1" id="detect-dataset">detect_dataset()</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_dataset</span>(<span class="hljs-params">model, test_img_path, submit_path</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    detection on whole dataset, save .txt results in submit_path</span><br><span class="hljs-string">        Input:</span><br><span class="hljs-string">                model        : detection model 模型实例</span><br><span class="hljs-string">                device       : gpu if gpu is available</span><br><span class="hljs-string">                test_img_path: dataset path 测试图片所在文件夹的路径</span><br><span class="hljs-string">                submit_path  : submit result for evaluation 提交结果保存路径</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 读取测试集中所有的图片，并按照文件名排序</span><br>    img_files = os.listdir(test_img_path)<br>    img_files = <span class="hljs-built_in">sorted</span>([os.path.join(test_img_path, img_file)<br>                        <span class="hljs-keyword">for</span> img_file <span class="hljs-keyword">in</span> img_files])<br><br>    <span class="hljs-keyword">for</span> i, img_file <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(img_files):<br>        <span class="hljs-comment"># 对于每一张图片，调用detect()函数进行目标检测，返回目标框的坐标信息</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;evaluating &#123;&#125; image&#x27;</span>.<span class="hljs-built_in">format</span>(i), end=<span class="hljs-string">&#x27;\r&#x27;</span>)<br>        boxes = detect(Image.<span class="hljs-built_in">open</span>(img_file), model)<br>        seq = []<br>        <span class="hljs-keyword">if</span> boxes <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-comment"># 如果检测结果不为空，则将框的坐标信息转换成符合要求的字符串序列并加入到列表seq中</span><br>            seq.extend([<span class="hljs-string">&#x27;,&#x27;</span>.join([<span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(b))<br>                                  <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> box[:-<span class="hljs-number">1</span>]]) + <span class="hljs-string">&#x27;\n&#x27;</span> <span class="hljs-keyword">for</span> box <span class="hljs-keyword">in</span> boxes])<br>        <span class="hljs-comment"># 将序列seq保存为与当前图片名称相同的.txt文件格式，并将其写入submit_path目录下</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(os.path.join(submit_path, <span class="hljs-string">&#x27;res_&#x27;</span> +<br>                               os.path.basename(img_file).replace(<span class="hljs-string">&#x27;.jpg&#x27;</span>, <span class="hljs-string">&#x27;.txt&#x27;</span>)), <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            f.writelines(seq)  <span class="hljs-comment"># 当检测完成后，输出log信息提示检测进度</span><br></code></pre></td></tr></table></figure>
<hr>
<h5 id="detect()" tabindex="-1" id="detect">detect()</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">detect</span>(<span class="hljs-params">img, model</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;detect text regions of img using model</span><br><span class="hljs-string">        Input:</span><br><span class="hljs-string">                img   : PIL Image</span><br><span class="hljs-string">                model : detection model</span><br><span class="hljs-string">                device: gpu if gpu is available</span><br><span class="hljs-string">        Output:</span><br><span class="hljs-string">                detected polys</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 将输入图片进行尺寸调整与相应的 ratio 变换，得到调整后的图片、高宽比例 ratio_h 和 ratio_w</span><br>    img, ratio_h, ratio_w = resize_img(img)<br>    <span class="hljs-comment"># 利用模型对调整后的图片进行文字区域检测，得到概率图 score 和文本框参数 geo</span><br>    score, geo = model(load_pil(img))<br>    <span class="hljs-comment"># 对概率图和文本框参数使用 PaddlePaddle 中的 Squeeze()函数进行维度降低（由 4 维转为 3 维）</span><br>    score = P.Squeeze(<span class="hljs-number">0</span>)(score)<br>    geo = P.Squeeze(<span class="hljs-number">0</span>)(geo)<br>    <span class="hljs-comment"># 从降维后的概率图和文本框参数中获取文本框坐标信息，即调用 get_boxes()函数</span><br>    boxes = get_boxes(score.asnumpy(), geo.asnumpy())<br>    <span class="hljs-comment"># 根据之前的高宽比例 ratio_h 和 ratio_w，调整并计算出检测到的文本框在原始图片上的坐标信息，即调用 adjust_ratio()函数</span><br>    <span class="hljs-keyword">return</span> adjust_ratio(boxes, ratio_w, ratio_h)<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="get_boxes()" tabindex="-1" id="get-boxes">get_boxes()</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_boxes</span>(<span class="hljs-params">score, geo, score_thresh=<span class="hljs-number">0.9</span>, nms_thresh=<span class="hljs-number">0.2</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;get boxes from feature map</span><br><span class="hljs-string">        Input:</span><br><span class="hljs-string">                score       : score map from model &lt;numpy.ndarray, (1,row,col)&gt; 概率图</span><br><span class="hljs-string">                geo         : geo map from model &lt;numpy.ndarray, (5,row,col)&gt; 文本框参数</span><br><span class="hljs-string">                score_thresh: threshold to segment score map 置信度阈值</span><br><span class="hljs-string">                nms_thresh  : threshold in nms 非极大值抑制阈值</span><br><span class="hljs-string">        Output:</span><br><span class="hljs-string">                boxes       : final polys &lt;numpy.ndarray, (n,9)&gt;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 对输入的score进行降维，即将其转化为二维数组</span><br>    score = score[<span class="hljs-number">0</span>, :, :]<br>    <span class="hljs-comment"># 在降维后的score数组中，找到大于score_thresh的点，并以(r,c)的格式记录下来，形成一个n x 2的矩阵xy_text</span><br>    xy_text = np.argwhere(score &gt; score_thresh)  <span class="hljs-comment"># n x 2, format is [r, c]</span><br>    <span class="hljs-comment"># 按行排序xy_text，以保证前面的点在结果中优先考虑</span><br>    <span class="hljs-keyword">if</span> xy_text.size == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 将xy_text中的坐标信息转化为正确的x,y坐标（由于降维之前是按行major的顺序排列，因此需要将列号作为x坐标，行号作为y坐标）</span><br>    xy_text = xy_text[np.argsort(xy_text[:, <span class="hljs-number">0</span>])]<br>    valid_pos = xy_text[:, ::-<span class="hljs-number">1</span>].copy()  <span class="hljs-comment"># n x 2, [x, y]</span><br>    <span class="hljs-comment"># 从降维后的geo数组中提取出与xy_text中相应位置点相关的文本框参数，形成5 x n的矩阵valid_geo</span><br>    valid_geo = geo[:, xy_text[:, <span class="hljs-number">0</span>], xy_text[:, <span class="hljs-number">1</span>]]  <span class="hljs-comment"># 5 x n</span><br>    <span class="hljs-comment"># 利用restore_polys()函数将valid_pos和valid_geo还原为文本框的坐标点集polys_restored，并得到对应的索引值index</span><br>    polys_restored, index = restore_polys(valid_pos, valid_geo, score.shape)<br>    <span class="hljs-keyword">if</span> polys_restored.size == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 将polys_restored表示为(n,8)大小的数组，其中前8列分别为文本框像素点的坐标，第9列为该文本框的置信度（即所在score map中的值）</span><br>    boxes = np.zeros((polys_restored.shape[<span class="hljs-number">0</span>], <span class="hljs-number">9</span>), dtype=np.float32)<br>    boxes[:, :<span class="hljs-number">8</span>] = polys_restored<br>    boxes[:, <span class="hljs-number">8</span>] = score[xy_text[index, <span class="hljs-number">0</span>], xy_text[index, <span class="hljs-number">1</span>]]<br>    <span class="hljs-comment"># 对polys_restored执行非极大值抑制（NMS）操作，得到最终的文本框坐标信息boxes</span><br>    boxes = lanms.merge_quadrangle_n9(boxes.astype(<span class="hljs-string">&#x27;float32&#x27;</span>), nms_thresh)<br>    <span class="hljs-keyword">return</span> boxes<br></code></pre></td></tr></table></figure>
<hr>
<h5 id="adjust_ratio()" tabindex="-1" id="adjust-ratio">adjust_ratio()</h5>
<p>根据之前的高宽比例 ratio_h 和 ratio_w，调整并计算出检测到的文本框在原始图片上的坐标信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_ratio</span>(<span class="hljs-params">boxes, ratio_w, ratio_h</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;refine boxes</span><br><span class="hljs-string">        Input:</span><br><span class="hljs-string">                boxes  : detected polys &lt;numpy.ndarray, (n,9)&gt;</span><br><span class="hljs-string">                ratio_w: ratio of width</span><br><span class="hljs-string">                ratio_h: ratio of height</span><br><span class="hljs-string">        Output:</span><br><span class="hljs-string">                refined boxes</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> boxes <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> boxes.size == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    boxes[:, [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>]] /= ratio_w<br>    boxes[:, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>]] /= ratio_h<br>    <span class="hljs-keyword">return</span> np.around(boxes)<br></code></pre></td></tr></table></figure>
<h3 id="%E8%B7%91%EF%BC%81" tabindex="-1" id="跑！">跑！</h3>
<ol>
<li>变更一个 mindspore 2.0 的镜像，太旧的 mindspore 会寄……</li>
</ol>
<p><img src="M1.png" alt="png"></p>
<ol start="2">
<li>从 <a target="_blank" rel="noopener" href="https://gitee.com/mindspore/models/tree/master/research/cv/east">EAST for Ascend - Gitee.com</a> 把仓库整下来，最好整到 <code>work/</code> 文件夹里，这样服务器重启过后数据还能保留。训练这玩意还需要：</li>
</ol>
<ul>
<li>
<p>Dataset: ICDAR 2015: Focused Scene Text，这个数据集，1000 张训练集，500 张测试集</p>
<ul>
<li>
<p>从 <a target="_blank" rel="noopener" href="https://rrc.cvc.uab.es/?ch=4&amp;com=downloads">Downloads - Incidental Scene Text - Robust Reading Competition (uab.es)</a> 里下</p>
<p><img src="M2_1.png" alt="png"></p>
</li>
</ul>
</li>
<li>
<p>The <code>pretrained_path</code> should be a checkpoint of vgg16 trained on Imagenet2012. vgg 在 Imagenet2012 里预训练过的模型，它还不给下载地址，让我找老半天，哼</p>
<ul>
<li>
<p>从 <a target="_blank" rel="noopener" href="https://mindspore.cn/">MindSpore 官网</a> - 资源 - Hub 搜索 <code>vgg16</code>，找到 <a target="_blank" rel="noopener" href="https://mindspore.cn/resources/hub/details?MindSpore/1.9/vgg16_imagenet2012">下载地址</a>，下载 <code>vgg16_ascend_v190_imagenet2012_official_cv_top1acc73.49_top5acc91.56.ckpt</code></p>
<p><img src="M2_2.png" alt="png"></p>
</li>
</ul>
</li>
</ul>
<ol start="3">
<li>调整仓库里的 parser 参数、数据集的位置和预训练模型的位置，使得路径对应一致。</li>
</ol>
<blockquote>
<p>In this project, the file organization is recommended as below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.<br>└─data<br>  ├─icdar2015<br>    ├─Training                           # Training set<br>      ├─image                            # Images in training set<br>      ├─groundTruth                      # GT in training set<br>    └─Test                               # Test set<br>      ├─image                            # Images in training set<br>      ├─groundTruth                      # GT in training set<br></code></pre></td></tr></table></figure>
</blockquote>
<p><img src="M3.png" alt="png"></p>
<ol start="4">
<li>安装环境一条龙！<code>requirements.txt</code> 里面的玩意着实难装，还是手动装好了……</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">source activate base  # 第一次进服务器激活需要 activate base<br>python -c &quot;import mindspore;mindspore.run_check()&quot;  # 查看 mindspore 版本<br>conda create -n east --clone base  # 克隆 base 环境<br>conda activate east  # 激活 east 环境<br>pip install numpy<br>pip install opencv-python<br>pip install shapely<br>pip install pillow<br>pip install lanms-neo<br>pip install --upgrade setuptools  # 更新 setuptools<br>pip install Polygon3  # 这个库很难装，可能需要更新 setuptools<br>pip install onnxruntime<br></code></pre></td></tr></table></figure>
<p>​    装好环境后可以保存一下镜像，这样下次重开服务器的时候就会保留之前安装好的环境：</p>
<p><img src="M4.png" alt="png"></p>
<ol start="5">
<li>切到仓库目录，开跑 <code>train.py</code>！</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /home/ma-user/work/east/<br>python3 train.py<br></code></pre></td></tr></table></figure>
<p><img src="M5_1.png" alt="png"></p>
<p>​    显示完超参数后，就开始 train 了，继续等呗。</p>
<p><img src="M5_2.png" alt="png"></p>
<ol start="6">
<li>训练时间从 <code>14:27</code> 到 <code>18:41</code>，就能炼出仙丹一枚：<code>checkpoint_east-600_125.ckpt</code></li>
</ol>
<p><img src="M6.png" alt="png"></p>
<ol start="7">
<li>设置一下 <code>eval.py</code> 的参数：</li>
</ol>
<ul>
<li><code>--device_num</code> Ascend 设备的数量，因为我只租了 1 个，所以设为 0</li>
<li><code>--test_img_path</code> 测试集路径，evaluate 时会读取这里面的图片</li>
<li><code>--checkpoint_path</code> 模型的路径，把它设为刚刚炼好的仙丹的路径：<code>outputs/2023-05-15_time_14_27_25/ckpt_0/checkpoint_east-600_125.ckpt</code></li>
</ul>
<p><img src="M7.png" alt="png"></p>
<ol start="8">
<li>
<blockquote>
<p>The evaluation scripts are from <a href="https://gitee.com/link?target=http%3A%2F%2Frrc.cvc.uab.es%2F%3Fch%3D4%26com%3Dmymethods%26task%3D1">ICDAR Offline evaluation</a> and have been modified to run successfully with Python 3.7.1.</p>
</blockquote>
<p>从上面这个链接里下载 <code>script_test_ch4_t1_e1-1577983151.zip</code>，并放在 <code>evaluate/</code>中：</p>
<p><img src="M8.png" alt="png"></p>
</li>
<li>
<p>开跑 <code>eval.py</code>！</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python3 eval.py<br></code></pre></td></tr></table></figure>
<p>​    然后就能在 <code>submit\</code> 里查看评估结果，和 ground truth 参考一下，能识别一点点东西。</p>
<p><img src="M9.png" alt="png"></p>
<p>​    返回出来的效果比它宣传的要差好多啊，呜呜呜……</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">Calculated!&#123;&quot;precision&quot;: 0.527431421446384, &quot;recall&quot;: 0.6109773712084737, &quot;hmean&quot;: 0.566138746375195, &quot;AP&quot;: 0&#125;<br></code></pre></td></tr></table></figure>

            </article>
            
	<div class="rightside">
	
		<div class="rightside-button" id="js-aside">
			<span>
				<img no-lazy src="/images/icon/aside.png" class="rightside-button-icon" alt="Icon">
			</span>
		</div>
		<script>
			$("#js-aside").click(function () {
				onShowAsideButton();
			});
		</script>
	
	<div class="rightside-button" id="js-toggle_theme">
		<span>
			<img no-lazy src="/images/icon/toggle_theme.png" class="rightside-button-icon" alt="Icon">
		</span>
	</div>

	
<script src="/js/plugins/goto_position.js"></script>

	
	<div class="rightside-button" id="js-go_top">
		<span>
			<img no-lazy src="/images/icon/go_top.png" class="rightside-button-icon" alt="Icon">
		</span>
	</div>
	<div class="rightside-button" id="js-go_bottom">
		<span>
			<img no-lazy src="/images/icon/go_bottom.png" class="rightside-button-icon" alt="Icon">
		</span>
	</div>

	<script>
		setToggleThemeButtonListener();
	</script>
	<script>
		$('#js-go_top')
		.gotoPosition( {
			speed: 300,
			target: 'top',
		} );
		$('#js-go_bottom')
		.gotoPosition( {
			speed: 300,
			target: 'bottom',
		} );
	</script>
</div>


<div class="post-bottom">
    
        <div class="post-paging">     
            <div class="post-paging-last">
                
                    <a href="/posts/ML-%E6%9D%8E%E5%AE%8F%E6%AF%85-%E6%AD%A3%E7%A2%BA%E8%AA%8D%E8%AD%98%20ChatGPT/">
                        上一篇：ML-李宏毅-正確認識 ChatGPT
                    </a>
                
            </div>
            <div class="post-paging-next">
                
                    <a href="/posts/Diary-%E6%A2%85%E5%BC%80%E4%BA%8C%E5%BA%A6%E7%9A%84%E7%AC%AC%2011%20%E5%91%A8%E5%92%8C%E7%AC%AC%2012%20%E5%91%A8/">
                        下一篇：Diary-梅开二度的第 11 周和第 12 周
                    </a>
                
            </div>
        </div>
    
    
    
        
            <div class="giscus comments"></div>
            <script>
                var scriptElement = document.createElement('script');
                scriptElement.src = 'https://giscus.app/client.js';
                scriptElement.setAttribute('data-repo', 'GZ-Metal-Cell/GZ-Metal-Cell.github.io');
                scriptElement.setAttribute('data-repo-id', 'R_kgDOIHLEOQ');
                scriptElement.setAttribute('data-category', 'Announcements');
                scriptElement.setAttribute('data-category-id', 'DIC_kwDOIHLEOc4CcVwP');
                scriptElement.setAttribute('data-mapping', 'title');
                scriptElement.setAttribute('data-strict', '1');
                scriptElement.setAttribute('data-reactions-enabled', '');
                scriptElement.setAttribute('data-emit-metadata', '0');
                scriptElement.setAttribute('data-input-position', 'bottom');
                scriptElement.setAttribute('data-theme', localStorage.getItem('theme') === 'light' ? 'light' : 'dark_high_contrast');
                scriptElement.setAttribute('data-lang', 'zh-CN');
                
                scriptElement.setAttribute('crossorigin', 'anonymous');
                scriptElement.async = true;
                document.head.appendChild(scriptElement);
            </script>
        
    
</div>
        </div>
    </main>
    
        <aside class="main-aside">
    
<script src="/js/widgets/aside.js"></script>

    <script>
        showAside();
    </script>

    <div class="aside-top">
        <div class="aside-top-about aside-card">
            <a href="/about" class="aside-top-about-portrait">
                <img no-lazy src="/about/portrait.png" alt="Q">
            </a>
            <div class="aside-top-about-info">
                <span class="author"> Zi-Zi</span>
                <span class="description">不以物喜，不以己悲。</span>
            </div>              
            <div class="aside-top-about-site">
                <a href="/categories" class="aside-top-about-site-item">
                    <span class="title">类别</span>
                    <span class="count">5</span>
                </a>
                <a href="/tags" class="aside-top-about-site-item">
                    <span class="title">标签</span>
                    <span class="count">120</span>
                </a>
                <a href="/archives" class="aside-top-about-site-item">
                    <span class="title">归档</span>
                    <span class="count">435</span>
                </a>
            </div>
            <div class="aside-top-about-contact">
                
                    
                        <a target="_blank" rel="noopener" href="https://weibo.com/u/5020307235">
                            <img no-lazy src="/images/bottom_icon/Weibo.webp" alt="Quieter">
                        </a>
                    
                        <a target="_blank" rel="noopener" href="https://tieba.baidu.com/home/main?id=tb.1.ff6d2775.vFH7wrdW2ZjPCmyBHJcjnA">
                            <img no-lazy src="/images/bottom_icon/Tieba.webp" alt="Quieter">
                        </a>
                    
                        <a target="_blank" rel="noopener" href="https://space.bilibili.com/11547880">
                            <img no-lazy src="/images/bottom_icon/Bilibili.webp" alt="Quieter">
                        </a>
                    
                        <a target="_blank" rel="noopener" href="https://github.com/GZ-Metal-Cell">
                            <img no-lazy src="/images/bottom_icon/github.webp" alt="Quieter">
                        </a>
                    
                
            </div>
        </div> 

        
    </div>

    <div class="aside-bottom">
        
            <script>
                
                    const tocCollapsed = true;
                
                
                    const tocDepth = 6;
                
                var headerString = '';
                for (let i = 1; i <= tocDepth; i++) {
                    if (i === 1) {
                        headerString += 'h1';
                    } else {
                        headerString += ', h' + i;
                    }
                }
                hbeToc();
            </script>
            <div class="aside-bottom-toc aside-card">
                <div class="aside-bottom-toc-title">
                    <h1>目录</h1>
                    <span class="toc-percentage"></span>
                </div>
                <ol class="aside-bottom-toc-content"></ol>
            </div>
        
    </div>
</aside>
    
</div>
		<footer>
	<div class="content">
		
			<span>©2022-2025&nbsp;By&nbsp;<a href="/about">Zi-Zi</a>.</span>
		
		<span><a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> theme by <a target="_blank" rel="noopener" href="https://github.com/GZ-Metal-Cell/hexo-theme-quieter">Quieter</a>.</span>
		
			<span style="display: flex;">
				<img no-lazy alt="icp" src="/images/icp_icon.png" style="width: 16px; height: 16px;">
				<a href="https://icp.gov.moe/?keyword=20241647" target="_blank">萌 ICP 备 20241647 号</a>
			</span>
		
	</div>

	
<script src="/js/plugins/ref.js"></script>

	
<script src="/js/plugins/highlight_tools.js"></script>

	<script>
		const  COPY_ICON = "/images/icon/copy.png";
		const CLOSE_CODE_BLOCK_ICON = "/images/icon/close_code_block.png";
		const HIGHLIGHT_SHRINK = "";
		const HIGHLIGHT_HEIGHT_LIMIT = "";
	</script>

	
	
	<!-- Analytics -->

    
        <!-- Busuanzi Analytics -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
        <!-- Baidu Analytics -->
        <script defer>
            var _hmt = _hmt || [];
            (function () {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?e57cf62289f84322ebff116e8b3d343e";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
    


	

	
		
			
				<link rel="stylesheet" href="/css/plugins/katex/katex.min.css">
				<script src="/js/plugins/copy-tex.js"></script>
			
		
	

    
		
<link rel="stylesheet" href="/css/plugins/textIndent.css">

		
<script src="/js/plugins/textIndent.js"></script>

	

	
	
	
		<script>
			if (typeof init === 'function') {
				init();
			}
		</script>
	

	
		
	

	

	<!--
		
<script src="/js/plugins/jquery.pjax.min.js"></script>

		<script>
			$(document).pjax('a[target!=_blank]', 'main', {
				fragment: 'main',
				timeout: 8000
			});

			$(document).on('pjax:complete', function() {
			});
		</script> 
	-->
	<script>
		console.log('\n %c Hexo-Quieter 主题 %c https://github.com/GZ-Metal-Cell/hexo-theme-quieter \n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;')
	</script>
</footer>
	</body>

	<!-- Hexo-Quieter 主题  https://github.com/GZ-Metal-Cell/hexo-theme-quieter -->
</html>

