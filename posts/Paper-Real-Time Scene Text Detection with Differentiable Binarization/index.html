<!DOCTYPE html>
<html lang=zh-CN data-theme="light">
	
<script src="/js/plugins/toggleTheme.js"></script>

	<script>
		setTheme();
	</script>
	<head>
		
<title>Paper-Real-Time Scene Text Detection with Differentiable Binarization | Zi-Zi's Journey</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/images/icon/favicon.ico">
<link href="/css/plugins/print.css" media="print" rel="stylesheet" />

<link rel="stylesheet" href="/css/index.css">



<meta name="keywords" content="Python,论文,实验相关,MindSpore,文本检测,代码复现,">
<meta name="description" content="论文阅读。">



<script src="/js/plugins/jquery.min.js"></script>


<script src="/js/plugins/hljs.min.js"></script>


<script src="/js/plugins/init.js"></script>


<script src="/js/plugins/hide.js"></script>


<script src="/js/plugins/tabs.js"></script>



    



    
<script src="/js/plugins/alert-title.js"></script>

    
<link rel="stylesheet" href="/css/plugins/github-alerts/github-base.css">

    
<link rel="stylesheet" href="/css/plugins/github-alerts/github-colors-dark-class.css">

    
<link rel="stylesheet" href="/css/plugins/github-alerts/github-colors-light.css">






    

	<meta name="generator" content="Hexo 6.1.0"></head>

	<body>
		<header class="sticky-header">
	<nav>
		<div class="nav-left">
			<a href="/" class="logo">
				<img no-lazy src="/images/headers_icon/logo.webp" alt="Quieter">
			</a>
			<ul class="breadcrumb" id="breadcrumb"></ul>
		</div>
		<div class="nav-right">
			<ul>
				
					<li>
						<a href="/">
						  主页
						</a>
					</li>
				
					<li>
						<a href="/categories">
						  类别
						</a>
					</li>
				
					<li>
						<a href="/tags">
						  标签
						</a>
					</li>
				
					<li>
						<a href="/archives">
						  归档
						</a>
					</li>
				
					<li>
						<a href="/galleries">
						  相册
						</a>
					</li>
				
					<li>
						<a href="/links">
						  链接
						</a>
					</li>
				
					<li>
						<a href="/about">
						  关于
						</a>
					</li>
								  
			</ul>
		</div>
		<div class="nav-right-close">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
				<path fill="none" d="M0 0h24v24H0z" />
				<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
			</svg>
		</div>

		<div class="sidebar">
    <div class="topo">
        <p>Zi-Zi's Journey</p>
    </div>
    <ul>
        
        <li>
            <a href="/">
                主页
            </a>
        </li>
        
        <li>
            <a href="/categories">
                类别
            </a>
        </li>
        
        <li>
            <a href="/tags">
                标签
            </a>
        </li>
        
        <li>
            <a href="/archives">
                归档
            </a>
        </li>
        
        <li>
            <a href="/galleries">
                相册
            </a>
        </li>
        
        <li>
            <a href="/links">
                链接
            </a>
        </li>
        
        <li>
            <a href="/about">
                关于
            </a>
        </li>
        
    </ul>
    <div class="sidebar-footer">
        
        <a target="_blank" rel="noopener" href="https://weibo.com/u/5020307235">
            <img no-lazy src="/images/bottom_icon/Weibo.webp" alt="Quieter">
        </a>
        
        <a target="_blank" rel="noopener" href="https://tieba.baidu.com/home/main?id=tb.1.ff6d2775.vFH7wrdW2ZjPCmyBHJcjnA">
            <img no-lazy src="/images/bottom_icon/Tieba.webp" alt="Quieter">
        </a>
        
        <a target="_blank" rel="noopener" href="https://space.bilibili.com/11547880">
            <img no-lazy src="/images/bottom_icon/Bilibili.webp" alt="Quieter">
        </a>
        
        <a target="_blank" rel="noopener" href="https://github.com/GZ-Metal-Cell">
            <img no-lazy src="/images/bottom_icon/github.webp" alt="Quieter">
        </a>
        
    </div>
</div>
<div class='shelter'>
    <script>
        $(function() {
            $('.nav-right-close > svg').click(function() {
                $('.sidebar').animate({
                    right: "0"
                }, 500);
                $('.shelter').fadeIn("slow");
            
                var element = $('.topo');
                element.addClass('custom-style');
            
                var links = null;
                if ("") {
                    links = "".split(',');
                } else {
                    links = "/images/random_top_img/01.webp,/images/random_top_img/02.webp,/images/random_top_img/03.webp,/images/random_top_img/04.webp,/images/random_top_img/05.webp,/images/random_top_img/06.webp,/images/random_top_img/07.webp,/images/random_top_img/08.webp,/images/random_top_img/09.webp,/images/random_top_img/10.webp,/images/random_top_img/11.webp,/images/random_top_img/12.webp,/images/random_top_img/13.webp,/images/random_top_img/14.webp,/images/random_top_img/15.webp,/images/random_top_img/16.webp,/images/random_top_img/17.webp,/images/random_top_img/18.webp,/images/random_top_img/19.webp,/images/random_top_img/20.webp,/images/random_top_img/21.webp,/images/random_top_img/22.webp,/images/random_top_img/23.webp,/images/random_top_img/24.webp,/images/random_top_img/25.webp,/images/random_top_img/26.webp,/images/random_top_img/27.webp,/images/random_top_img/28.webp,/images/random_top_img/29.webp,/images/random_top_img/30.webp,/images/random_top_img/31.webp,/images/random_top_img/32.webp,/images/random_top_img/33.webp,/images/random_top_img/34.webp,/images/random_top_img/35.webp,/images/random_top_img/36.webp,/images/random_top_img/37.webp,/images/random_top_img/38.webp,/images/random_top_img/39.webp,/images/random_top_img/40.webp,/images/random_top_img/41.webp,/images/random_top_img/42.webp,/images/random_top_img/43.webp,/images/random_top_img/44.webp,/images/random_top_img/45.webp,/images/random_top_img/46.webp,/images/random_top_img/47.webp,/images/random_top_img/48.webp,/images/random_top_img/49.webp,/images/random_top_img/50.webp,/images/random_top_img/51.webp,/images/random_top_img/52.webp,/images/random_top_img/53.webp,/images/random_top_img/54.webp,/images/random_top_img/55.webp,/images/random_top_img/56.webp,/images/random_top_img/57.webp".split(',');
                }
            
                var randomLink = links[Math.floor(Math.random() * links.length)];
                element.css('background-image', "url('" + randomLink + "')");
            });
          
            $('.shelter').click(function(e) {
                $('.sidebar').animate({
                    right: "-100%"
                }, 500);
                $('.shelter').fadeOut("slow");
            });
        });      
    </script>
</div>
	</nav>

	
		<div class="header-background"></div>
	

	<script>
		const name = 'post';
		const ul = document.querySelectorAll('.nav-right ul')[0];
		const lis = ul.querySelectorAll('li');

		if (name == 'home') {
			lis[0].classList.add('select');
		} else {
			for (let i = 0; i < lis.length; i++) {
				const li = lis[i];
				const a = li.querySelector('a');
				if (name === a.href.split('/')[3]) {
					li.classList.add('select');
				}
			}
		}
	</script>
	
	<script>
		var element = document.querySelector('.header-background');
		if(element) {
			element.classList.add('custom-style');
			var links = null;
			if("")
			{
				links = "".split(',');
			} else
			{
				links = "/images/random_top_img/01.webp,/images/random_top_img/02.webp,/images/random_top_img/03.webp,/images/random_top_img/04.webp,/images/random_top_img/05.webp,/images/random_top_img/06.webp,/images/random_top_img/07.webp,/images/random_top_img/08.webp,/images/random_top_img/09.webp,/images/random_top_img/10.webp,/images/random_top_img/11.webp,/images/random_top_img/12.webp,/images/random_top_img/13.webp,/images/random_top_img/14.webp,/images/random_top_img/15.webp,/images/random_top_img/16.webp,/images/random_top_img/17.webp,/images/random_top_img/18.webp,/images/random_top_img/19.webp,/images/random_top_img/20.webp,/images/random_top_img/21.webp,/images/random_top_img/22.webp,/images/random_top_img/23.webp,/images/random_top_img/24.webp,/images/random_top_img/25.webp,/images/random_top_img/26.webp,/images/random_top_img/27.webp,/images/random_top_img/28.webp,/images/random_top_img/29.webp,/images/random_top_img/30.webp,/images/random_top_img/31.webp,/images/random_top_img/32.webp,/images/random_top_img/33.webp,/images/random_top_img/34.webp,/images/random_top_img/35.webp,/images/random_top_img/36.webp,/images/random_top_img/37.webp,/images/random_top_img/38.webp,/images/random_top_img/39.webp,/images/random_top_img/40.webp,/images/random_top_img/41.webp,/images/random_top_img/42.webp,/images/random_top_img/43.webp,/images/random_top_img/44.webp,/images/random_top_img/45.webp,/images/random_top_img/46.webp,/images/random_top_img/47.webp,/images/random_top_img/48.webp,/images/random_top_img/49.webp,/images/random_top_img/50.webp,/images/random_top_img/51.webp,/images/random_top_img/52.webp,/images/random_top_img/53.webp,/images/random_top_img/54.webp,/images/random_top_img/55.webp,/images/random_top_img/56.webp,/images/random_top_img/57.webp".split(',');
			}
			var randomLink = links[Math.floor(Math.random() * links.length)];
			element.style.backgroundImage = "url('" + randomLink + "')";
		}
	</script>

	
<script src="/js/plugins/breadcrumb.js"></script>

	<script>
		var menus_title = [];
		
			menus_title.push({home: '主页'});
		
			menus_title.push({categories: '类别'});
		
			menus_title.push({tags: '标签'});
		
			menus_title.push({archives: '归档'});
		
			menus_title.push({galleries: '相册'});
		
			menus_title.push({links: '链接'});
		
			menus_title.push({about: '关于'});
		
		
			
				postsBreadcrumb(
					document.getElementById('breadcrumb'),
					"类别",
					"/categories",
					"学习",
					"/categories/学习",
					1
				);
			
		
	</script>
</header>

<div class="main-wrapper">
    <main class="post">
        <header class="main-header">
	
		
			
				
<link rel="stylesheet" href="/css/plugins/fancybox.css">

				
<script src="/js/plugins/fancybox.umd.js"></script>

				
<script src="/js/plugins/fancybox.js"></script>

			
			<div class="post-header-background-content">
				<ul class="post-header-tag">
					
						
							<li><a href="/tags/Python"><span>Python</span></a></li>
						
							<li><a href="/tags/论文"><span>论文</span></a></li>
						
							<li><a href="/tags/实验相关"><span>实验相关</span></a></li>
						
							<li><a href="/tags/MindSpore"><span>MindSpore</span></a></li>
						
							<li><a href="/tags/文本检测"><span>文本检测</span></a></li>
						
							<li><a href="/tags/代码复现"><span>代码复现</span></a></li>
						
					
				</ul>
				
				<h1>Paper-Real-Time Scene Text Detection with Differentiable Binarization</h1>
		
				
					<div class="post-header-desc">
						<svg t="1714702231661" class="icon" viewBox="0 0 1024 1024" version="1.1"
						xmlns="http://www.w3.org/2000/svg" p-id="1154" xmlns:xlink="http://www.w3.org/1999/xlink"
						width="20" height="20">
						<path
							d="M778.24 117.76A46.08 46.08 0 0 1 824.32 163.84v430.08c0 8.4992-4.13696 16.01536-10.50624 20.6848l-0.24576 0.2048L587.5712 846.09024a35.84 35.84 0 0 1-61.48096-25.06752v-220.9792a46.08 46.08 0 0 1 46.08-46.08l200.94976-0.02048V168.96h-522.24v686.08H389.12c13.25056 0 24.1664 10.07616 25.47712 22.97856l0.12288 2.62144c0 14.1312-11.4688 25.6-25.6 25.6h-143.36A46.08 46.08 0 0 1 199.68 860.16V163.84A46.08 46.08 0 0 1 245.76 117.76h532.48z m-26.78784 487.38304h-174.16192v178.176l174.16192-178.176z m-45.19936-169.94304a25.6 25.6 0 0 1 0 51.2H307.2a25.6 25.6 0 0 1 0-51.2h399.0528z m0-122.88a25.6 25.6 0 0 1 0 51.2H307.2a25.6 25.6 0 0 1 0-51.2h399.0528z"
							fill="#ffffff" p-id="1155"></path>
						</svg>
						<p>论文阅读。</p>
					</div>
				
		
				<div class="post-header-info">
					<svg t="1604839279282" class="icon" viewBox="0 0 1024 1024" version="1.1"
					xmlns="http://www.w3.org/2000/svg" p-id="2901" width="20" height="20">
						<path
							d="M513 956.3c-247.7 0-448-200.3-448-448S265.3 66.2 513 66.2s448 200.3 448 448-200.3 442.1-448 442.1z m0-830.9c-212.2 0-388.8 170.7-388.8 388.8C124.2 726.3 294.9 903 513 903c212.2 0 388.8-170.7 388.8-388.8S725.2 125.4 513 125.4z m0 430.2c-94.2 0-170.7-76.5-170.7-170.7S418.8 207.8 513 207.8s170.7 76.5 170.7 170.7S607.2 555.6 513 555.6z m0-289.1c-64.6 0-112 52.8-112 112s47.4 117.9 112 117.9 112-52.8 112-112-47.4-117.9-112-117.9z m0 689.8c-135.7 0-259-58.7-341.9-158.9l-11.8-17.8 11.8-17.8c76.5-117.9 206.2-188.5 347.8-188.5 135.7 0 265 64.6 341.9 182.6l11.8 17.8-11.8 17.8C778 897.1 648.7 956.3 513 956.3zM230.3 773.2C300.9 849.7 406.9 897 513 897c112 0 218.1-47.4 288.6-129.8-70.5-88.2-170.7-135.6-282.7-135.6s-218.1 53.3-288.6 141.6z"
							p-id="2902" fill="#ffffff"></path>
					</svg>
					<div class="post-header-info-author">
						<a href="/about">Zi-Zi</a>
					</div>
					
						<div class="post-header-info-categories">
							
								<a href="/categories/学习">学习</a>
							
						</div>
					
					<time>2023/07/13 14:04:00</time>
				</div>
		
				
					<div class="post-header-stat">
						<svg version="1.0" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
						viewBox="0 0 200 200" enable-background="new 0 0 200 200" xml:space="preserve" width="20" height="20">
							<path fill="#FFFFFF" d="M187.2,165.6c0,2.6-2.1,4.7-4.7,4.7H17.5c-2.6,0-4.7-2.1-4.7-4.7s2.1-4.7,4.7-4.7h165.1
								C185.2,160.9,187.2,163,187.2,165.6z"/>
							<path fill="#FFFFFF" d="M17.5,29.7c2.6,0,4.7,2.1,4.7,4.7v131.2c0,2.6-2.1,4.7-4.7,4.7s-4.7-2.1-4.7-4.7V34.4
								C12.8,31.8,14.9,29.7,17.5,29.7z M77.9,91.5c1.8,1.8,1.8,4.8,0,6.6l-39.8,39.8c-1.9,1.8-4.9,1.7-6.6-0.2c-1.7-1.8-1.7-4.6,0-6.4
								l39.8-39.8C73.1,89.6,76,89.6,77.9,91.5z M169.9,70.2c1.6,2.1,1.1,5-0.9,6.5c0,0,0,0,0,0l-64.2,48.2c-2.1,1.5-5,1.1-6.6-0.9
								c-1.6-2.1-1.1-5,0.9-6.5c0,0,0,0,0,0l64.2-48.2C165.4,67.7,168.3,68.1,169.9,70.2L169.9,70.2z"/>
							<path fill="#FFFFFF" d="M104.6,124.5c-1.8,1.8-4.8,1.8-6.6,0L71.6,98.1c-1.8-1.8-1.8-4.8,0-6.6c1.8-1.8,4.8-1.8,6.6,0l26.3,26.3
								C106.4,119.6,106.4,122.6,104.6,124.5C104.6,124.4,104.6,124.4,104.6,124.5z"/>
						</svg>
		
						
							
<script src="/js/plugins/wordCount.js"></script>

							<p class="post-count">文字数：---</p>
						
		
						
							<p id="busuanzi_container_page_pv" style='display:none;'>阅读数：<span id="busuanzi_value_page_pv"></span></p>
						
					</div>
				
			</div>
		
	
</header>
        <div class="post-content article-container">
            <article class="post-content-info">
                <h1 id="%E8%B5%84%E6%BA%90" tabindex="-1">资源</h1>
<ul>
<li>
<p>PaperWithCode：<a target="_blank" rel="noopener" href="https://paperswithcode.com/paper/real-time-scene-text-detection-with">Real-time Scene Text Detection with Differentiable Binarization | Papers With Code</a></p>
</li>
<li>
<p>Arxiv：<a target="_blank" rel="noopener" href="https://arxiv.org/abs/1911.08947">[1911.08947] Real-time Scene Text Detection with Differentiable Binarization (arxiv.org)</a></p>
</li>
<li>
<p>Gitee：<a href="https://gitee.com/mindspore-lab/mindocr/blob/main/configs/det/dbnet/README_CN.md#https://gitee.com/link?target=https%3A%2F%2Farxiv.org%2Fabs%2F1911.08947">configs/det/dbnet/README_CN.md · MindSpore Lab/mindocr - Gitee.com</a></p>
</li>
<li>
<p>代码复现：<a href="..//Server-MindOCR/">Server-MindOCR-Zi-Zi’s Journey</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ytsaiztt/article/details/118090611">DBNet 的简单复现_dbnet 复现-CSDN 博客</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hhhhhhhhhhwwwwwwwwww/article/details/123904386">DBNet 实战：详解 DBNet 训练与测试（pytorch）-CSDN 博客</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://lwd3-byt.github.io/2021/07/28/DBNet-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90-%E5%AE%9E%E8%B7%B5%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%8F%8A%E8%BF%90%E8%A1%8C/">OCR-(DB+CRNN)-代码分析-实践环境配置及运行 - Lwd_curent (lwd3-byt.github.io)</a></p>
</li>
</ul>
<h1 id="%E6%AD%A3%E6%96%87" tabindex="-1">正文</h1>
<h2 id="abstract" tabindex="-1" id="Abstract">Abstract</h2>
<ul>
<li>基于分割的场景文本检测（可以获得像素级别的预测）可以更精确地描述曲线文本等各种形状的场景文本</li>
<li>二值化的后处理对于基于分割的检测至关重要，该检测将分割方法产生的概率图转换为文本的边界框/区域</li>
<li>提出了一个名为可微分二值化（DB）的模块，它可以在分割网络中执行二值化过程</li>
<li>好使。</li>
</ul>
<h2 id="introduction" tabindex="-1" id="Introduction">Introduction</h2>
<p>​    本文的主要贡献是提出了可微的 DB 模块，它使二值化过程在 CNN 中可以端到端训练。</p>
<p><img src="F2.webp" alt="webp"></p>
<ul>
<li>大多数现有的检测方法使用类似的<strong>后处理流水线</strong>，如图所示（蓝色箭头后面）：
<ul>
<li>首先，它们设置了一个固定的阈值，用于将分割网络生成的概率图转换为二值图像；</li>
<li>然后，使用像素聚类等启发式技术将像素分组到文本实例中。</li>
</ul>
</li>
<li>或者，我们的流水线（如图中的红色箭头所示）旨在将二值化操作插入到分割网络中进行联合优化。通过这种方式，可以自适应地预测图像每个位置的阈值，这可以完全区分像素与前景和背景。然而，标准的二值化函数是不可微的，我们提出了一种称为<strong>可微分二值化（DB）的近似函数</strong>，当与分割网络一起训练时，它是完全可微的。</li>
</ul>
<p>​	本文的主要贡献是提出了可微分的 DB 模块，这使得<strong>二值化过程在 CNN 中端到端可训练</strong>。</p>
<h2 id="related-work" tabindex="-1" id="Related-Work">Related Work</h2>
<p>​    最近的场景文本检测方法大致可以分为两类：基于回归（Regression-based）的方法和基于分割（Segmentation-based）的方法。</p>
<ul>
<li>
<p>基于<strong>回归 Regression</strong> 的方法是一系列直接回归文本实例的边界框的模型。</p>
</li>
<li>
<p>基于<strong>分割 Segmentation</strong> 的方法通常结合像素级预测和后处理算法来获得边界框</p>
</li>
<li>
<p><strong>快速的场景文本检测方法</strong>注重准确性和推理速度。</p>
</li>
</ul>
<h2 id="methodology" tabindex="-1" id="Methodology">Methodology</h2>
<p><img src="F3.webp" alt="webp"></p>
<div class="tabs" id="model"><div class="nav-tabs"><button type="button" class="tab active" data-href="model-1">model.py</button><button type="button" class="tab" data-href="model-2">backbone</button><button type="button" class="tab" data-href="model-3">neck</button><button type="button" class="tab" data-href="model-4">head</button></div><div class="tab-contents"><div class="tab-item-content active" id="model-1"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># @Time    : 2019/8/23 21:57</span><br><span class="hljs-comment"># @Author  : zhoujun</span><br><span class="hljs-keyword">from</span> addict <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span><br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><br><span class="hljs-keyword">from</span> models.backbone <span class="hljs-keyword">import</span> build_backbone<br><span class="hljs-keyword">from</span> models.neck <span class="hljs-keyword">import</span> build_neck<br><span class="hljs-keyword">from</span> models.head <span class="hljs-keyword">import</span> build_head<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_config: <span class="hljs-built_in">dict</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        PANnet</span><br><span class="hljs-string">        :param model_config: 模型配置</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">super</span>().__init__()<br>        model_config = <span class="hljs-type">Dict</span>(model_config)  <span class="hljs-comment"># 一个配置字典，用于指定模型的结构。转换为 Dict 对象，方便通过属性访问。</span><br>        <span class="hljs-comment"># 从配置字典中提取 backbone、neck 和 head 的类型，并分别从配置中删除它们。</span><br>        backbone_type = model_config.backbone.pop(<span class="hljs-string">&#x27;type&#x27;</span>)<br>        neck_type = model_config.neck.pop(<span class="hljs-string">&#x27;type&#x27;</span>)<br>        head_type = model_config.head.pop(<span class="hljs-string">&#x27;type&#x27;</span>)<br>        <span class="hljs-comment"># 使用 build_backbone、build_neck 和 build_head 函数构建模型的不同部分。</span><br>        <span class="hljs-variable language_">self</span>.backbone = build_backbone(backbone_type, **model_config.backbone)<br>        <span class="hljs-variable language_">self</span>.neck = build_neck(neck_type, in_channels=<span class="hljs-variable language_">self</span>.backbone.out_channels, **model_config.neck)<br>        <span class="hljs-variable language_">self</span>.head = build_head(head_type, in_channels=<span class="hljs-variable language_">self</span>.neck.out_channels, **model_config.head)<br>        <span class="hljs-comment"># self.name 存储了模型的名字，由 backbone、neck 和 head 的类型组合而成。</span><br>        <span class="hljs-variable language_">self</span>.name = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;backbone_type&#125;</span>_<span class="hljs-subst">&#123;neck_type&#125;</span>_<span class="hljs-subst">&#123;head_type&#125;</span>&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        _, _, H, W = x.size()  <span class="hljs-comment"># x 是输入的张量，尺寸为 [batch_size, channels, height, width]。</span><br>        backbone_out = <span class="hljs-variable language_">self</span>.backbone(x)  <span class="hljs-comment"># 使用 self.backbone 处理输入，得到 backbone_out。</span><br>        neck_out = <span class="hljs-variable language_">self</span>.neck(backbone_out)  <span class="hljs-comment"># 使用 self.neck 处理 backbone_out，得到 neck_out。</span><br>        y = <span class="hljs-variable language_">self</span>.head(neck_out)  <span class="hljs-comment"># 使用 self.head 处理 neck_out，得到最终输出 y。</span><br>        y = F.interpolate(y, size=(H, W), mode=<span class="hljs-string">&#x27;bilinear&#x27;</span>, align_corners=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># F.interpolate 用于将输出 y 的尺寸调整为与输入 x 相同，以保持空间分辨率一致。</span><br>        <span class="hljs-keyword">return</span> y  <span class="hljs-comment"># 最终返回调整后的 y。</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">import</span> torch<br><br>    device = torch.device(<span class="hljs-string">&#x27;cpu&#x27;</span>)  <span class="hljs-comment"># 创建一个 CPU 设备（可以改为 GPU）。</span><br>    x = torch.zeros(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">640</span>, <span class="hljs-number">640</span>).to(device)  <span class="hljs-comment"># 创建一个大小为 [2, 3, 640, 640] 的零张量作为输入。</span><br><br>    model_config = &#123;<br>        <span class="hljs-string">&#x27;backbone&#x27;</span>: &#123;<span class="hljs-string">&#x27;type&#x27;</span>: <span class="hljs-string">&#x27;resnest50&#x27;</span>, <span class="hljs-string">&#x27;pretrained&#x27;</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">&quot;in_channels&quot;</span>: <span class="hljs-number">3</span>&#125;,<br>        <span class="hljs-string">&#x27;neck&#x27;</span>: &#123;<span class="hljs-string">&#x27;type&#x27;</span>: <span class="hljs-string">&#x27;FPN&#x27;</span>, <span class="hljs-string">&#x27;inner_channels&#x27;</span>: <span class="hljs-number">256</span>&#125;,  <span class="hljs-comment"># 分割头，FPN or FPEM_FFM</span><br>        <span class="hljs-string">&#x27;head&#x27;</span>: &#123;<span class="hljs-string">&#x27;type&#x27;</span>: <span class="hljs-string">&#x27;DBHead&#x27;</span>, <span class="hljs-string">&#x27;out_channels&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;k&#x27;</span>: <span class="hljs-number">50</span>&#125;,<br>    &#125;<br>    model = Model(model_config=model_config).to(device)  <span class="hljs-comment"># 初始化 Model 对象，传入配置字典。</span><br>    <span class="hljs-keyword">import</span> time  <span class="hljs-comment"># 测量前向传播的时间。</span><br><br>    tic = time.time()<br>    y = model(x)<br>    <span class="hljs-comment"># 打印出前向传播的时间、输出的形状、模型的名称和模型的详细结构。</span><br>    <span class="hljs-built_in">print</span>(time.time() - tic)<br>    <span class="hljs-built_in">print</span>(y.shape)<br>    <span class="hljs-built_in">print</span>(model.name)<br>    <span class="hljs-built_in">print</span>(model)<br>    <span class="hljs-comment">#（可选）将模型的状态字典保存到文件 PAN.pth。</span><br>    <span class="hljs-comment"># torch.save(model.state_dict(), &#x27;PAN.pth&#x27;)</span><br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="model-2"><ul>
<li>resnet</li>
<li>MobilenetV3</li>
<li>shfflenetv2</li>
</ul></div><div class="tab-item-content" id="model-3"><ul>
<li>
<p>FPN</p>
<ul>
<li>
<p>该代码实现了一个特征金字塔网络（FPN）的模块，主要用于融合来自不同尺度的特征图。它包括：</p>
<ul>
<li>
<p><strong>特征图减少层</strong>：将每个特征图的通道数减少到较小的值。</p>
</li>
<li>
<p><strong>平滑层</strong>：对每一层的特征图进行平滑处理。</p>
</li>
<li>
<p><strong>融合和上采样</strong>：通过上采样和拼接不同层的特征图来增强特征表示。</p>
</li>
<li>
<p><strong>最终卷积</strong>：对融合后的特征图进行进一步处理，以生成最终的输出。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><br><span class="hljs-keyword">from</span> models.basic <span class="hljs-keyword">import</span> ConvBnRelu<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FPN</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_channels, inner_channels=<span class="hljs-number">256</span>, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param in_channels: 基础网络输出的维度</span><br><span class="hljs-string">        :param kwargs:</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">super</span>().__init__()<br>        inplace = <span class="hljs-literal">True</span><br>        <span class="hljs-variable language_">self</span>.conv_out = inner_channels<br>        inner_channels = inner_channels // <span class="hljs-number">4</span>  <span class="hljs-comment"># 定义了在融合过程中的中间通道数。</span><br>        <span class="hljs-comment"># reduce layers 是用于将不同层的特征图通道数减少到 inner_channels 的卷积层。</span><br>        <span class="hljs-variable language_">self</span>.reduce_conv_c2 = ConvBnRelu(in_channels[<span class="hljs-number">0</span>], inner_channels, kernel_size=<span class="hljs-number">1</span>, inplace=inplace)<br>        <span class="hljs-variable language_">self</span>.reduce_conv_c3 = ConvBnRelu(in_channels[<span class="hljs-number">1</span>], inner_channels, kernel_size=<span class="hljs-number">1</span>, inplace=inplace)<br>        <span class="hljs-variable language_">self</span>.reduce_conv_c4 = ConvBnRelu(in_channels[<span class="hljs-number">2</span>], inner_channels, kernel_size=<span class="hljs-number">1</span>, inplace=inplace)<br>        <span class="hljs-variable language_">self</span>.reduce_conv_c5 = ConvBnRelu(in_channels[<span class="hljs-number">3</span>], inner_channels, kernel_size=<span class="hljs-number">1</span>, inplace=inplace)<br>        <span class="hljs-comment"># Smooth layers 平滑层，用于进一步处理不同层次的特征图。</span><br>        <span class="hljs-variable language_">self</span>.smooth_p4 = ConvBnRelu(inner_channels, inner_channels, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>, inplace=inplace)<br>        <span class="hljs-variable language_">self</span>.smooth_p3 = ConvBnRelu(inner_channels, inner_channels, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>, inplace=inplace)<br>        <span class="hljs-variable language_">self</span>.smooth_p2 = ConvBnRelu(inner_channels, inner_channels, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>, inplace=inplace)<br><br>        <span class="hljs-variable language_">self</span>.conv = nn.Sequential(<br>            nn.Conv2d(<span class="hljs-variable language_">self</span>.conv_out, <span class="hljs-variable language_">self</span>.conv_out, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>, stride=<span class="hljs-number">1</span>),<br>            nn.BatchNorm2d(<span class="hljs-variable language_">self</span>.conv_out),<br>            nn.ReLU(inplace=inplace)<br>        )  <span class="hljs-comment"># 是一个卷积层组合，用于处理最终融合后的特征图，包括卷积、批归一化和 ReLU 激活函数。</span><br>        <span class="hljs-variable language_">self</span>.out_channels = <span class="hljs-variable language_">self</span>.conv_out  <span class="hljs-comment"># 保存了输出特征图的通道数。</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        c2, c3, c4, c5 = x  <span class="hljs-comment"># 是一个包含四个特征图的元组 (c2, c3, c4, c5)，这些特征图来自基础网络的不同层。</span><br>        <span class="hljs-comment"># Top-down</span><br>        p5 = <span class="hljs-variable language_">self</span>.reduce_conv_c5(c5)<br>        p4 = <span class="hljs-variable language_">self</span>._upsample_add(p5, <span class="hljs-variable language_">self</span>.reduce_conv_c4(c4))<br>        p4 = <span class="hljs-variable language_">self</span>.smooth_p4(p4)<br>        p3 = <span class="hljs-variable language_">self</span>._upsample_add(p4, <span class="hljs-variable language_">self</span>.reduce_conv_c3(c3))<br>        p3 = <span class="hljs-variable language_">self</span>.smooth_p3(p3)<br>        p2 = <span class="hljs-variable language_">self</span>._upsample_add(p3, <span class="hljs-variable language_">self</span>.reduce_conv_c2(c2))<br>        p2 = <span class="hljs-variable language_">self</span>.smooth_p2(p2)<br><br>        x = <span class="hljs-variable language_">self</span>._upsample_cat(p2, p3, p4, p5)  <span class="hljs-comment"># 将所有层的特征图在通道维度上进行拼接。</span><br>        x = <span class="hljs-variable language_">self</span>.conv(x)  <span class="hljs-comment">#  对拼接后的特征图进行最终处理，输出融合后的特征图。</span><br>        <span class="hljs-keyword">return</span> x<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_upsample_add</span>(<span class="hljs-params">self, x, y</span>):<br>        <span class="hljs-keyword">return</span> F.interpolate(x, size=y.size()[<span class="hljs-number">2</span>:]) + y  <span class="hljs-comment"># 将输入 x 上采样到与 y 相同的尺寸，并将其与 y 相加。</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_upsample_cat</span>(<span class="hljs-params">self, p2, p3, p4, p5</span>):  <span class="hljs-comment"># 将 p2、p3、p4 和 p5 上采样到相同的尺寸，然后在通道维度上拼接它们。</span><br>        h, w = p2.size()[<span class="hljs-number">2</span>:]<br>        p3 = F.interpolate(p3, size=(h, w))<br>        p4 = F.interpolate(p4, size=(h, w))<br>        p5 = F.interpolate(p5, size=(h, w))<br>        <span class="hljs-keyword">return</span> torch.cat([p2, p3, p4, p5], dim=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="model-4"><ul>
<li>ConvHead
<ul>
<li><code>ConvHead</code> 是一个非常基础且常见的模块，通过一个 1x1 卷积层和 Sigmoid 激活函数对输入特征图进行变换。它主要用于生成最终的输出特征图，特别是在需要将特征图转换为概率图的任务中。</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConvHead</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_channels, out_channels,**kwargs</span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br>        <span class="hljs-variable language_">self</span>.conv = nn.Sequential(<br>            <span class="hljs-comment"># 一个卷积层，使用 1x1 的卷积核来对输入进行线性变换。这种卷积核的大小使得它主要作用于通道维度上的线性变换，而不改变空间维度（宽度和高度）。</span><br>            nn.Conv2d(in_channels=in_channels, out_channels=out_channels, kernel_size=<span class="hljs-number">1</span>),<br>            <span class="hljs-comment"># 一个激活函数，将卷积层的输出限制在 0 到 1 之间。这个函数通常用于需要输出概率值的任务，例如二分类问题或需要对特征图进行归一化处理的任务。</span><br>            nn.Sigmoid()<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.conv(x)<br></code></pre></td></tr></table></figure>
<ul>
<li>DBHead</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DBHead</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_channels, out_channels, k = <span class="hljs-number">50</span></span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br>        <span class="hljs-variable language_">self</span>.k = k  <span class="hljs-comment"># 用于前向传播时的步长函数的参数。</span><br>        <span class="hljs-variable language_">self</span>.binarize = nn.Sequential(  <span class="hljs-comment"># 一个生成二值图的顺序模块</span><br>            nn.Conv2d(in_channels, in_channels // <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>),  <span class="hljs-comment"># 将通道数从 in_channels 降到 in_channels // 4，使用 3x3 的卷积核。</span><br>            nn.BatchNorm2d(in_channels // <span class="hljs-number">4</span>),  <span class="hljs-comment"># 批量归一化。</span><br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),  <span class="hljs-comment"># 非线性激活函数。</span><br>            nn.ConvTranspose2d(in_channels // <span class="hljs-number">4</span>, in_channels // <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>),  <span class="hljs-comment"># 上采样特征图两次（空间维度翻倍）。</span><br>            nn.BatchNorm2d(in_channels // <span class="hljs-number">4</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.ConvTranspose2d(in_channels // <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>),<br>            nn.Sigmoid())  <span class="hljs-comment"># 输出 0 到 1 之间的值，适用于二值图。</span><br>        <span class="hljs-variable language_">self</span>.binarize.apply(<span class="hljs-variable language_">self</span>.weights_init)  <br><br>        <span class="hljs-variable language_">self</span>.thresh = <span class="hljs-variable language_">self</span>._init_thresh(in_channels)  <span class="hljs-comment"># 使用 _init_thresh 方法生成阈值图。</span><br>        <span class="hljs-variable language_">self</span>.thresh.apply(<span class="hljs-variable language_">self</span>.weights_init)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        shrink_maps = <span class="hljs-variable language_">self</span>.binarize(x)  <span class="hljs-comment"># binarize 模块的输出。</span><br>        threshold_maps = <span class="hljs-variable language_">self</span>.thresh(x)  <span class="hljs-comment"># thresh 模块的输出。</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.training:  <span class="hljs-comment"># 训练模式下</span><br>            binary_maps = <span class="hljs-variable language_">self</span>.step_function(shrink_maps, threshold_maps)   <span class="hljs-comment"># 使用 step_function 计算二值图。</span><br>            y = torch.cat((shrink_maps, threshold_maps, binary_maps), dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 将 shrink_maps、threshold_maps 和 binary_maps 连接在一起。</span><br>        <span class="hljs-keyword">else</span>:<br>            y = torch.cat((shrink_maps, threshold_maps), dim=<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> y<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">weights_init</span>(<span class="hljs-params">self, m</span>):  <span class="hljs-comment"># 使用 He 初始化（kaiming_normal_）初始化卷积层的权重，并为批量归一化层设置特定的值。</span><br>        classname = m.__class__.__name__<br>        <span class="hljs-keyword">if</span> classname.find(<span class="hljs-string">&#x27;Conv&#x27;</span>) != -<span class="hljs-number">1</span>:<br>            nn.init.kaiming_normal_(m.weight.data)<br>        <span class="hljs-keyword">elif</span> classname.find(<span class="hljs-string">&#x27;BatchNorm&#x27;</span>) != -<span class="hljs-number">1</span>:<br>            m.weight.data.fill_(<span class="hljs-number">1.</span>)<br>            m.bias.data.fill_(<span class="hljs-number">1e-4</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_init_thresh</span>(<span class="hljs-params">self, inner_channels, serial=<span class="hljs-literal">False</span>, smooth=<span class="hljs-literal">False</span>, bias=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-comment"># 创建一个生成阈值图的顺序模块。使用 nn.Conv2d、批量归一化、ReLU、上采样和 Sigmoid 激活。</span><br>        in_channels = inner_channels<br>        <span class="hljs-keyword">if</span> serial:<br>            in_channels += <span class="hljs-number">1</span><br>        <span class="hljs-variable language_">self</span>.thresh = nn.Sequential(<br>            nn.Conv2d(in_channels, inner_channels // <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>, bias=bias),<br>            nn.BatchNorm2d(inner_channels // <span class="hljs-number">4</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            <span class="hljs-variable language_">self</span>._init_upsample(inner_channels // <span class="hljs-number">4</span>, inner_channels // <span class="hljs-number">4</span>, smooth=smooth, bias=bias),<br>            nn.BatchNorm2d(inner_channels // <span class="hljs-number">4</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            <span class="hljs-variable language_">self</span>._init_upsample(inner_channels // <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, smooth=smooth, bias=bias),<br>            nn.Sigmoid())<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.thresh<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_init_upsample</span>(<span class="hljs-params">self, in_channels, out_channels, smooth=<span class="hljs-literal">False</span>, bias=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-comment"># 定义上采样模块，使用邻近插值加卷积，或者使用转置卷积层。</span><br>        <span class="hljs-keyword">if</span> smooth:  <span class="hljs-comment"># 平滑上采样</span><br>            inter_out_channels = out_channels<br>            <span class="hljs-keyword">if</span> out_channels == <span class="hljs-number">1</span>:<br>                inter_out_channels = in_channels<br>            module_list = [<br>                nn.Upsample(scale_factor=<span class="hljs-number">2</span>, mode=<span class="hljs-string">&#x27;nearest&#x27;</span>),  <span class="hljs-comment"># 使用 nn.Upsample 将输入的空间维度扩大一倍（使用最近邻插值）。</span><br>                nn.Conv2d(in_channels, inter_out_channels, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, bias=bias)]  <span class="hljs-comment"># 接着应用 nn.Conv2d 层来对上采样后的特征图进行进一步处理。</span><br>            <span class="hljs-keyword">if</span> out_channels == <span class="hljs-number">1</span>:<br>                <span class="hljs-comment"># 如果 out_channels 等于 1，还会添加一个额外的 nn.Conv2d 层，以调整输出通道数。</span><br>                module_list.append(nn.Conv2d(in_channels, out_channels, kernel_size=<span class="hljs-number">1</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">1</span>, bias=<span class="hljs-literal">True</span>))<br>            <span class="hljs-keyword">return</span> nn.Sequential(module_list)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># 直接使用 nn.ConvTranspose2d 层进行上采样（转置卷积），以实现空间维度的扩展。</span><br>            <span class="hljs-keyword">return</span> nn.ConvTranspose2d(in_channels, out_channels, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">step_function</span>(<span class="hljs-params">self, x, y</span>):<br>        <span class="hljs-comment"># 应用步长函数生成二值图。此函数使用类似 sigmoid 的曲线来基于 x（收缩图）和 y（阈值图）的差异产生 0 到 1 之间的值。</span><br>        <span class="hljs-keyword">return</span> torch.reciprocal(<span class="hljs-number">1</span> + torch.exp(-<span class="hljs-variable language_">self</span>.k * (x - y)))<br></code></pre></td></tr></table></figure></div></div></div>
<ol>
<li>
<p>将<strong>输入图像</strong>输入到 feature-pyramid back-bone 中</p>
</li>
<li>
<p>金字塔特征被上采样到相同的尺度并级联以产生<strong>特征</strong> <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span></span></span></span></p>
</li>
<li>
<p>特征 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span></span></span></span> 被用于预测<strong>概率图 probability map</strong>  <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">P</span></span></span></span> 和<strong>阈值图 threshold map</strong> <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></p>
</li>
<li>
<p>DB 通过 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">P</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span></span></span></span> 计算近似二值映射，得到<strong>近似二值图 approximate binary map</strong> <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mi>B</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9467699999999999em;"></span><span class="strut bottom" style="height:0.9467699999999999em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord mathit" style="margin-right:0.05017em;">B</span></span><span style="top:-0.25233em;margin-left:0.16668em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></p>
</li>
</ol>
<ul>
<li>
<p>在 train 期间，监督应用于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">P</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mi>B</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9467699999999999em;"></span><span class="strut bottom" style="height:0.9467699999999999em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord mathit" style="margin-right:0.05017em;">B</span></span><span style="top:-0.25233em;margin-left:0.16668em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">P</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mi>B</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9467699999999999em;"></span><span class="strut bottom" style="height:0.9467699999999999em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord mathit" style="margin-right:0.05017em;">B</span></span><span style="top:-0.25233em;margin-left:0.16668em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 共享相同的监督</p>
</li>
<li>
<p>在 inference 期间，通过框公式化模块可以容易地从 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mi>B</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9467699999999999em;"></span><span class="strut bottom" style="height:0.9467699999999999em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord mathit" style="margin-right:0.05017em;">B</span></span><span style="top:-0.25233em;margin-left:0.16668em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 或 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">P</span></span></span></span> 中获得边界框</p>
</li>
</ul>
<h3 id="binarization" tabindex="-1" id="Binarization">Binarization</h3>
<h4 id="standard-binarization" tabindex="-1" id="Standard-binarization">Standard binarization</h4>
<p>​    就是一刀切。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>B</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mn>1</mn></mrow></mtd><mtd><mrow><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mrow><mtext> </mtext><msub><mi>P</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>&gt;</mo><mo>=</mo><mi>t</mi></mrow></mtd></mtr><mtr><mtd><mrow><mn>0</mn></mrow></mtd><mtd><mrow><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">w</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">.</mi></mrow></mrow></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">B_{i,j}=\left\{\begin{matrix} 1 &amp; \mathrm{if}\ P_{i,j}&gt;=t\\ 0 &amp; \mathrm{otherwise.}\end{matrix}\right.
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.45em;"></span><span class="strut bottom" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.05017em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist"><span style="top:-0.6099999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">1</span></span></span><span style="top:0.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist"><span style="top:-0.6099999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace"> </span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">&gt;</span><span class="mrel">=</span><span class="mord mathit">t</span></span></span><span style="top:0.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">o</span><span class="mord mathrm">t</span><span class="mord mathrm">h</span><span class="mord mathrm">e</span><span class="mord mathrm">r</span><span class="mord mathrm" style="margin-right:0.01389em;">w</span><span class="mord mathrm">i</span><span class="mord mathrm">s</span><span class="mord mathrm">e</span><span class="mord mathrm">.</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p>​    给定由分割网络产生的概率图 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo>∈</mo><msup><mi>R</mi><mrow><mi>H</mi><mo>×</mo><mi>W</mi></mrow></msup></mrow><annotation encoding="application/x-tex">P\in R^{H\times W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8413309999999999em;"></span><span class="strut bottom" style="height:0.880431em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mrel">∈</span><span class="mord"><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.08125em;">H</span><span class="mbin">×</span><span class="mord mathit" style="margin-right:0.13889em;">W</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.08125em;">H</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">W</span></span></span></span> 表示图的高度和宽度，必须将其转换为二值图 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo>∈</mo><msup><mi>R</mi><mrow><mi>H</mi><mo>×</mo><mi>W</mi></mrow></msup></mrow><annotation encoding="application/x-tex">P\in R^{H\times W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8413309999999999em;"></span><span class="strut bottom" style="height:0.880431em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mrel">∈</span><span class="mord"><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.08125em;">H</span><span class="mbin">×</span><span class="mord mathit" style="margin-right:0.13889em;">W</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>，其中值为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span></span></span></span> 被认为是有效的文本区域。其中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.61508em;"></span><span class="strut bottom" style="height:0.61508em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">t</span></span></span></span> 是预定义的阈值，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">(</span><span class="mord mathit">i</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span> 表示 map 中的坐标点。</p>
<h4 id="differentiable-binarization" tabindex="-1" id="Differentiable-binarization">Differentiable binarization</h4>
<p>​    上式不可微分，在 train 过程中就不可以与分割网络一起进行优化，因此，我们建议使用阶跃函数进行二值化：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>B</mi><mo>^</mo></mover><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>=</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>k</mi><mo>(</mo><msub><mi>P</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>−</mo><msub><mi>T</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>)</mo></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\hat B_{i,j}=\frac{1}{1+e^{-k(P_{i,j}-T_{i,j})}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.32144em;"></span><span class="strut bottom" style="height:2.12974em;vertical-align:-0.8083em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord mathit" style="margin-right:0.05017em;">B</span></span><span style="top:-0.25233em;margin-left:0.16668em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.05017em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.72497em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">1</span><span class="mbin">+</span><span class="mord"><span class="mord mathit">e</span><span class="vlist"><span style="top:-0.30997em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord">−</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15000000000000002em;margin-right:0.07142857142857144em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord mathit">i</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="vlist"><span style="top:0.15000000000000002em;margin-right:0.07142857142857144em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord mathit">i</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p>​    其中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mi>B</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.9467699999999999em;"></span><span class="strut bottom" style="height:0.9467699999999999em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord accent"><span class="vlist"><span style="top:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord mathit" style="margin-right:0.05017em;">B</span></span><span style="top:-0.25233em;margin-left:0.16668em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="accent-body"><span>^</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 是近似二进制映射；<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span> 是从网络学习的自适应阈值映射；<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span> 表示放大因子。<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span> 根据经验设置为 50。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">step_function</span>(<span class="hljs-params">self, x, y</span>):<br>    <span class="hljs-keyword">return</span> torch.reciprocal(<span class="hljs-number">1</span> + torch.exp(-<span class="hljs-variable language_">self</span>.k * (x - y)))<br>    <span class="hljs-comment"># 这个 step_function 就是 Differentiable binarization 的公式</span><br></code></pre></td></tr></table></figure>
<p><img src="F4.webp" alt="webp"></p>
<center>DB 的 k 越大，越接近于 Standard Binarization</center>
<p>​	DB 提高性能的原因可以通过梯度的反向传播来解释。以二元交叉熵损失为例。定义 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo>(</mo><mi>x</mi><mo>)</mo><mo>=</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>k</mi><mi>x</mi></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">f(x)=\frac{1}{1+e^{-kx}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.845108em;"></span><span class="strut bottom" style="height:1.262959em;vertical-align:-0.41785099999999986em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mrel">=</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.35951999999999984em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">1</span><span class="mbin">+</span><span class="mord"><span class="mord mathit">e</span><span class="vlist"><span style="top:-0.289em;margin-right:0.07142857142857144em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord">−</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathit">x</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span>  作为我们的 DB 函数，其中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>=</mo><msub><mi>P</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>−</mo><msub><mi>T</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">x=P_{i,j}-T_{i,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>。那么正标签的损失 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>l</mi><mrow><mo>+</mo></mrow></msub></mrow><annotation encoding="application/x-tex">l_{+}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.902771em;vertical-align:-0.208331em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord">+</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 和负标签的损失 l_{−} 分别为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>l</mi><mrow><mo>−</mo></mrow></msub><mo>=</mo><mo>−</mo><mi>log</mi><mrow><mo fence="true">(</mo><mn>1</mn><mo>−</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>k</mi><mi>x</mi></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">l_{-}=-\log\left(1-\frac{1}{1+e^{-kx}}\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.45em;"></span><span class="strut bottom" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord">−</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord">−</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">1</span><span class="mbin">+</span><span class="mord"><span class="mord mathit">e</span><span class="vlist"><span style="top:-0.289em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord">−</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathit">x</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p>
<p>​	我们可以很容易地用链式法则计算损失的微分：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><msub><mi>l</mi><mo>+</mo></msub></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mo>−</mo><mi>k</mi><mi>f</mi><mo>(</mo><mi>x</mi><mo>)</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>k</mi><mi>x</mi></mrow></msup></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><msub><mi>l</mi><mo>−</mo></msub></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mi>k</mi><mi>f</mi><mo>(</mo><mi>x</mi><mo>)</mo></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{aligned}&amp;\frac{\partial l_+}{\partial x}=-kf(x)e^{-kx}\\&amp;\frac{\partial l_-}{\partial x}=kf(x)\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:2.30744em;"></span><span class="strut bottom" style="height:4.11488em;vertical-align:-1.8074400000000002em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist"><span style="top:-0.9360000000000002em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:1.1214400000000002em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="col-align-l"><span class="vlist"><span style="top:-0.9360000000000002em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm" style="margin-right:0.05556em;">∂</span><span class="mord mathit">x</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord">+</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mrel">=</span><span class="mord">−</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mord"><span class="mord mathit">e</span><span class="vlist"><span style="top:-0.41300000000000003em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">−</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathit">x</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span style="top:1.1214400000000002em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm" style="margin-right:0.05556em;">∂</span><span class="mord mathit">x</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord">−</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mrel">=</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></span></span></p>
<p>​	<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>l</mi><mrow><mo>+</mo></mrow></msub></mrow><annotation encoding="application/x-tex">l_{+}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.902771em;vertical-align:-0.208331em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord">+</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 和 l_{−} 的微分中我们可以看出：</p>
<ol>
<li>梯度被放大因子 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span> 放大;</li>
<li>梯度的放大对于大多数错误预测的区域都是显著的（对于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mo>+</mo></msub></mrow><annotation encoding="application/x-tex">L_+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.891661em;vertical-align:-0.208331em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord">+</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x &lt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mrel">&lt;</span><span class="mord mathrm">0</span></span></span></span>；对于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mo>−</mo></msub></mrow><annotation encoding="application/x-tex">L_-</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.891661em;vertical-align:-0.208331em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord">−</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mrel">&gt;</span><span class="mord mathrm">0</span></span></span></span>），从而有利于优化，并有助于产生更独特的预测。此外，当 x = P_{i,j} − T_{i,j} 时，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">P</span></span></span></span> 的梯度在前景和背景之间受到 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span> 的影响和重新缩放。</li>
</ol>
<h4 id="adaptive-threshold" tabindex="-1" id="Adaptive-threshold">Adaptive threshold</h4>
<p>​    自适应阈值。</p>
<h4 id="deformable-convolution" tabindex="-1" id="Deformable-convolution">Deformable convolution</h4>
<p>​    <strong>可变形卷积</strong>可以为模型提供灵活的感受野，这对极端长宽比的文本实例尤其有益。接下来，在 ResNet-18 或 ResNet-50 主干中的 conv3、conv4 和 conv5 阶段，在所有 3×3 卷积层中应用调制可变形卷积。</p>
<h4 id="label-generation" tabindex="-1" id="Label-generation">Label generation</h4>
<p><img src="F5.webp" alt="webp"></p>
<center>Label generation。文本多边形的注释以红线显示。收缩和展开的多边形分别显示为蓝线和绿线</center>
<p>​    概率图的标签生成受到 PSENet 的启发。给定一个文本图像，其文本区域的每个多边形由一组线段描述：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>G</mi><mo>=</mo><mo>{</mo><msub><mi>S</mi><mi>k</mi></msub><msubsup><mo>}</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup></mrow><annotation encoding="application/x-tex">G=\{S_k\}^n_{k=1}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit">G</span><span class="mrel">=</span><span class="mopen">{</span><span class="mord"><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.05764em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose"><span class="mclose">}</span><span class="vlist"><span style="top:0.247em;margin-left:0em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span></span><span style="top:-0.4129999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord mathit">n</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p>
<p>​    <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span></span></span></span> 是顶点的数量，在不同的数据集中可能不同，例如，ICDAR 2015 数据集为 4（Karatzas 等人），CTW1500 数据集为 16。</p>
<p>​    通过使用 Vatti 剪裁算法将多边形 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">G</span></span></span></span> 缩小为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>G</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">G_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">G</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">s</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 来生成正区域。收缩的偏移量 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">D</span></span></span></span> 是根据原始多边形的周长 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span></span></span></span> 和面积 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">A</span></span></span></span> 计算得出的：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi><mo>=</mo><mfrac><mrow><mi>A</mi><mo>(</mo><mn>1</mn><mo>−</mo><msup><mi>r</mi><mn>2</mn></msup><mo>)</mo></mrow><mrow><mi>L</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">D=\frac{A(1-r^2)}{L}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.491108em;"></span><span class="strut bottom" style="height:2.177108em;vertical-align:-0.686em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">D</span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathit">L</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathit">A</span><span class="mopen">(</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mord"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p>​    其中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">r</span></span></span></span> 是收缩率，根据经验设置为 0.4。</p>
<p>​    通过类似的过程，我们可以为阈值映射生成标签。首先，将文本多边形 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">G</span></span></span></span> 以与 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>G</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">G_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">G</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">d</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 相同的偏移量 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">D</span></span></span></span> 展开。我们将 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>G</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">G_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">G</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">s</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>G</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">G_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">G</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">d</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 之间的间隙视为文本区域的边界，其中可以通过计算到 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">G</span></span></span></span> 中最近线段的距离来生成阈值图的标签。</p>
<hr>
<p>​	在 <code>data_loader</code> 中实现。</p>
<ul>
<li>根据人工标记的 gt 框（一系列坐标点），进行一些膨胀（dilate）和缩小（shrink）的操作</li>
<li>做一些 gt 框内的计算来得到 <code>probability_map</code> 和 <code>threshold_map</code></li>
</ul>
<h4 id="optimization" tabindex="-1" id="Optimization">Optimization</h4>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/code_plus/article/details/115763323">pytorch中实现Balanced Cross-Entropy_balanced cross entropy-CSDN博客</a></li>
</ul>
<p>​    损失函数 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span></span></span></span> 可以表示为概率映射 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">L_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">s</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 的损失、二进制映射 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">L_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">b</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 的损失和阈值映射 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">L_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">t</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 的损失的加权和</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mo>=</mo><msub><mi>L</mi><mi>s</mi></msub><mo>+</mo><mi>α</mi><mo>×</mo><msub><mi>L</mi><mi>b</mi></msub><mo>+</mo><mi>β</mi><mo>×</mo><msub><mi>L</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">L=L_s+\alpha\times L_b+\beta\times L_t
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit">L</span><span class="mrel">=</span><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">s</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.0037em;">α</span><span class="mbin">×</span><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">b</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.05278em;">β</span><span class="mbin">×</span><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">t</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p>
<p>​    <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.0037em;">α</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.05278em;">β</span></span></span></span> 分别取 1.0 和 10。</p>
<p>​    对 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">L_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">s</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">L_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">b</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 都应用了二进制交叉熵（BCE）损失：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>s</mi></msub><mo>=</mo><msub><mi>L</mi><mi>b</mi></msub><mo>=</mo><msub><mi mathvariant="normal">Σ</mi><mrow><mi>i</mi><mo>∈</mo><msub><mi>S</mi><mi>l</mi></msub></mrow></msub><msub><mi>y</mi><mi>i</mi></msub><mi>log</mi><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mo>(</mo><mn>1</mn><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><mo>)</mo><mi>log</mi><mo>(</mo><mn>1</mn><mo>−</mo><msub><mi>x</mi><mi>i</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">L_s=L_b=\Sigma_{i\in S_l}y_i\log x_i+(1-y_i)\log(1-x_i)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1.00586em;vertical-align:-0.25586em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">s</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">b</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathrm">Σ</span><span class="vlist"><span style="top:0.15000000000000002em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mrel">∈</span><span class="mord"><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="vlist"><span style="top:0.15122857142857138em;margin-right:0.07142857142857144em;margin-left:-0.05764em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit">x</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mopen">(</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mord"><span class="mord mathit">x</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span></span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BalanceCrossEntropyLoss</span>(nn.Module):<br>    <span class="hljs-comment"># 这个损失函数是交叉熵损失的一个平衡版本，用于处理类不平衡问题。它在计算损失时对正样本和负样本进行不同的加权，以便在训练时能更好地处理类别不平衡的情况。</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    Balanced cross entropy loss.</span><br><span class="hljs-string">    Shape:</span><br><span class="hljs-string">        - Input: :math:`(N, 1, H, W)`</span><br><span class="hljs-string">        - GT: :math:`(N, 1, H, W)`, same shape as the input</span><br><span class="hljs-string">        - Mask: :math:`(N, H, W)`, same spatial shape as the input</span><br><span class="hljs-string">        - Output: scalar.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Examples::</span><br><span class="hljs-string"></span><br><span class="hljs-string">        &gt;&gt;&gt; m = nn.Sigmoid()</span><br><span class="hljs-string">        &gt;&gt;&gt; loss = nn.BCELoss()</span><br><span class="hljs-string">        &gt;&gt;&gt; input = torch.randn(3, requires_grad=True)</span><br><span class="hljs-string">        &gt;&gt;&gt; target = torch.empty(3).random_(2)</span><br><span class="hljs-string">        &gt;&gt;&gt; output = loss(m(input), target)</span><br><span class="hljs-string">        &gt;&gt;&gt; output.backward()</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, negative_ratio=<span class="hljs-number">3.0</span>, eps=<span class="hljs-number">1e-6</span></span>):<br>        <span class="hljs-comment"># negative_ratio：一个负样本的比例，默认值为 3.0，表示负样本的数量是正样本数量的 3 倍。</span><br>        <span class="hljs-comment"># eps: 一个小的常数（1e-6），用于避免除零错误。</span><br>        <span class="hljs-built_in">super</span>(BalanceCrossEntropyLoss, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.negative_ratio = negative_ratio<br>        <span class="hljs-variable language_">self</span>.eps = eps<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self,</span><br><span class="hljs-params">                pred: torch.Tensor,  <span class="hljs-comment"># pred: 网络的预测值，形状为 (N, 1, H, W)。</span></span><br><span class="hljs-params">                gt: torch.Tensor,  <span class="hljs-comment"># 目标值，形状同 pred。</span></span><br><span class="hljs-params">                mask: torch.Tensor,  <span class="hljs-comment"># 掩码，形状为 (N, H, W)，用来指示正样本区域。</span></span><br><span class="hljs-params">                return_origin=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            pred: shape :math:`(N, 1, H, W)`, the prediction of network</span><br><span class="hljs-string">            gt: shape :math:`(N, 1, H, W)`, the target</span><br><span class="hljs-string">            mask: shape :math:`(N, H, W)`, the mask indicates positive regions</span><br><span class="hljs-string">        &#x27;&#x27;&#x27;</span><br>        <span class="hljs-comment"># 计算正样本和负样本的数量，并使用负样本比例限制负样本的数量。</span><br>        positive = (gt * mask).byte()<br>        negative = ((<span class="hljs-number">1</span> - gt) * mask).byte()<br>        positive_count = <span class="hljs-built_in">int</span>(positive.<span class="hljs-built_in">float</span>().<span class="hljs-built_in">sum</span>())<br>        negative_count = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">int</span>(negative.<span class="hljs-built_in">float</span>().<span class="hljs-built_in">sum</span>()), <span class="hljs-built_in">int</span>(positive_count * <span class="hljs-variable language_">self</span>.negative_ratio))<br>        loss = nn.functional.binary_cross_entropy(pred, gt, reduction=<span class="hljs-string">&#x27;none&#x27;</span>)<br>        <span class="hljs-comment"># 计算每个位置的二进制交叉熵损失。</span><br>        positive_loss = loss * positive.<span class="hljs-built_in">float</span>()<br>        negative_loss = loss * negative.<span class="hljs-built_in">float</span>()<br>        <span class="hljs-comment"># negative_loss, _ = torch.topk(negative_loss.view(-1).contiguous(), negative_count)</span><br>        <span class="hljs-comment"># 对正样本和负样本分别计算损失，然后将负样本的损失限制为一定的数量。</span><br>        negative_loss, _ = negative_loss.view(-<span class="hljs-number">1</span>).topk(negative_count)<br><br>        <span class="hljs-comment"># 最终计算加权的总损失并返回。</span><br>        balance_loss = (positive_loss.<span class="hljs-built_in">sum</span>() + negative_loss.<span class="hljs-built_in">sum</span>()) / (positive_count + negative_count + <span class="hljs-variable language_">self</span>.eps)<br><br>        <span class="hljs-keyword">if</span> return_origin:<br>            <span class="hljs-keyword">return</span> balance_loss, loss<br>        <span class="hljs-keyword">return</span> balance_loss<br></code></pre></td></tr></table></figure>
<p>​    <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">L_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">t</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 被计算为扩展文本多边形 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>G</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">G_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">G</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">d</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 内的预测和标签之间的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">L_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 距离之和：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="normal">Σ</mi><mrow><mi>i</mi><mo>∈</mo><msub><mi>R</mi><mi>d</mi></msub></mrow></msub><mi mathvariant="normal">∣</mi><msubsup><mi>y</mi><mi>i</mi><mo>∗</mo></msubsup><mo>−</mo><msubsup><mi>x</mi><mi>i</mi><mo>∗</mo></msubsup><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">L_t=\Sigma_{i\in R_d}|y^*_i-x^*_i|
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1.00586em;vertical-align:-0.25586em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">t</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathrm">Σ</span><span class="vlist"><span style="top:0.15000000000000002em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mrel">∈</span><span class="mord"><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="vlist"><span style="top:0.15122857142857138em;margin-right:0.07142857142857144em;margin-left:-0.00773em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord mathit">d</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">∣</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.247em;margin-left:-0.03588em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span style="top:-0.4129999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord"><span class="mord mathit">x</span><span class="vlist"><span style="top:0.247em;margin-left:0em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span style="top:-0.4129999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord">∗</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">∣</span></span></span></span></span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MaskL1Loss</span>(nn.Module):<br>    <span class="hljs-comment"># 这是一个基于 L1 损失的变体，结合了掩码，仅在感兴趣的区域计算损失。</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, eps=<span class="hljs-number">1e-6</span></span>):<br>        <span class="hljs-built_in">super</span>(MaskL1Loss, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.eps = eps<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, pred: torch.Tensor, gt, mask</span>):<br>        <span class="hljs-comment"># 计算预测值和真实值之间的绝对差异，并根据掩码计算加权和。</span><br>        loss = (torch.<span class="hljs-built_in">abs</span>(pred - gt) * mask).<span class="hljs-built_in">sum</span>() / (mask.<span class="hljs-built_in">sum</span>() + <span class="hljs-variable language_">self</span>.eps)<br>        <span class="hljs-keyword">return</span> loss<br></code></pre></td></tr></table></figure>
<p>​    在推理阶段，我们可以使用概率图或近似二进制图来生成文本边界框，这会产生几乎相同的结果。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>D</mi><mrow><mi mathvariant="normal">′</mi></mrow></msup><mo>=</mo><mfrac><mrow><msup><mi>A</mi><mrow><mi mathvariant="normal">′</mi></mrow></msup><mo>×</mo><msup><mi>r</mi><mrow><mi mathvariant="normal">′</mi></mrow></msup></mrow><mrow><msup><mi>L</mi><mrow><mi mathvariant="normal">′</mi></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">D&#x27;=\frac{A&#x27;\times r&#x27;}{L&#x27;}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.428892em;"></span><span class="strut bottom" style="height:2.114892em;vertical-align:-0.686em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02778em;">D</span><span class="vlist"><span style="top:-0.413em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">′</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:-0.289em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">′</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit">A</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">′</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">×</span><span class="mord"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">′</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p>​    其中 A’ 是收缩多边形的面积；<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>L</mi><mrow><mi mathvariant="normal">′</mi></mrow></msup></mrow><annotation encoding="application/x-tex">L&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.751892em;"></span><span class="strut bottom" style="height:0.751892em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">′</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 是收缩多边形的周长；<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>r</mi><mrow><mi mathvariant="normal">′</mi></mrow></msup></mrow><annotation encoding="application/x-tex">r&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.751892em;"></span><span class="strut bottom" style="height:0.751892em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">′</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 根据经验设定为 1.5。</p>
<p>​	<code>DB_loss.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><br><span class="hljs-keyword">from</span> models.losses.basic_loss <span class="hljs-keyword">import</span> BalanceCrossEntropyLoss, MaskL1Loss, DiceLoss<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DBLoss</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, alpha=<span class="hljs-number">1.0</span>, beta=<span class="hljs-number">10</span>, ohem_ratio=<span class="hljs-number">3</span>, reduction=<span class="hljs-string">&#x27;mean&#x27;</span>, eps=<span class="hljs-number">1e-6</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Implement PSE Loss.</span><br><span class="hljs-string">        :param alpha: binary_map loss 前面的系数</span><br><span class="hljs-string">        :param beta: threshold_map loss 前面的系数</span><br><span class="hljs-string">        :param ohem_ratio: OHEM 的比例</span><br><span class="hljs-string">        :param reduction: &#x27;mean&#x27; or &#x27;sum&#x27;对 batch 里的 loss 算均值或求和</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">super</span>().__init__()<br>        <span class="hljs-keyword">assert</span> reduction <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;mean&#x27;</span>, <span class="hljs-string">&#x27;sum&#x27;</span>], <span class="hljs-string">&quot; reduction must in [&#x27;mean&#x27;,&#x27;sum&#x27;]&quot;</span><br>        <span class="hljs-comment"># alpha 和 beta 是控制不同损失项权重的系数。</span><br>        <span class="hljs-variable language_">self</span>.alpha = alpha<br>        <span class="hljs-variable language_">self</span>.beta = beta<br>        <span class="hljs-variable language_">self</span>.bce_loss = BalanceCrossEntropyLoss(negative_ratio=ohem_ratio)<br>        <span class="hljs-variable language_">self</span>.dice_loss = DiceLoss(eps=eps)<br>        <span class="hljs-variable language_">self</span>.l1_loss = MaskL1Loss(eps=eps)<br>        <span class="hljs-variable language_">self</span>.ohem_ratio = ohem_ratio  <span class="hljs-comment"># 用于 OHEM（在线困难样本挖掘）的比例。</span><br>        <span class="hljs-variable language_">self</span>.reduction = reduction  <span class="hljs-comment"># 指定了损失的归约方式（均值或总和）。</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, pred, batch</span>):<br>        shrink_maps = pred[:, <span class="hljs-number">0</span>, :, :]<br>        threshold_maps = pred[:, <span class="hljs-number">1</span>, :, :]<br>        binary_maps = pred[:, <span class="hljs-number">2</span>, :, :]<br><br>        loss_shrink_maps = <span class="hljs-variable language_">self</span>.bce_loss(shrink_maps, batch[<span class="hljs-string">&#x27;shrink_map&#x27;</span>], batch[<span class="hljs-string">&#x27;shrink_mask&#x27;</span>])  <span class="hljs-comment"># 对 shrink_maps 使用交叉熵损失（OHEM）。</span><br>        loss_threshold_maps = <span class="hljs-variable language_">self</span>.l1_loss(threshold_maps, batch[<span class="hljs-string">&#x27;threshold_map&#x27;</span>], batch[<span class="hljs-string">&#x27;threshold_mask&#x27;</span>])  <span class="hljs-comment"># 对 threshold_maps 使用 L1 损失。</span><br>        metrics = <span class="hljs-built_in">dict</span>(loss_shrink_maps=loss_shrink_maps, loss_threshold_maps=loss_threshold_maps)  <span class="hljs-comment"># 如果 pred 包含多于两个通道，还计算 binary_maps 的 Dice 损失。</span><br>        <span class="hljs-keyword">if</span> pred.size()[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">2</span>:<br>            loss_binary_maps = <span class="hljs-variable language_">self</span>.dice_loss(binary_maps, batch[<span class="hljs-string">&#x27;shrink_map&#x27;</span>], batch[<span class="hljs-string">&#x27;shrink_mask&#x27;</span>])<br>            metrics[<span class="hljs-string">&#x27;loss_binary_maps&#x27;</span>] = loss_binary_maps<br>            loss_all = <span class="hljs-variable language_">self</span>.alpha * loss_shrink_maps + <span class="hljs-variable language_">self</span>.beta * loss_threshold_maps + loss_binary_maps  <span class="hljs-comment"># 汇总各个损失项，并根据是否包含 binary_maps 来调整总损失 (loss_all)。</span><br>            metrics[<span class="hljs-string">&#x27;loss&#x27;</span>] = loss_all  <span class="hljs-comment"># 返回一个包含各个损失项和总损失的字典 metrics。</span><br>        <span class="hljs-keyword">else</span>:<br>            metrics[<span class="hljs-string">&#x27;loss&#x27;</span>] = loss_shrink_maps<br>        <span class="hljs-keyword">return</span> metrics<br></code></pre></td></tr></table></figure>
<h2 id="experiments" tabindex="-1" id="Experiments">Experiments</h2>
<div class="tabs" id="train"><div class="nav-tabs"><button type="button" class="tab active" data-href="train-1">train.py</button><button type="button" class="tab" data-href="train-2">trainer.py</button></div><div class="tab-contents"><div class="tab-item-content active" id="train-1"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> print_function<br><br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">import</span> anyconfig<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_args</span>():<br>    parser = argparse.ArgumentParser(description=<span class="hljs-string">&#x27;DBNet.pytorch&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--config_file&#x27;</span>, default=<span class="hljs-string">&#x27;config/open_dataset_resnet18_FPN_DBhead_polyLR.yaml&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--local_rank&#x27;</span>, dest=<span class="hljs-string">&#x27;local_rank&#x27;</span>, default=<span class="hljs-number">0</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Use distributed training&#x27;</span>)<br><br>    args = parser.parse_args()<br>    <span class="hljs-keyword">return</span> args<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">config</span>):<br>    <span class="hljs-comment"># 导入必要的模块，包括模型构建、损失函数、数据加载器、训练器、后处理和评估指标。</span><br>    <span class="hljs-keyword">import</span> torch<br>    <span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> build_model, build_loss<br>    <span class="hljs-keyword">from</span> data_loader <span class="hljs-keyword">import</span> get_dataloader<br>    <span class="hljs-keyword">from</span> trainer <span class="hljs-keyword">import</span> Trainer<br>    <span class="hljs-keyword">from</span> post_processing <span class="hljs-keyword">import</span> get_post_processing<br>    <span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> get_metric<br>    <span class="hljs-comment"># 检查是否有多个 GPU，如果有，则初始化分布式训练环境。</span><br>    <span class="hljs-keyword">if</span> torch.cuda.device_count() &gt; <span class="hljs-number">1</span>:<br>        torch.cuda.set_device(args.local_rank)<br>        torch.distributed.init_process_group(backend=<span class="hljs-string">&quot;nccl&quot;</span>, init_method=<span class="hljs-string">&quot;env://&quot;</span>, world_size=torch.cuda.device_count(), rank=args.local_rank)<br>        config[<span class="hljs-string">&#x27;distributed&#x27;</span>] = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        config[<span class="hljs-string">&#x27;distributed&#x27;</span>] = <span class="hljs-literal">False</span><br>    config[<span class="hljs-string">&#x27;local_rank&#x27;</span>] = args.local_rank<br><br>    <span class="hljs-comment"># 根据配置文件加载训练和验证数据加载器。</span><br>    train_loader = get_dataloader(config[<span class="hljs-string">&#x27;dataset&#x27;</span>][<span class="hljs-string">&#x27;train&#x27;</span>], config[<span class="hljs-string">&#x27;distributed&#x27;</span>])<br>    <span class="hljs-keyword">assert</span> train_loader <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;validate&#x27;</span> <span class="hljs-keyword">in</span> config[<span class="hljs-string">&#x27;dataset&#x27;</span>]:<br>        validate_loader = get_dataloader(config[<span class="hljs-string">&#x27;dataset&#x27;</span>][<span class="hljs-string">&#x27;validate&#x27;</span>], <span class="hljs-literal">False</span>)<br>    <span class="hljs-keyword">else</span>:<br>        validate_loader = <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 构建损失函数并将其移动到 GPU。</span><br>    criterion = build_loss(config[<span class="hljs-string">&#x27;loss&#x27;</span>]).cuda()<br><br>    <span class="hljs-comment"># 配置模型的输入通道数（彩色图像为 3 通道，灰度图像为 1 通道）。</span><br>    config[<span class="hljs-string">&#x27;arch&#x27;</span>][<span class="hljs-string">&#x27;backbone&#x27;</span>][<span class="hljs-string">&#x27;in_channels&#x27;</span>] = <span class="hljs-number">3</span> <span class="hljs-keyword">if</span> config[<span class="hljs-string">&#x27;dataset&#x27;</span>][<span class="hljs-string">&#x27;train&#x27;</span>][<span class="hljs-string">&#x27;dataset&#x27;</span>][<span class="hljs-string">&#x27;args&#x27;</span>][<span class="hljs-string">&#x27;img_mode&#x27;</span>] != <span class="hljs-string">&#x27;GRAY&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span><br>    model = build_model(config[<span class="hljs-string">&#x27;arch&#x27;</span>])<br><br>    <span class="hljs-comment"># 构建模型、后处理函数和评估指标。</span><br>    post_p = get_post_processing(config[<span class="hljs-string">&#x27;post_processing&#x27;</span>])<br>    metric = get_metric(config[<span class="hljs-string">&#x27;metric&#x27;</span>])<br><br>    <span class="hljs-comment"># 创建 Trainer 对象并开始训练。</span><br>    trainer = Trainer(config=config,<br>                      model=model,<br>                      criterion=criterion,<br>                      train_loader=train_loader,<br>                      post_process=post_p,<br>                      metric_cls=metric,<br>                      validate_loader=validate_loader)<br>    trainer.train()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># 处理模块路径，确保当前目录和上级目录在 Python 路径中。</span><br>    <span class="hljs-keyword">import</span> sys<br>    <span class="hljs-keyword">import</span> pathlib<br>    __dir__ = pathlib.Path(os.path.abspath(__file__))<br>    sys.path.append(<span class="hljs-built_in">str</span>(__dir__))<br>    sys.path.append(<span class="hljs-built_in">str</span>(__dir__.parent.parent))<br>    <span class="hljs-comment"># project = &#x27;DBNet.pytorch&#x27;  # 工作项目根目录</span><br>    <span class="hljs-comment"># sys.path.append(os.getcwd().split(project)[0] + project)</span><br><br>    <span class="hljs-comment"># 使用 anyconfig 读取配置文件，并解析基础配置。</span><br>    <span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> parse_config<br><br>    args = init_args()<br>    <span class="hljs-keyword">assert</span> os.path.exists(args.config_file)<br>    config = anyconfig.load(<span class="hljs-built_in">open</span>(args.config_file, <span class="hljs-string">&#x27;rb&#x27;</span>))<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;base&#x27;</span> <span class="hljs-keyword">in</span> config:<br>        config = parse_config(config)<br>    <span class="hljs-comment"># 调用 main 函数开始模型训练。</span><br>    main(config)<br></code></pre></td></tr></table></figure></div><div class="tab-item-content" id="train-2"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torchvision.utils <span class="hljs-keyword">as</span> vutils<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><br><span class="hljs-keyword">from</span> base <span class="hljs-keyword">import</span> BaseTrainer<br><span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> WarmupPolyLR, runningScore, cal_text_score<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Trainer</span>(<span class="hljs-title class_ inherited__">BaseTrainer</span>):<br>    <span class="hljs-comment"># 初始化：__init__ 方法接受多个参数，包括配置 (config)、模型 (model)、损失函数 (criterion)、训练和验证数据加载器 (train_loader 和 validate_loader)、评估指标类 (metric_cls)、以及可选的后处理函数 (post_process)。</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config, model, criterion, train_loader, validate_loader, metric_cls, post_process=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-built_in">super</span>(Trainer, <span class="hljs-variable language_">self</span>).__init__(config, model, criterion)<br>        <span class="hljs-comment"># 参数设置：从配置中读取训练迭代次数 (show_images_iter)，并初始化训练和验证数据加载器。若验证数据加载器存在，确保提供了后处理函数和评估指标类。</span><br>        <span class="hljs-variable language_">self</span>.show_images_iter = <span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&#x27;trainer&#x27;</span>][<span class="hljs-string">&#x27;show_images_iter&#x27;</span>]<br>        <span class="hljs-variable language_">self</span>.train_loader = train_loader<br>        <span class="hljs-keyword">if</span> validate_loader <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">assert</span> post_process <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> metric_cls <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-variable language_">self</span>.validate_loader = validate_loader<br>        <span class="hljs-variable language_">self</span>.post_process = post_process<br>        <span class="hljs-variable language_">self</span>.metric_cls = metric_cls<br>        <span class="hljs-variable language_">self</span>.train_loader_len = <span class="hljs-built_in">len</span>(train_loader)<br>        <span class="hljs-comment"># 学习率调度器：根据配置，设置学习率调度器 WarmupPolyLR，用于调整学习率。它支持学习率的预热和多项式衰减。</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&#x27;lr_scheduler&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;WarmupPolyLR&#x27;</span>:<br>            warmup_iters = config[<span class="hljs-string">&#x27;lr_scheduler&#x27;</span>][<span class="hljs-string">&#x27;args&#x27;</span>][<span class="hljs-string">&#x27;warmup_epoch&#x27;</span>] * <span class="hljs-variable language_">self</span>.train_loader_len<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.start_epoch &gt; <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&#x27;lr_scheduler&#x27;</span>][<span class="hljs-string">&#x27;args&#x27;</span>][<span class="hljs-string">&#x27;last_epoch&#x27;</span>] = (<span class="hljs-variable language_">self</span>.start_epoch - <span class="hljs-number">1</span>) * <span class="hljs-variable language_">self</span>.train_loader_len<br>            <span class="hljs-variable language_">self</span>.scheduler = WarmupPolyLR(<span class="hljs-variable language_">self</span>.optimizer, max_iters=<span class="hljs-variable language_">self</span>.epochs * <span class="hljs-variable language_">self</span>.train_loader_len,<br>                                          warmup_iters=warmup_iters, **config[<span class="hljs-string">&#x27;lr_scheduler&#x27;</span>][<span class="hljs-string">&#x27;args&#x27;</span>])<br>        <span class="hljs-comment"># 日志记录：记录训练和验证数据集的样本数量和数据加载器的数量。</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.validate_loader <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-variable language_">self</span>.logger_info(<br>                <span class="hljs-string">&#x27;train dataset has &#123;&#125; samples,&#123;&#125; in dataloader, validate dataset has &#123;&#125; samples,&#123;&#125; in dataloader&#x27;</span>.<span class="hljs-built_in">format</span>(<br>                    <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.train_loader.dataset), <span class="hljs-variable language_">self</span>.train_loader_len, <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.validate_loader.dataset), <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.validate_loader)))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.logger_info(<span class="hljs-string">&#x27;train dataset has &#123;&#125; samples,&#123;&#125; in dataloader&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.train_loader.dataset), <span class="hljs-variable language_">self</span>.train_loader_len))<br><br>    <span class="hljs-comment"># 这段代码定义了 _train_epoch 方法，用于训练模型一个训练周期（epoch）。</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_train_epoch</span>(<span class="hljs-params">self, epoch</span>):<br>        <span class="hljs-comment"># 模型训练模式：调用 self.model.train() 设置模型为训练模式。</span><br>        <span class="hljs-variable language_">self</span>.model.train()<br>        <span class="hljs-comment"># 时间记录：记录周期和批次的开始时间。</span><br>        epoch_start = time.time()<br>        batch_start = time.time()<br>        train_loss = <span class="hljs-number">0.</span><br>        running_metric_text = runningScore(<span class="hljs-number">2</span>)<br>        <span class="hljs-comment"># 初始化：初始化累计损失 train_loss 和运行中的指标 running_metric_text，并获取当前学习率 lr。</span><br>        lr = <span class="hljs-variable language_">self</span>.optimizer.param_groups[<span class="hljs-number">0</span>][<span class="hljs-string">&#x27;lr&#x27;</span>]<br><br>        <span class="hljs-comment"># 遍历数据：遍历训练数据加载器中的每个批次：</span><br>        <span class="hljs-keyword">for</span> i, batch <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-variable language_">self</span>.train_loader):<br>            <span class="hljs-keyword">if</span> i &gt;= <span class="hljs-variable language_">self</span>.train_loader_len:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-variable language_">self</span>.global_step += <span class="hljs-number">1</span><br>            lr = <span class="hljs-variable language_">self</span>.optimizer.param_groups[<span class="hljs-number">0</span>][<span class="hljs-string">&#x27;lr&#x27;</span>]<br><br>            <span class="hljs-comment"># 数据进行转换和丢到 gpu</span><br>            <span class="hljs-comment"># 将数据移动到 GPU 上。</span><br>            <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> batch.items():<br>                <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(value, torch.Tensor):<br>                        batch[key] = value.to(<span class="hljs-variable language_">self</span>.device)<br>            cur_batch_size = batch[<span class="hljs-string">&#x27;img&#x27;</span>].size()[<span class="hljs-number">0</span>]<br><br>            <span class="hljs-comment"># 通过模型生成预测 preds。</span><br>            preds = <span class="hljs-variable language_">self</span>.model(batch[<span class="hljs-string">&#x27;img&#x27;</span>])<br>            <span class="hljs-comment"># 计算损失 loss_dict，并执行反向传播和优化步骤。</span><br>            loss_dict = <span class="hljs-variable language_">self</span>.criterion(preds, batch)<br>            <span class="hljs-comment"># backward</span><br>            <span class="hljs-variable language_">self</span>.optimizer.zero_grad()<br>            loss_dict[<span class="hljs-string">&#x27;loss&#x27;</span>].backward()<br>            <span class="hljs-variable language_">self</span>.optimizer.step()<br>            <span class="hljs-comment"># 如果使用了 WarmupPolyLR，更新学习率调度器。</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&#x27;lr_scheduler&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;WarmupPolyLR&#x27;</span>:<br>                <span class="hljs-variable language_">self</span>.scheduler.step()<br>            <span class="hljs-comment"># acc iou</span><br>            <span class="hljs-comment"># 计算指标 score_shrink_map，并记录损失和准确度信息。</span><br>            score_shrink_map = cal_text_score(preds[:, <span class="hljs-number">0</span>, :, :], batch[<span class="hljs-string">&#x27;shrink_map&#x27;</span>], batch[<span class="hljs-string">&#x27;shrink_mask&#x27;</span>], running_metric_text,<br>                                              thred=<span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&#x27;post_processing&#x27;</span>][<span class="hljs-string">&#x27;args&#x27;</span>][<span class="hljs-string">&#x27;thresh&#x27;</span>])<br><br>            <span class="hljs-comment"># loss 和 acc 记录到日志</span><br>            <span class="hljs-comment"># 日志记录：将损失和各个指标记录为字符串 loss_str，并累加到总训练损失 train_loss。</span><br>            loss_str = <span class="hljs-string">&#x27;loss: &#123;:.4f&#125;, &#x27;</span>.<span class="hljs-built_in">format</span>(loss_dict[<span class="hljs-string">&#x27;loss&#x27;</span>].item())<br>            <span class="hljs-keyword">for</span> idx, (key, value) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(loss_dict.items()):<br>                loss_dict[key] = value.item()<br>                <span class="hljs-keyword">if</span> key == <span class="hljs-string">&#x27;loss&#x27;</span>:<br>                    <span class="hljs-keyword">continue</span><br>                loss_str += <span class="hljs-string">&#x27;&#123;&#125;: &#123;:.4f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(key, loss_dict[key])<br>                <span class="hljs-keyword">if</span> idx &lt; <span class="hljs-built_in">len</span>(loss_dict) - <span class="hljs-number">1</span>:<br>                    loss_str += <span class="hljs-string">&#x27;, &#x27;</span><br><br>            train_loss += loss_dict[<span class="hljs-string">&#x27;loss&#x27;</span>]<br>            acc = score_shrink_map[<span class="hljs-string">&#x27;Mean Acc&#x27;</span>]<br>            iou_shrink_map = score_shrink_map[<span class="hljs-string">&#x27;Mean IoU&#x27;</span>]<br><br>            <span class="hljs-comment"># 条件：每隔 log_iter 步记录一次日志。</span><br>            <span class="hljs-comment"># 指标：计算每秒处理样本的速度，并记录准确率、IoU、损失和学习率。</span><br>            <span class="hljs-comment"># 日志记录：使用 self.logger_info 输出这些指标，以便监控训练过程。</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.global_step % <span class="hljs-variable language_">self</span>.log_iter == <span class="hljs-number">0</span>:<br>                batch_time = time.time() - batch_start<br>                <span class="hljs-variable language_">self</span>.logger_info(<br>                    <span class="hljs-string">&#x27;[&#123;&#125;/&#123;&#125;], [&#123;&#125;/&#123;&#125;], global_step: &#123;&#125;, speed: &#123;:.1f&#125; samples/sec, acc: &#123;:.4f&#125;, iou_shrink_map: &#123;:.4f&#125;, &#123;&#125;, lr:&#123;:.6&#125;, time:&#123;:.2f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<br>                        epoch, <span class="hljs-variable language_">self</span>.epochs, i + <span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.train_loader_len, <span class="hljs-variable language_">self</span>.global_step, <span class="hljs-variable language_">self</span>.log_iter * cur_batch_size / batch_time, acc,<br>                        iou_shrink_map, loss_str, lr, batch_time))<br>                batch_start = time.time()<br><br>            <span class="hljs-comment"># 条件：如果启用了 TensorBoard，则写入日志。</span><br>            <span class="hljs-comment"># 损失和指标：将各种训练指标和损失记录到 TensorBoard 中以便可视化。</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.tensorboard_enable <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&#x27;local_rank&#x27;</span>] == <span class="hljs-number">0</span>:<br>                <span class="hljs-comment"># write tensorboard</span><br>                <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> loss_dict.items():<br>                    <span class="hljs-variable language_">self</span>.writer.add_scalar(<span class="hljs-string">&#x27;TRAIN/LOSS/&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(key), value, <span class="hljs-variable language_">self</span>.global_step)<br>                <span class="hljs-variable language_">self</span>.writer.add_scalar(<span class="hljs-string">&#x27;TRAIN/ACC_IOU/acc&#x27;</span>, acc, <span class="hljs-variable language_">self</span>.global_step)<br>                <span class="hljs-variable language_">self</span>.writer.add_scalar(<span class="hljs-string">&#x27;TRAIN/ACC_IOU/iou_shrink_map&#x27;</span>, iou_shrink_map, <span class="hljs-variable language_">self</span>.global_step)<br>                <span class="hljs-variable language_">self</span>.writer.add_scalar(<span class="hljs-string">&#x27;TRAIN/lr&#x27;</span>, lr, <span class="hljs-variable language_">self</span>.global_step)<br>                <span class="hljs-comment"># 图像可视化：条件：每隔 show_images_iter 步可视化一次图像。</span><br>                <span class="hljs-comment"># 图像和标签：将原始图像、真实标签和模型预测结果添加到 TensorBoard 中。</span><br>                <span class="hljs-comment"># 可视化：使用 vutils.make_grid 创建图像网格以便更好地可视化。</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.global_step % <span class="hljs-variable language_">self</span>.show_images_iter == <span class="hljs-number">0</span>:<br>                    <span class="hljs-comment"># show images on tensorboard</span><br>                    <span class="hljs-variable language_">self</span>.inverse_normalize(batch[<span class="hljs-string">&#x27;img&#x27;</span>])<br>                    <span class="hljs-variable language_">self</span>.writer.add_images(<span class="hljs-string">&#x27;TRAIN/imgs&#x27;</span>, batch[<span class="hljs-string">&#x27;img&#x27;</span>], <span class="hljs-variable language_">self</span>.global_step)<br>                    <span class="hljs-comment"># shrink_labels and threshold_labels</span><br>                    shrink_labels = batch[<span class="hljs-string">&#x27;shrink_map&#x27;</span>]<br>                    threshold_labels = batch[<span class="hljs-string">&#x27;threshold_map&#x27;</span>]<br>                    shrink_labels[shrink_labels &lt;= <span class="hljs-number">0.5</span>] = <span class="hljs-number">0</span><br>                    shrink_labels[shrink_labels &gt; <span class="hljs-number">0.5</span>] = <span class="hljs-number">1</span><br>                    show_label = torch.cat([shrink_labels, threshold_labels])<br>                    show_label = vutils.make_grid(show_label.unsqueeze(<span class="hljs-number">1</span>), nrow=cur_batch_size, normalize=<span class="hljs-literal">False</span>, padding=<span class="hljs-number">20</span>, pad_value=<span class="hljs-number">1</span>)<br>                    <span class="hljs-variable language_">self</span>.writer.add_image(<span class="hljs-string">&#x27;TRAIN/gt&#x27;</span>, show_label, <span class="hljs-variable language_">self</span>.global_step)<br>                    <span class="hljs-comment"># model output</span><br>                    show_pred = []<br>                    <span class="hljs-keyword">for</span> kk <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(preds.shape[<span class="hljs-number">1</span>]):<br>                        show_pred.append(preds[:, kk, :, :])<br>                    show_pred = torch.cat(show_pred)<br>                    show_pred = vutils.make_grid(show_pred.unsqueeze(<span class="hljs-number">1</span>), nrow=cur_batch_size, normalize=<span class="hljs-literal">False</span>, padding=<span class="hljs-number">20</span>, pad_value=<span class="hljs-number">1</span>)<br>                    <span class="hljs-variable language_">self</span>.writer.add_image(<span class="hljs-string">&#x27;TRAIN/preds&#x27;</span>, show_pred, <span class="hljs-variable language_">self</span>.global_step)<br>        <span class="hljs-comment"># 总结：返回一个包含每个 epoch 的平均训练损失、学习率、总时间和 epoch 编号的字典。</span><br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&#x27;train_loss&#x27;</span>: train_loss / <span class="hljs-variable language_">self</span>.train_loader_len, <span class="hljs-string">&#x27;lr&#x27;</span>: lr, <span class="hljs-string">&#x27;time&#x27;</span>: time.time() - epoch_start,<br>                <span class="hljs-string">&#x27;epoch&#x27;</span>: epoch&#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_eval</span>(<span class="hljs-params">self, epoch</span>):<br>        <span class="hljs-comment"># 这将影响模型的行为，比如在评估时关闭 dropout 和 batch normalization。</span><br>        <span class="hljs-variable language_">self</span>.model.<span class="hljs-built_in">eval</span>()<br>        <span class="hljs-comment"># torch.cuda.empty_cache()  # speed up evaluating after training finished</span><br>        <span class="hljs-comment"># raw_metrics 用来存储每个批次的评估指标，total_frame 用来记录总的处理帧数，total_time 记录总的处理时间。</span><br>        raw_metrics = []<br>        total_frame = <span class="hljs-number">0.0</span><br>        total_time = <span class="hljs-number">0.0</span><br>        <span class="hljs-keyword">for</span> i, batch <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">enumerate</span>(<span class="hljs-variable language_">self</span>.validate_loader), total=<span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.validate_loader), desc=<span class="hljs-string">&#x27;test model&#x27;</span>):<br>            <span class="hljs-comment"># 关闭梯度计算：这用于避免计算梯度，从而减少内存使用和加快计算速度。</span><br>            <span class="hljs-keyword">with</span> torch.no_grad():<br>                <span class="hljs-comment"># 数据进行转换和丢到gpu</span><br>                <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> batch.items():<br>                    <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(value, torch.Tensor):<br>                            batch[key] = value.to(<span class="hljs-variable language_">self</span>.device)<br>                <span class="hljs-comment"># 记录开始时间并进行预测：</span><br>                start = time.time()<br>                preds = <span class="hljs-variable language_">self</span>.model(batch[<span class="hljs-string">&#x27;img&#x27;</span>])<br>                <span class="hljs-comment"># 对预测结果进行后处理：</span><br>                boxes, scores = <span class="hljs-variable language_">self</span>.post_process(batch, preds,is_output_polygon=<span class="hljs-variable language_">self</span>.metric_cls.is_output_polygon)<br>                <span class="hljs-comment"># 更新统计数据：</span><br>                total_frame += batch[<span class="hljs-string">&#x27;img&#x27;</span>].size()[<span class="hljs-number">0</span>]<br>                total_time += time.time() - start<br>                <span class="hljs-comment"># 计算并记录评估指标：</span><br>                raw_metric = <span class="hljs-variable language_">self</span>.metric_cls.validate_measure(batch, (boxes, scores))<br>                raw_metrics.append(raw_metric)<br>        <span class="hljs-comment"># 汇总指标：</span><br>        metrics = <span class="hljs-variable language_">self</span>.metric_cls.gather_measure(raw_metrics)<br>        <span class="hljs-comment"># 记录每秒帧数（FPS）：</span><br>        <span class="hljs-variable language_">self</span>.logger_info(<span class="hljs-string">&#x27;FPS:&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(total_frame / total_time))<br>        <span class="hljs-comment"># 返回指标：</span><br>        <span class="hljs-keyword">return</span> metrics[<span class="hljs-string">&#x27;recall&#x27;</span>].avg, metrics[<span class="hljs-string">&#x27;precision&#x27;</span>].avg, metrics[<span class="hljs-string">&#x27;fmeasure&#x27;</span>].avg<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_on_epoch_finish</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 这个方法在每个训练周期结束时执行，执行以下操作：</span><br>        <span class="hljs-comment"># 记录当前训练周期的信息：</span><br>        <span class="hljs-variable language_">self</span>.logger_info(<span class="hljs-string">&#x27;[&#123;&#125;/&#123;&#125;], train_loss: &#123;:.4f&#125;, time: &#123;:.4f&#125;, lr: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<br>            <span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;epoch&#x27;</span>], <span class="hljs-variable language_">self</span>.epochs, <span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;train_loss&#x27;</span>], <span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;time&#x27;</span>],<br>            <span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;lr&#x27;</span>]))<br>        <span class="hljs-comment"># 保存模型检查点：</span><br>        net_save_path = <span class="hljs-string">&#x27;&#123;&#125;/model_latest.pth&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-variable language_">self</span>.checkpoint_dir)<br>        net_save_path_best = <span class="hljs-string">&#x27;&#123;&#125;/model_best.pth&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-variable language_">self</span>.checkpoint_dir)<br><br>        <span class="hljs-comment"># 如果是主进程：</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&#x27;local_rank&#x27;</span>] == <span class="hljs-number">0</span>:<br>            <span class="hljs-comment"># 保存当前模型检查点：</span><br>            <span class="hljs-variable language_">self</span>._save_checkpoint(<span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;epoch&#x27;</span>], net_save_path)<br>            save_best = <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.validate_loader <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.metric_cls <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:  <span class="hljs-comment"># 使用 f1 作为最优模型指标</span><br>                <span class="hljs-comment"># 评估模型性能（如果有验证集和指标类）：</span><br>                recall, precision, hmean = <span class="hljs-variable language_">self</span>._<span class="hljs-built_in">eval</span>(<span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;epoch&#x27;</span>])<br><br>                <span class="hljs-comment"># 记录评估指标到 TensorBoard（如果启用）：</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.tensorboard_enable:<br>                    <span class="hljs-variable language_">self</span>.writer.add_scalar(<span class="hljs-string">&#x27;EVAL/recall&#x27;</span>, recall, <span class="hljs-variable language_">self</span>.global_step)<br>                    <span class="hljs-variable language_">self</span>.writer.add_scalar(<span class="hljs-string">&#x27;EVAL/precision&#x27;</span>, precision, <span class="hljs-variable language_">self</span>.global_step)<br>                    <span class="hljs-variable language_">self</span>.writer.add_scalar(<span class="hljs-string">&#x27;EVAL/hmean&#x27;</span>, hmean, <span class="hljs-variable language_">self</span>.global_step)<br>                <span class="hljs-variable language_">self</span>.logger_info(<span class="hljs-string">&#x27;test: recall: &#123;:.6f&#125;, precision: &#123;:.6f&#125;, f1: &#123;:.6f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(recall, precision, hmean))<br><br>                <span class="hljs-comment"># 根据 F1 分数或训练损失判断是否保存最佳模型：</span><br>                <span class="hljs-keyword">if</span> hmean &gt;= <span class="hljs-variable language_">self</span>.metrics[<span class="hljs-string">&#x27;hmean&#x27;</span>]:<br>                    save_best = <span class="hljs-literal">True</span><br>                    <span class="hljs-variable language_">self</span>.metrics[<span class="hljs-string">&#x27;train_loss&#x27;</span>] = <span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;train_loss&#x27;</span>]<br>                    <span class="hljs-variable language_">self</span>.metrics[<span class="hljs-string">&#x27;hmean&#x27;</span>] = hmean<br>                    <span class="hljs-variable language_">self</span>.metrics[<span class="hljs-string">&#x27;precision&#x27;</span>] = precision<br>                    <span class="hljs-variable language_">self</span>.metrics[<span class="hljs-string">&#x27;recall&#x27;</span>] = recall<br>                    <span class="hljs-variable language_">self</span>.metrics[<span class="hljs-string">&#x27;best_model_epoch&#x27;</span>] = <span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;epoch&#x27;</span>]<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;train_loss&#x27;</span>] &lt;= <span class="hljs-variable language_">self</span>.metrics[<span class="hljs-string">&#x27;train_loss&#x27;</span>]:<br>                    save_best = <span class="hljs-literal">True</span><br>                    <span class="hljs-variable language_">self</span>.metrics[<span class="hljs-string">&#x27;train_loss&#x27;</span>] = <span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;train_loss&#x27;</span>]<br>                    <span class="hljs-variable language_">self</span>.metrics[<span class="hljs-string">&#x27;best_model_epoch&#x27;</span>] = <span class="hljs-variable language_">self</span>.epoch_result[<span class="hljs-string">&#x27;epoch&#x27;</span>]<br>            <span class="hljs-comment"># 记录最佳模型的信息并保存最佳模型：</span><br>            best_str = <span class="hljs-string">&#x27;current best, &#x27;</span><br>            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.metrics.items():<br>                best_str += <span class="hljs-string">&#x27;&#123;&#125;: &#123;:.6f&#125;, &#x27;</span>.<span class="hljs-built_in">format</span>(k, v)<br>            <span class="hljs-variable language_">self</span>.logger_info(best_str)<br>            <span class="hljs-keyword">if</span> save_best:<br>                <span class="hljs-keyword">import</span> shutil<br>                shutil.copy(net_save_path, net_save_path_best)<br>                <span class="hljs-variable language_">self</span>.logger_info(<span class="hljs-string">&quot;Saving current best: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(net_save_path_best))<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-variable language_">self</span>.logger_info(<span class="hljs-string">&quot;Saving checkpoint: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(net_save_path))<br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_on_train_finish</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 这个方法在训练完成时执行，执行以下操作：</span><br>        <span class="hljs-comment"># 记录所有指标信息：</span><br>        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.metrics.items():<br>            <span class="hljs-variable language_">self</span>.logger_info(<span class="hljs-string">&#x27;&#123;&#125;:&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(k, v))<br>        <span class="hljs-comment"># 记录训练完成的信息：</span><br>        <span class="hljs-variable language_">self</span>.logger_info(<span class="hljs-string">&#x27;finish train&#x27;</span>)<br></code></pre></td></tr></table></figure></div></div></div>
<p>​    <strong>SynthText</strong> 是一个由 800k 张图像组成的合成数据集。这些图像是从 8k 个背景图像合成的。此数据集仅用于预训练我们的模型。</p>
<p>​    训练数据的数据扩充包括：</p>
<ol>
<li>角度范围为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mo>−</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>∘</mo></mrow></msup><mo separator="true">,</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>∘</mo></mrow></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">(-10^{\circ},10^{\circ})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">(</span><span class="mord">−</span><span class="mord mathrm">1</span><span class="mord"><span class="mord mathrm">0</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">∘</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="mord mathrm">1</span><span class="mord"><span class="mord mathrm">0</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">∘</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span> 的随机旋转</li>
<li>随机裁剪</li>
<li>随机翻转</li>
<li>为了提高训练效率，所有处理后的图像都被重新调整为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>6</mn><mn>4</mn><mn>0</mn><mo>×</mo><mn>6</mn><mn>4</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">640\times 640</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">6</span><span class="mord mathrm">4</span><span class="mord mathrm">0</span><span class="mbin">×</span><span class="mord mathrm">6</span><span class="mord mathrm">4</span><span class="mord mathrm">0</span></span></span></span></li>
</ol>
<hr>
<ul>
<li>使用 SynthText 数据集对它们进行 100k 次迭代的<strong>预训练</strong>。</li>
<li>在 <strong>1200</strong> 个 epoch 的相应真实世界数据集上<strong>微调</strong>模型。
<ul>
<li>训练批次大小设置为 16。我们遵循多学习率策略，当前迭代的学习率等于初始学习率乘以 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mfrac><mrow><mi>i</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mfrac><msup><mo>)</mo><mrow><mi>p</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi></mrow></msup></mrow><annotation encoding="application/x-tex">(1-\frac{iter}{max\_iter})^{power}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.855664em;"></span><span class="strut bottom" style="height:1.4176639999999998em;vertical-align:-0.5619999999999999em;"></span><span class="base textstyle uncramped"><span class="mopen">(</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit">x</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit">i</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit">i</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.02778em;">r</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.02778em;">r</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>
<ul>
<li>初始学习率设置为 0.007，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">power</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.02778em;">r</span></span></span></span> 为 0.9</li>
<li>使用 0.0001 的权重衰减和 0.9 的<strong>动量</strong>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="ablation-study" tabindex="-1" id="Ablation-study">Ablation study</h3>
<p>​    证明各个模块都能提高性能。</p>
<h3 id="comparisons-with-previous-methods" tabindex="-1" id="Comparisons-with-previous-methods">Comparisons with previous methods</h3>
<p>​    P、R、F 三个指标都最佳。</p>
<ul>
<li>TP: true positive。实际为正，预测为正。</li>
<li>FP: false positive。实际为负，预测为正。</li>
<li>TN: true negative。实际为负，预测为负。</li>
<li>FN: false negative。实际为正，预测为负。</li>
</ul>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>P</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">P=\frac{TP}{TP+FP}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.36033em;"></span><span class="strut bottom" style="height:2.1296600000000003em;vertical-align:-0.7693300000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="mord mathit" style="margin-right:0.13889em;">P</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.13889em;">P</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>N</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">R=\frac{TP}{TP+FN}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.36033em;"></span><span class="strut bottom" style="height:2.1296600000000003em;vertical-align:-0.7693300000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="mord mathit" style="margin-right:0.10903em;">N</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.13889em;">P</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>F</mi><mo>=</mo><mfrac><mrow><mn>2</mn><mi>P</mi><mi>R</mi></mrow><mrow><mi>P</mi><mo>+</mo><mi>R</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">F=\frac{2PR}{P+R}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.36033em;"></span><span class="strut bottom" style="height:2.1296600000000003em;vertical-align:-0.7693300000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.00773em;">R</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">2</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mord mathit" style="margin-right:0.00773em;">R</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<hr>
<p>在 TotalText 下的训练结果：</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>P</th>
<th>R</th>
<th>F</th>
</tr>
</thead>
<tbody>
<tr>
<td>DB-ResNet-18 (800)</td>
<td><strong>88.3</strong></td>
<td>77.9</td>
<td>82.8</td>
</tr>
<tr>
<td>DB-ResNet-50 (800)</td>
<td>87.1</td>
<td><strong>82.5</strong></td>
<td><strong>84.7</strong></td>
</tr>
</tbody>
</table>
<p>在 CTW1500 下的训练结果：</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>P</th>
<th>R</th>
<th>F</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ours-ResNet18 (1024)</td>
<td>84.8</td>
<td>77.5</td>
<td>81.0</td>
</tr>
<tr>
<td>Ours-ResNet50 (1024)</td>
<td><strong>86.9</strong></td>
<td>80.2</td>
<td><strong>83.4</strong></td>
</tr>
</tbody>
</table>
<h3 id="limitation" tabindex="-1" id="Limitation">Limitation</h3>
<p>​    我们的方法的一个局限性是它不能处理 “文本中的文本” 的情况，这意味着一个文本实例在另一个文本例子中。尽管收缩的文本区域在文本实例不在另一个文本实例的中心区域的情况下很有帮助，但当文本实例正好位于另一个文字实例的中心区时，它会失败。这是基于分割的场景文本检测器的常见限制。</p>
<h3 id="conclusion" tabindex="-1" id="Conclusion">Conclusion</h3>
<p>​    好使。</p>

            </article>
            
	<div class="rightside">
	
		<div class="rightside-button" id="js-aside">
			<span>
				<img no-lazy src="/images/icon/aside.png" class="rightside-button-icon" alt="Icon">
			</span>
		</div>
		<script>
			$("#js-aside").click(function () {
				onShowAsideButton();
			});
		</script>
	
	<div class="rightside-button" id="js-toggle_theme">
		<span>
			<img no-lazy src="/images/icon/toggle_theme.png" class="rightside-button-icon" alt="Icon">
		</span>
	</div>

	
<script src="/js/plugins/goto_position.js"></script>

	
	<div class="rightside-button" id="js-go_top">
		<span>
			<img no-lazy src="/images/icon/go_top.png" class="rightside-button-icon" alt="Icon">
		</span>
	</div>
	<div class="rightside-button" id="js-go_bottom">
		<span>
			<img no-lazy src="/images/icon/go_bottom.png" class="rightside-button-icon" alt="Icon">
		</span>
	</div>

	<script>
		setToggleThemeButtonListener();
	</script>
	<script>
		$('#js-go_top')
		.gotoPosition( {
			speed: 300,
			target: 'top',
		} );
		$('#js-go_bottom')
		.gotoPosition( {
			speed: 300,
			target: 'bottom',
		} );
	</script>
</div>


<div class="post-bottom">
    
        <div class="post-paging">     
            <div class="post-paging-last">
                
                    <a href="/posts/Paper-Detecting%20Curve%20Text%20in%20the%20Wild-New%20Dataset%20and%20New%20Solution/">
                        上一篇：Paper-Detecting Curve Text in the Wild-New Dataset and New Solution
                    </a>
                
            </div>
            <div class="post-paging-next">
                
                    <a href="/posts/Server-MindOCR/">
                        下一篇：Server-MindOCR
                    </a>
                
            </div>
        </div>
    
    
    
        
            <div class="giscus comments"></div>
            <script>
                var scriptElement = document.createElement('script');
                scriptElement.src = 'https://giscus.app/client.js';
                scriptElement.setAttribute('data-repo', 'GZ-Metal-Cell/GZ-Metal-Cell.github.io');
                scriptElement.setAttribute('data-repo-id', 'R_kgDOIHLEOQ');
                scriptElement.setAttribute('data-category', 'Announcements');
                scriptElement.setAttribute('data-category-id', 'DIC_kwDOIHLEOc4CcVwP');
                scriptElement.setAttribute('data-mapping', 'title');
                scriptElement.setAttribute('data-strict', '1');
                scriptElement.setAttribute('data-reactions-enabled', '');
                scriptElement.setAttribute('data-emit-metadata', '0');
                scriptElement.setAttribute('data-input-position', 'bottom');
                scriptElement.setAttribute('data-theme', localStorage.getItem('theme') === 'light' ? 'light' : 'dark_high_contrast');
                scriptElement.setAttribute('data-lang', 'zh-CN');
                
                scriptElement.setAttribute('crossorigin', 'anonymous');
                scriptElement.async = true;
                document.head.appendChild(scriptElement);
            </script>
        
    
</div>
        </div>
    </main>
    
        <aside class="main-aside">
    
<script src="/js/widgets/aside.js"></script>

    <script>
        showAside();
    </script>

    <div class="aside-top">
        <div class="aside-top-about aside-card">
            <a href="/about" class="aside-top-about-portrait">
                <img no-lazy src="/about/portrait.png" alt="Q">
            </a>
            <div class="aside-top-about-info">
                <span class="author"> Zi-Zi</span>
                <span class="description">不以物喜，不以己悲。</span>
            </div>              
            <div class="aside-top-about-site">
                <a href="/categories" class="aside-top-about-site-item">
                    <span class="title">类别</span>
                    <span class="count">5</span>
                </a>
                <a href="/tags" class="aside-top-about-site-item">
                    <span class="title">标签</span>
                    <span class="count">122</span>
                </a>
                <a href="/archives" class="aside-top-about-site-item">
                    <span class="title">归档</span>
                    <span class="count">438</span>
                </a>
            </div>
            <div class="aside-top-about-contact">
                
                    
                        <a target="_blank" rel="noopener" href="https://weibo.com/u/5020307235">
                            <img no-lazy src="/images/bottom_icon/Weibo.webp" alt="Quieter">
                        </a>
                    
                        <a target="_blank" rel="noopener" href="https://tieba.baidu.com/home/main?id=tb.1.ff6d2775.vFH7wrdW2ZjPCmyBHJcjnA">
                            <img no-lazy src="/images/bottom_icon/Tieba.webp" alt="Quieter">
                        </a>
                    
                        <a target="_blank" rel="noopener" href="https://space.bilibili.com/11547880">
                            <img no-lazy src="/images/bottom_icon/Bilibili.webp" alt="Quieter">
                        </a>
                    
                        <a target="_blank" rel="noopener" href="https://github.com/GZ-Metal-Cell">
                            <img no-lazy src="/images/bottom_icon/github.webp" alt="Quieter">
                        </a>
                    
                
            </div>
        </div> 

        
    </div>

    <div class="aside-bottom">
        
            <script>
                
                    const tocCollapsed = true;
                
                
                    const tocDepth = 6;
                
                var headerString = '';
                for (let i = 1; i <= tocDepth; i++) {
                    if (i === 1) {
                        headerString += 'h1';
                    } else {
                        headerString += ', h' + i;
                    }
                }
                hbeToc();
            </script>
            <div class="aside-bottom-toc aside-card">
                <div class="aside-bottom-toc-title">
                    <h1>目录</h1>
                    <span class="toc-percentage"></span>
                </div>
                <ol class="aside-bottom-toc-content"></ol>
            </div>
        
    </div>
</aside>
    
</div>
		<footer>
	<div class="content">
		
			<span>©2022-2025&nbsp;By&nbsp;<a href="/about">Zi-Zi</a>.</span>
		
		<span><a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> theme by <a target="_blank" rel="noopener" href="https://github.com/GZ-Metal-Cell/hexo-theme-quieter">Quieter</a>.</span>
		
			<span style="display: flex;">
				<img no-lazy alt="icp" src="/images/icp_icon.png" style="width: 16px; height: 16px;">
				<a href="https://icp.gov.moe/?keyword=20241647" target="_blank">萌 ICP 备 20241647 号</a>
			</span>
		
	</div>

	
<script src="/js/plugins/ref.js"></script>

	
<script src="/js/plugins/highlight_tools.js"></script>

	<script>
		const  COPY_ICON = "/images/icon/copy.png";
		const CLOSE_CODE_BLOCK_ICON = "/images/icon/close_code_block.png";
		const HIGHLIGHT_SHRINK = "";
		const HIGHLIGHT_HEIGHT_LIMIT = "";
	</script>

	
	
	<!-- Analytics -->

    
        <!-- Busuanzi Analytics -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
        <!-- Baidu Analytics -->
        <script defer>
            var _hmt = _hmt || [];
            (function () {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?e57cf62289f84322ebff116e8b3d343e";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
    


	

	
		
			
				<link rel="stylesheet" href="/css/plugins/katex/katex.min.css">
				<script src="/js/plugins/copy-tex.js"></script>
			
		
	

    
		
<link rel="stylesheet" href="/css/plugins/textIndent.css">

		
<script src="/js/plugins/textIndent.js"></script>

	

	
	
	
		<script>
			if (typeof init === 'function') {
				init();
			}
		</script>
	

	
		
	

	

	<!--
		
<script src="/js/plugins/jquery.pjax.min.js"></script>

		<script>
			$(document).pjax('a[target!=_blank]', 'main', {
				fragment: 'main',
				timeout: 8000
			});

			$(document).on('pjax:complete', function() {
			});
		</script> 
	-->
	<script>
		console.log('\n %c Hexo-Quieter 主题 %c https://github.com/GZ-Metal-Cell/hexo-theme-quieter \n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;')
	</script>
</footer>
	</body>

	<!-- Hexo-Quieter 主题  https://github.com/GZ-Metal-Cell/hexo-theme-quieter -->
</html>

