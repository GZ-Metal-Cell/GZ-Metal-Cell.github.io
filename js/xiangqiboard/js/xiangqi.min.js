/* @license
 * Copyright (c) 2019-2023, lengyanyu258 (lengyanyu258@outlook.com)
 * Released under the BSD-2-Clause license
 * https://github.com/lengyanyu258/xiangqi.js/blob/master/LICENSE
 */
"use strict";const Xiangqi=function(e){const n="b",t="r",r=-1,i="p",o="c",u="r",s="n",l="b",f="a",c="k",a="pcrnbakPCRNBAK",p="rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR r - - 0 1",h=Object.freeze(["1-0","0-1","1/2-1/2","*"]),d=Object.freeze({b:[16,-1,1],r:[-16,-1,1]}),g=Object.freeze({c:[-16,16,-1,1],r:[-16,16,-1,1],n:[-33,-31,31,33,-18,14,-14,18],b:[-34,34,30,-30],a:[-17,17,15,-15],k:[-16,16,-1,1]}),b=Object.freeze({NORMAL:"n",CAPTURE:"c"}),m=Object.freeze({NORMAL:1,CAPTURE:2}),y=Object.freeze({a9:0,b9:1,c9:2,d9:3,e9:4,f9:5,g9:6,h9:7,i9:8,a8:16,b8:17,c8:18,d8:19,e8:20,f8:21,g8:22,h8:23,i8:24,a7:32,b7:33,c7:34,d7:35,e7:36,f7:37,g7:38,h7:39,i7:40,a6:48,b6:49,c6:50,d6:51,e6:52,f6:53,g6:54,h6:55,i6:56,a5:64,b5:65,c5:66,d5:67,e5:68,f5:69,g5:70,h5:71,i5:72,a4:80,b4:81,c4:82,d4:83,e4:84,f4:85,g4:86,h4:87,i4:88,a3:96,b3:97,c3:98,d3:99,e3:100,f3:101,g3:102,h3:103,i3:104,a2:112,b2:113,c2:114,d2:115,e2:116,f2:117,g2:118,h2:119,i2:120,a1:128,b1:129,c1:130,d1:131,e1:132,f1:133,g1:134,h1:135,i1:136,a0:144,b0:145,c0:146,d0:147,e0:148,f0:149,g0:150,h0:151,i0:152});let v=new Array(256),q={r:r,b:r},A=t,w=0,k=1,N=[],R=[],_={};function O(e){void 0===e&&(e=!1),v=new Array(256),q={r:r,b:r},A=t,w=0,k=1,N=[],R=[],e||(_={}),I(E())}function P(){C(p)}function C(e,r){if(void 0===r&&(r=!1),!j(e).valid)return!1;let i,o,u=e.split(/\s+/),s=u[0],l=0;O(r);for(let e=0;e<s.length;++e)i=s.charAt(e),"/"===i?l+=7:-1!=="0123456789".indexOf(i)?l+=parseInt(i,10):(o=i<"a"?t:n,$({type:i.toLowerCase(),color:o},J(l)),l++);return A=u[1],w=parseInt(u[4],10),k=parseInt(u[5],10),I(E()),!0}function j(e){const r={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) should be '-'.",5:"3rd field (castling availability) should be '-'.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 10 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large].",11:"1st field (piece positions) is invalid [each side has one king].",12:"1st field (piece positions) is invalid [each side has no more than 2 advisers].",13:"1st field (piece positions) is invalid [each side has no more than 2 bishops].",14:"1st field (piece positions) is invalid [each side has no more than 2 knights].",15:"1st field (piece positions) is invalid [each side has no more than 2 rooks].",16:"1st field (piece positions) is invalid [each side has no more than 2 cannons].",17:"1st field (piece positions) is invalid [each side has no more than 5 pawns].",18:"1st field (piece positions) is invalid [black king should at right position].",19:"1st field (piece positions) is invalid [red king should at right position].",20:"1st field (piece positions) is invalid [black adviser should at right position].",21:"1st field (piece positions) is invalid [red adviser should at right position].",22:"1st field (piece positions) is invalid [black bishop should at right position].",23:"1st field (piece positions) is invalid [red bishop should at right position].",24:"1st field (piece positions) is invalid [black pawn should at right position].",25:"1st field (piece positions) is invalid [red pawn should at right position]."};function o(e){return{valid:0===e,error_number:e,error:r[e]}}const u=e.split(/\s+/);if(6!==u.length)return o(1);if(isNaN(u[5])||parseInt(u[5],10)<=0)return o(2);if(isNaN(u[4])||parseInt(u[4],10)<0)return o(3);if(!/^-$/.test(u[3]))return o(4);if(!/^-$/.test(u[2]))return o(5);if(!/^([rb])$/.test(u[1]))return o(6);const s=u[0].split("/");if(10!==s.length)return o(7);const a={p:{number:0,squares:[]},P:{number:0,squares:[]},c:{number:0,squares:[]},C:{number:0,squares:[]},r:{number:0,squares:[]},R:{number:0,squares:[]},n:{number:0,squares:[]},N:{number:0,squares:[]},b:{number:0,squares:[]},B:{number:0,squares:[]},a:{number:0,squares:[]},A:{number:0,squares:[]},k:{number:0,squares:[]},K:{number:0,squares:[]}};let p,h,d,g;for(p=0;p<s.length;p++){for(d=0,g=!1,h=0;h<s[p].length;h++)if(isNaN(s[p][h])){try{++a[s[p][h]].number}catch(e){return o(9)}a[s[p][h]].squares.push(p<<4|d),d+=1,g=!1}else{if(g)return o(8);d+=parseInt(s[p][h],10),g=!0}if(9!==d)return o(10)}if(1!==a.k.number||1!==a.K.number)return o(11);if(a.a.number>2||a.A.number>2)return o(12);if(a.b.number>2||a.B.number>2)return o(13);if(a.n.number>2||a.N.number>2)return o(14);if(a.r.number>2||a.R.number>2)return o(15);if(a.c.number>2||a.C.number>2)return o(16);if(a.p.number>5||a.P.number>5)return o(17);if(te(c,a.k.squares[0],n))return o(18);if(te(c,a.K.squares[0],t))return o(19);for(p=0;p<a.a.squares.length;++p)if(te(f,a.a.squares[p],n))return o(20);for(p=0;p<a.A.squares.length;++p)if(te(f,a.A.squares[p],t))return o(21);for(p=0;p<a.b.squares.length;++p)if(te(l,a.b.squares[p],n))return o(22);for(p=0;p<a.B.squares.length;++p)if(te(l,a.B.squares[p],t))return o(23);for(p=0;p<a.p.squares.length;++p)if(te(i,a.p.squares[p],n))return o(24);for(p=0;p<a.P.squares.length;++p)if(te(i,a.P.squares[p],t))return o(25);return o(0)}function E(){let e,n,r=0,i="";for(let o=y.a9;o<=y.i0;++o)null==v[o]?r++:(r>0&&(i+=r,r=0),e=v[o].color,n=v[o].type,i+=e===t?n.toUpperCase():n.toLowerCase()),W(o)>=8&&(r>0&&(i+=r),o!==y.i0&&(i+="/"),r=0,o+=7);return[i,A,"-","-",w,k].join(" ")}function x(e){for(let n=0;n<e.length;n+=2)"string"==typeof e[n]&&"string"==typeof e[n+1]&&(_[e[n]]=e[n+1]);return _}function I(e){N.length>0||(e!==p?_.FEN=e:delete _.FEN)}function L(e){const n=v[y[e]];return n?{type:n.type,color:n.color}:null}function $(e,n){if(!("type"in e)||!("color"in e))return!1;if(-1===a.indexOf(e.type.toLowerCase()))return!1;if(!(n in y))return!1;const t=y[n];return(e.type!==c||q[e.color]===r||q[e.color]===t)&&(!te(e.type,t,e.color)&&(v[t]={type:e.type,color:e.color},e.type===c&&(q[e.color]=t),I(E()),!0))}function B(e){function n(e,n,t,r,i){n.push(function(e,n,t,r){let i={color:A,from:n,to:t,flags:r,piece:e[n].type};return e[t]&&(i.captured=e[t].type),i}(e,t,r,i))}let t=[],r=A,a=Y(r),p=y.a9,h=y.i0;const b=void 0===e||!("legal"in e)||e.legal,q=void 0!==e&&"opponent"in e&&e.opponent;if(void 0!==e&&"square"in e){if(!(e.square in y))return[];p=h=y[e.square]}let w,k,N,R,_,O,P,C;for(q&&(A=Y(A),r=A,a=Y(r)),w=p;w<=h;++w)if(R=v[w],null!=R&&R.color===r){for(_=R.type===i?d[r]:g[R.type],k=0,N=_.length;k<N&&(!(R.type===i&&k>0)||ee(w,r));++k)for(O=_[k],P=w,C=!1;!(P+=O,ne(P)||R.type===s&&re(w,k)||R.type===l&&(ie(w,k)||ee(P,r))||(R.type===f||R.type===c)&&te(R.type,P,r));){if(null==v[P]){if(R.type===o&&C)continue;n(v,t,w,P,m.NORMAL)}else{if(R.type!==o){v[P].color===a&&n(v,t,w,P,m.CAPTURE);break}if(C){v[P].color===a&&n(v,t,w,P,m.CAPTURE);break}C=!0}if(R.type!==o&&R.type!==u)break}W(w)>=8&&(w+=7)}if(!b)return t;let j=[];for(w=0,N=t.length;w<N;w++)Z(t[w]),z(r)||j.push(t[w]),H();return q&&(A=Y(A)),j}function K(e,n){let t="";return t=J(e.from)+J(e.to),t}function U(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function z(e){let n,t,r,l=q[e],f=Y(e);for(n=0,t=g[s].length;n<t;++n)if(r=l+g[s][n],null!=v[r]&&!ne(r)&&v[r].color===f&&v[r].type===s&&!re(r,n<4?3-n:11-n))return!0;for(n=0,t=g[u].length;n<t;++n){let e=g[u][n],t=!1;for(r=l+e;!ne(r);r+=e){let e=v[r];if(null!=e){if(e.color===f)if(t){if(e.type===o)return!0}else if(e.type===u||e.type===c)return!0;if(t)break;t=!0}}}for(n=0,t=d[f].length;n<t;++n)if(r=l-d[f][n],null!=v[r]&&!ne(r)&&v[r].color===f&&v[r].type===i)return!0;return!1}function T(){return z(A)}function F(){return T()&&0===B().length}function S(){return!T()&&0===B().length}function M(){let e,n={},t=0;for(let r in y)y.hasOwnProperty(r)&&(e=v[y[r]],e&&(n[e.type]=e.type in n?n[e.type]+1:1,t++));return 2===t||void 0===n[s]&&void 0===n[u]&&void 0===n[o]&&void 0===n[i]}function X(){let e,n=[],t={},r=!1;for(;e=H(),e;)n.push(e);for(;;){let e=E().split(" ").slice(0,2).join(" ");if(t[e]=e in t?t[e]+1:1,t[e]>=3&&(r=!0),!n.length)break;Z(n.pop())}return r}function G(e,n){e.push({move:n,kings:{b:q.b,r:q.r},turn:A,half_moves:w,move_number:k})}function Z(e){G(N,e),null!=v[e.to]&&v[e.to].type===c&&(q[v[e.to].color]=r),v[e.to]=v[e.from],v[e.from]=null,v[e.to].type===c&&(q[v[e.to].color]=e.to),e.flags&m.CAPTURE?w=0:w++,A===n&&k++,A=Y(A)}function D(e,n=!0){if(null==e)return null;const t=e.move;return q=e.kings,A=e.turn,w=e.half_moves,k=e.move_number,v[t.from]=v[t.to],v[t.from].type=t.piece,v[t.to]=null,(t.flags&m.CAPTURE)>0&&n&&(v[t.to]={type:t.captured,color:Y(A)}),t}function H(){return D(N.pop())}function Q(e,n){let t,r,i,o=U(e),u=o.match(/([a-iA-I][0-9])-?([a-iA-I][0-9])/);n&&u&&(t=u[1],r=u[2],i=u[3]);let s=B();for(let e=0,l=s.length;e<l;e++){if(o===U(K(s[e]))||n&&o===U(K(s[e])))return s[e];if(u&&(!t||t.toLowerCase()===s[e].piece)&&y[r]===s[e].from&&y[i]===s[e].to)return s[e]}return null}function V(e){return e>>4}function W(e){return 15&e}function J(e){const n=W(e),t=V(e);return"abcdefghi".substring(n,n+1)+"9876543210".substring(t,t+1)}function Y(e){return e===t?n:t}function ee(e,n){return n===t?V(e)<5:V(e)>4}function ne(e){return e<0||V(e)>9||W(e)>8}function te(e,r,o){let u={};if(e===i)return u=[0,2,4,6,8],o===t?V(r)>6||V(r)>4&&-1===u.indexOf(W(r)):V(r)<3||V(r)<5&&-1===u.indexOf(W(r));if(e===l)u[t]=[146,150,112,116,120,82,86],u[n]=[2,6,32,36,40,66,70];else if(e===f)u[t]=[147,149,132,115,117],u[n]=[3,5,20,35,37];else{if(e!==c)return ne(r);u[t]=[147,148,149,131,132,133,115,116,117],u[n]=[3,4,5,19,20,21,35,36,37]}return-1===u[o].indexOf(r)}function re(e,n){return null!=v[e+[-16,16,-1,1][Math.floor(n/2)]]}function ie(e,n){return null!=v[e+[-17,17,15,-15][n]]}function oe(e){let n=ue(e);n.iccs=K(n),n.to=J(n.to),n.from=J(n.from);let t="";for(let e in m)(m[e]&n.flags)>0&&(t+=b[e]);return n.flags=t,n}function ue(e){let n=e instanceof Array?[]:{};for(let t in e)n[t]="object"==typeof t?ue(e[t]):e[t];return n}function se(e){return e.replace(/^\s+|\s+$/g,"")}function le(e){const n=B({legal:!1});let t=0;for(let r=0,i=n.length;r<i;r++){if(Z(n[r]),!z(A))if(e-1>0){t+=le(e-1)}else t++;H()}return t}return C(void 0===e?p:e),{RED:t,BLACK:n,PAWN:i,CANNON:o,ROOK:u,KNIGHT:s,BISHOP:l,ADVISER:f,KING:c,SQUARES:function(){let e=[];for(let n=y.a9;n<=y.i0;n++)9!==W(n)?e.push(J(n)):n+=6;return e}(),FLAGS:b,load:function(e){return C(e)},reset:function(){return P()},moves:function(e){const n=B(e);let t=[];for(let r=0,i=n.length;r<i;r++)void 0!==e&&"verbose"in e&&e.verbose?t.push(oe(n[r])):t.push(K(n[r]));return t},in_check:function(){return T()},in_checkmate:function(){return F()},in_stalemate:function(){return S()},in_draw:function(){return w>=120||X()||M()},insufficient_material:function(){return M()},in_threefold_repetition:function(){return X()},game_over:function(){return w>=120||F()||S()||M()||X()||q[Y(A)]===r},validate_fen:function(e){return j(e)},fen:function(){return E()},board:function(){let e=[],n=[];for(let t=y.a9;t<=y.i0;t++)null==v[t]?n.push(null):n.push({type:v[t].type,color:v[t].color}),8&t&&(e.push(n),n=[],t+=7);return e},pgn:function(e){let n,t="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",r="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,i=[],o=!1;for(n in _)i.push("["+n+' "'+_[n]+'"]'+t),o=!0;o&&N.length&&i.push(t);let u=[];for(;N.length>0;)u.push(H());let s=[],l="";for(;u.length>0;){let e=u.pop();N.length||"b"!==e.color?"b"!==e.color&&(l.length&&s.push(l),l=k+"."):l=k+". ...",l=l+" "+K(e),Z(e)}if(l.length&&s.push(l),void 0!==_.Result&&s.push(_.Result),0===r)return i.join("")+s.join(" ");let f=0;for(n=0;n<s.length;n++)f+s[n].length>r&&0!==n?(" "===i[i.length-1]&&i.pop(),i.push(t),f=0):0!==n&&(i.push(" "),f++),i.push(s[n]),f+=s[n].length;return i.join("")},load_pgn:function(e,n){let t=void 0!==n&&"sloppy"in n&&n.sloppy;function r(e){return e.replace(/\\/g,"\\")}const i="object"==typeof n&&"string"==typeof n.newline_char?n.newline_char:"\r?\n",o=new RegExp("^(?:\\s)*(((?:"+r(i)+")*\\[[^\\]]+\\])+)"),u=o.test(e)?o.exec(e)[1]:"";P();const s=function(e,n){let t="object"==typeof n&&"string"==typeof n.newline_char?n.newline_char:"\r?\n",i={},o=e.split(new RegExp(r(t))),u="",s="";for(let e=0;e<o.length;e++)u=o[e].replace(/^\[([A-Z][A-Za-z]*)\s.*]$/,"$1"),s=o[e].replace(/^\[[A-Za-z]+\s"(.*)"]$/,"$1"),se(u).length>0&&(i[u]=s);return i}(u,n);for(let e in s)s.hasOwnProperty(e)&&x([e,s[e]]);if("FEN"in s&&!C(s.FEN,!0))return!1;let l=e.replace(u,"").replace(new RegExp(r(i),"g")," ");l=l.replace(/({[^}]+})+?/g,"");const f=/(\([^()]+\))+?/g;for(;f.test(l);)l=l.replace(f,"");l=l.replace(/\d+\.(\.\.)?/g,""),l=l.replace(/\.\.\./g,""),l=l.replace(/\$\d+/g,"");let c=se(l).split(new RegExp(/\s+/));c=c.join(",").replace(/,,+/g,",").split(",");let a="";for(let e=0;e<c.length-1;e++){if(a=Q(c[e],t),null==a)return!1;Z(a)}if(a=c[c.length-1],h.indexOf(a)>-1)(function(e){for(let n in e)if(e.hasOwnProperty(n))return!0;return!1})(_)&&void 0===_.Result&&x(["Result",a]);else{if(a=Q(a,t),null==a)return!1;Z(a)}return!0},header:function(){return x(arguments)},ascii:function(){return function(){let e="   +---------------------------+\n";for(let n=y.a9;n<=y.i0;n++){if(0===W(n)&&(e+=" "+"9876543210"[V(n)]+" |"),null==v[n])e+=" . ";else{let r=v[n].type;e+=" "+(v[n].color===t?r.toUpperCase():r.toLowerCase())+" "}8&n&&(e+="|\n",n+=7)}return e+="   +---------------------------+\n",e+="     a  b  c  d  e  f  g  h  i\n",e}()},turn:function(){return A},move:function(e,n){const t=void 0!==n&&"sloppy"in n&&n.sloppy;let r=null;if("string"==typeof e)r=Q(e,t);else if("object"==typeof e){let n=B();for(let t=0,i=n.length;t<i;t++)if(e.from===J(n[t].from)&&e.to===J(n[t].to)&&!(""in n[t])){r=n[t];break}}if(!r)return null;const i=oe(r);return Z(r),R=[],i},undo:function(){G(R,null);const e=H();if(e){const n=oe(e);return[e.from,e.to]=[e.to,e.from],R[R.length-1].move=e,n}return R.pop(),null},redo:function(){G(N,null);const e=D(R.pop(),!1);return e?([e.from,e.to]=[e.to,e.from],N[N.length-1].move=e,oe(e)):(N.pop(),null)},clear:function(){return O()},put:function(e,n){return $(e,n)},get:function(e){return L(e)},remove:function(e){return function(e){const n=L(e);return v[y[e]]=null,n&&n.type===c&&(q[n.color]=r),I(E()),n}(e)},perft:function(e){return le(e)},history:function(e){let n=[],t=[],r=void 0!==e&&"verbose"in e&&e.verbose;for(;N.length>0;)n.push(H());for(;n.length>0;){let e=n.pop();r?t.push(oe(e)):t.push(K(e)),Z(e)}return t}}};"undefined"!=typeof exports&&(exports.Xiangqi=Xiangqi),"undefined"!=typeof define&&define((function(){return Xiangqi}));